<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>连接 Connections</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">概览</a><a href="/node-guidebook//engine">引擎</a><a href="/node-guidebook//system">系统</a><a href="/node-guidebook//network">网络</a><a aria-current="page" class="active" href="/node-guidebook//server-application">服务端应用</a><a href="/node-guidebook//util-application">工具应用</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">概览</a></li><li><a href="/node-guidebook//engine">引擎</a></li><li><a href="/node-guidebook//system">系统</a></li><li><a href="/node-guidebook//network">网络</a></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application">服务端应用</a></li><li><a href="/node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/node-guidebook//server-application/architect">服务端架构设计</a><ul><li><a href="/node-guidebook//server-application/architect"><span>架构设计</span></a></li><li><a href="/node-guidebook//server-application/architect/test"><span>测试设计</span></a></li><li><a href="/node-guidebook//server-application/architect/logger"><span>日志设计</span></a></li><li><a href="/node-guidebook//server-application/architect/gateway"><span>网关设计</span></a></li><li><a href="/node-guidebook//server-application/architect/security"><span>安全设计</span></a></li><li><a href="/node-guidebook//server-application/architect/message-queue"><span>消息队列</span></a></li><li><a href="/node-guidebook//server-application/architect/database"><span>数据库</span></a></li></ul></li><li><a href="/node-guidebook//server-application/message-queue/kalfa">Kalfa</a></li><li><a href="/node-guidebook//server-application/message-queue/rabbitmq">RabbitMQ</a></li><li><a href="/node-guidebook//server-application/message-queue/redis">Redis</a></li><li><a href="/node-guidebook//server-application/server-framework/mysql">MySQL</a></li><li><a href="/node-guidebook//server-application/server-framework/express">Express</a><ul><li><a href="/node-guidebook//server-application/server-framework/express"><span>Express</span></a></li><li><a href="/node-guidebook//server-application/server-framework/express/principle"><span>实现原理</span></a></li></ul></li><li><a href="/node-guidebook//server-application/server-framework/koa">Koa</a><ul><li><a href="/node-guidebook//server-application/server-framework/koa"><span>Koa</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/source-code"><span>源码解析</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-router"><span>koa-router</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-jwt"><span>koa-jwt</span></a></li><li><a href="/node-guidebook//server-application/server-framework/koa/koa-helmet"><span>koa-helmet</span></a></li></ul></li><li><a href="/node-guidebook//server-application/server-framework/egg">Egg</a><ul><li><a href="/node-guidebook//server-application/server-framework/egg"><span>Egg</span></a></li><li><a href="/node-guidebook//server-application/server-framework/egg/architect"><span>框架架构</span></a></li><li><a href="/node-guidebook//server-application/server-framework/egg/core-feature"><span>核心功能</span></a></li></ul></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application/server-framework/mongodb">MongoDB</a><ul><li><a href="/node-guidebook//server-application/server-framework/mongodb/mongodb"><span>MongoDB</span></a></li><li><a href="/node-guidebook//server-application/server-framework/mongodb/basic-usage"><span>常用方法</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//server-application/server-framework/mongodb/connections"><span>连接 Connections</span></a></li></ul></li><li><a href="/node-guidebook//server-application/database/mongodb">Database/mongodb</a><ul><li><a href="/node-guidebook//server-application/database/mongodb/aggregate"><span>聚合</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/documents"><span>文档 Documents</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/hooks"><span>钩子函数</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/middleware"><span>中间件 Middleware</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/model-api"><span>Model API</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/models"><span>模型 Models</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/plugins"><span>插件 Plugins</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/populate"><span>填充 Populate</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/queries"><span>查询 Queries</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/schema-types"><span>模式类型 SchemaTypes</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/schemas"><span>模式 Schema</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/subdocuments"><span>子文档 Subdocuments</span></a></li><li><a href="/node-guidebook//server-application/database/mongodb/validation"><span>验证 Validation</span></a></li></ul></li><li><a href="/node-guidebook//server-application/pm2">Pm2</a></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="连接数据库 connect" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#连接数据库-connect"><span>连接数据库 connect</span></a></li><li title="操作缓存" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#操作缓存"><span>操作缓存</span></a></li><li title="选项" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#选项"><span>选项</span></a></li><li title="连接字符串选项" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#连接字符串选项"><span>连接字符串选项</span></a></li><li title="副本集连接" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#副本集连接"><span>副本集连接</span></a></li><li title="多 mongos 支持" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#多-mongos-支持"><span>多 mongos 支持</span></a></li><li title="断开连接 disconnect" data-depth="2" class=""><a href="/node-guidebook//server-application/server-framework/mongodb/connections#断开连接-disconnect"><span>断开连接 disconnect</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="连接-connections"><a aria-hidden="true" href="#连接-connections"><span class="icon icon-link"></span></a>连接 Connections</h1><h2 id="连接数据库-connect"><a aria-hidden="true" href="#连接数据库-connect"><span class="icon icon-link"></span></a>连接数据库 connect</h2><p>通过 <code>mongoose.connect()</code> 连接数据库，同时可以通过绑定事件监听器来监听数据库是否连接成功。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 1. 引入数据库驱动
const mongoose = require(&#x27;mongoose&#x27;);

// 2. 建立连接
mongoose.connect(&#x27;mongodb://localhost/myapp&#x27;, { useMongoClient: true });

// 设置回调函数
const db = mongoose.connection;

db.on(&#x27;error&#x27;, console.error.bind(console, &#x27;connection error:&#x27;));

db.on(&#x27;open&#x27;, () =&gt; {
  console.log(&#x27;connected db: myapp&#x27;);
});
" data-status="copy"></button><div class="token-line"><span class="token comment">// 1. 引入数据库驱动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> mongoose </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 2. 建立连接</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://localhost/myapp&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> useMongoClient</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 设置回调函数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> db </span><span class="token operator">=</span><span class="token plain"> mongoose</span><span class="token punctuation">.</span><span class="token property-access">connection</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">db</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain">console</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;connection error:&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">db</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;connected db: myapp&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>你可以在 URI 中指定多个参数：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(&#x27;mongodb://username:password@host:port/database?options&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://username:password@host:port/database?options&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>这是连接到本地 <code>db</code> 数据库默认接口（27017）的最小配置。本地连接失败可以尝试连接 <code>127.0.0.1</code>。</p><p><code>connect()</code> 方法还接受一个选项对象 <code>options</code>，该对象将传递给底层驱动程序。这里所包含的所有选项优先于连接字符串中传递的选项。</p><p><strong>可选项：</strong></p><ul><li><code>db</code>：数据库设置</li><li><code>server</code>：服务器设置</li><li><code>replset</code>：副本集设置</li><li><code>user</code>：用户名</li><li><code>pass</code>：密码</li><li><code>auth</code>：鉴权选项</li><li><code>mongos</code>：连接多个数据库</li></ul><p>对于长期运行的后台应用，启用毫秒级 <code>keepAlive</code> 是精明的操作。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(url, { keepAlive: 120 })
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> keepAlive</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">120</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果连接需要<strong>用户名</strong>和<strong>密码</strong>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 语法
mongoose.connect(&#x27;mongodb://root:password@localhost/myapp&#x27;);

// 例如：连接名为 eggcms 的数据库，账户名 eggadmin，密码123456
mongoose.connect(&#x27;mongodb://eggadmin:123456@localhost:27017/eggcms&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token comment">// 语法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://root:password@localhost/myapp&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 例如：连接名为 eggcms 的数据库，账户名 eggadmin，密码123456</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://eggadmin:123456@localhost:27017/eggcms&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="操作缓存"><a aria-hidden="true" href="#操作缓存"><span class="icon icon-link"></span></a>操作缓存</h2><p>你不必等待连接建立就可以使用你的 Mongoose models。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(&#x27;mongodb://localhost:myapp&#x27;);
const MyModel = mongoose.model(&#x27;Test&#x27;, new Schema({ name: String }));
// 可行
MyModel.findOne(function(err, result) {
  /* ... */
});
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://localhost:myapp&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">MyModel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">model</span><span class="token punctuation">(</span><span class="token string">&#x27;Test&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 可行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">MyModel</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* ... */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Mongoose 会缓存你的 model 操作。这个操作很方便，但也会引起一些疑惑，因为如果你没连上，Mongoose 不会抛错。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const MyModel = mongoose.model(&#x27;Test&#x27;, new Schema({ name: String }));
// 连接成功前操作会被挂起
MyModel.findOne(function(error, result) {
  /* ... */
});

setTimeout(function() {
  mongoose.connect(&#x27;mongodb://localhost/myapp&#x27;);
}, 60000);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">MyModel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">model</span><span class="token punctuation">(</span><span class="token string">&#x27;Test&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 连接成功前操作会被挂起</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">MyModel</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token parameter punctuation">,</span><span class="token parameter"> result</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">/* ... */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://localhost/myapp&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>要禁用缓存，请修改 <code>bufferCommands</code> 配置。如果你打开了 <code>bufferCommands</code> 连接被挂起，尝试关闭 <code>bufferCommands</code> 检查你是否正确打开连接。你也可以全局禁用 <code>bufferCommands</code>：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.set(&#x27;bufferCommands&#x27;, false);
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">&#x27;bufferCommands&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="选项"><a aria-hidden="true" href="#选项"><span class="icon icon-link"></span></a>选项</h2><p><code>connect</code> 方法接受 <code>options</code> 参数，这些参数会传入底层 MongoDB 驱动。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(uri, options);
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token plain">uri</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>重要选项：</p><ul><li><code>autoReconnect</code>：底层 MongoDB 驱动在连接丢失后将自动重连。除非你是可以自己管理连接池的高手，否则不要吧这个选项设为 <code>false</code></li><li><code>poolSize</code>：MongoDB 保持的最大 Socket 连接数。<code>poolSize</code> 的默认值是 5。</li><li><code>bufferMaxEntries</code>：MongoDB 驱动同样有自己的离线时缓存机制。如果你希望链接错误时终止数据库操作，请将此选项设为 0 以及把 <code>bufferCommands</code> 设为 <code>false</code>。</li></ul><h2 id="连接字符串选项"><a aria-hidden="true" href="#连接字符串选项"><span class="icon icon-link"></span></a>连接字符串选项</h2><p>你也可以在连接字符串填写驱动选项，但是这只适用于 MongoDB 驱动使用的选项，所以类似于 <code>bufferCommands</code> 的 Mongoose 专用选项不能在连接字符串使用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(&#x27;mongodb://localhost:27017/test?connectTimeoutMs=1000&amp;bufferCommands=false&#x27;);
// The above is equivalent to:
mongoose.connect(&#x27;mongodb://localhost:27017/test&#x27;, {
  connectTimeoutMS: 1000,
  // Note that mongoose will **not** pull `bufferCommands` from the query string
});
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://localhost:27017/test?connectTimeoutMs=1000&amp;bufferCommands=false&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// The above is equivalent to:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://localhost:27017/test&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  connectTimeoutMS</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Note that mongoose will **not** pull `bufferCommands` from the query string</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>把选项放在连接字符串的劣势是不便与阅读，优势是你只需要写一条连接而不需要把所有设定分开写。最佳实践是把区分<strong>生产环境</strong>和<strong>开发环境</strong>的选项如 <code>socketTimeoutMS</code> 、 <code>connectTimeoutMS</code> 放在 <code>uri</code> ， 把通用的常量如 <code>connectTimeoutMS</code> 、 <code>poolSize</code> 放在选项对象里。</p><h2 id="副本集连接"><a aria-hidden="true" href="#副本集连接"><span class="icon icon-link"></span></a>副本集连接</h2><p>要连接到副本集，你可以用逗号分隔，传入多个地址。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(&#x27;mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]&#x27; [, options]);)
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]&#x27;</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>要连接到单节点副本集，需指定 <code>replicaSet</code> 选项。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="mongoose.connect(&#x27;mongodb://host1:port1/?replicaSet=rsName&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://host1:port1/?replicaSet=rsName&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="多-mongos-支持"><a aria-hidden="true" href="#多-mongos-支持"><span class="icon icon-link"></span></a>多 mongos 支持</h2><p>使用高性能分片集群，需要连接多个 Mongos（MongoDB Shard）实例。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Connect to 2 mongos servers
mongoose.connect(&#x27;mongodb://mongosA:27501,mongosB:27501&#x27;, cb);
" data-status="copy"></button><div class="token-line"><span class="token comment">// Connect to 2 mongos servers</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://mongosA:27501,mongosB:27501&#x27;</span><span class="token punctuation">,</span><span class="token plain"> cb</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="断开连接-disconnect"><a aria-hidden="true" href="#断开连接-disconnect"><span class="icon icon-link"></span></a>断开连接 disconnect</h2><p>使用 <code>disconnect()</code> 方法可以断开连接。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const mongoose = require(&#x27;mongoose&#x27;);

mongoose.connect(&#x27;mongodb://root:password@localhost/blog&#x27;, function(err) {
  if (err) {
    console.log(&#x27;连接失败&#x27;);
  } else {
    console.log(&#x27;连接成功&#x27;);
  }
});

setTimeout(function() {
  mongoose.disconect(function() {
    console.log(&#x27;断开连接&#x27;);
  });
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> mongoose </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">&#x27;mongodb://root:password@localhost/blog&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;连接失败&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;连接成功&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  mongoose</span><span class="token punctuation">.</span><span class="token method function property-access">disconect</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;断开连接&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/server-application/database/mongodb/connections.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__server-application__database__mongodb__connections.md.js"></script>
  </body>
</html>
