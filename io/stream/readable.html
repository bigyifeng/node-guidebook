<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>可读流 | Node-Guidebook</title>
    <meta name="description" content="">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/node-guidebook/assets/css/0.styles.04b4ede2.css" as="style"><link rel="preload" href="/node-guidebook/assets/js/app.b56de1e6.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/2.9a9b2fe1.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/6.21a4b1c5.js" as="script"><link rel="prefetch" href="/node-guidebook/assets/js/10.f31a5cd7.js"><link rel="prefetch" href="/node-guidebook/assets/js/11.9a11099b.js"><link rel="prefetch" href="/node-guidebook/assets/js/12.d192428c.js"><link rel="prefetch" href="/node-guidebook/assets/js/13.3b64565c.js"><link rel="prefetch" href="/node-guidebook/assets/js/14.d5a9b897.js"><link rel="prefetch" href="/node-guidebook/assets/js/15.01e27e34.js"><link rel="prefetch" href="/node-guidebook/assets/js/16.606d1944.js"><link rel="prefetch" href="/node-guidebook/assets/js/17.51b30e3b.js"><link rel="prefetch" href="/node-guidebook/assets/js/18.063b4f41.js"><link rel="prefetch" href="/node-guidebook/assets/js/19.7f27a998.js"><link rel="prefetch" href="/node-guidebook/assets/js/20.c97daf38.js"><link rel="prefetch" href="/node-guidebook/assets/js/21.2e1c632f.js"><link rel="prefetch" href="/node-guidebook/assets/js/22.fbd33fb6.js"><link rel="prefetch" href="/node-guidebook/assets/js/23.b087a4cc.js"><link rel="prefetch" href="/node-guidebook/assets/js/24.9bf9975f.js"><link rel="prefetch" href="/node-guidebook/assets/js/25.833c04e5.js"><link rel="prefetch" href="/node-guidebook/assets/js/26.fa5f5e57.js"><link rel="prefetch" href="/node-guidebook/assets/js/27.e048e63c.js"><link rel="prefetch" href="/node-guidebook/assets/js/28.7389fa33.js"><link rel="prefetch" href="/node-guidebook/assets/js/29.5f7ae828.js"><link rel="prefetch" href="/node-guidebook/assets/js/3.028038f2.js"><link rel="prefetch" href="/node-guidebook/assets/js/30.97c6204d.js"><link rel="prefetch" href="/node-guidebook/assets/js/31.0f2c316e.js"><link rel="prefetch" href="/node-guidebook/assets/js/32.a2d860ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/33.ef37b95b.js"><link rel="prefetch" href="/node-guidebook/assets/js/34.55cdaada.js"><link rel="prefetch" href="/node-guidebook/assets/js/35.7f7e104c.js"><link rel="prefetch" href="/node-guidebook/assets/js/36.89d29ca3.js"><link rel="prefetch" href="/node-guidebook/assets/js/37.13112c94.js"><link rel="prefetch" href="/node-guidebook/assets/js/38.57cfe6d1.js"><link rel="prefetch" href="/node-guidebook/assets/js/39.db4440a8.js"><link rel="prefetch" href="/node-guidebook/assets/js/4.675c3702.js"><link rel="prefetch" href="/node-guidebook/assets/js/40.95563075.js"><link rel="prefetch" href="/node-guidebook/assets/js/41.c737d452.js"><link rel="prefetch" href="/node-guidebook/assets/js/42.77397b50.js"><link rel="prefetch" href="/node-guidebook/assets/js/43.55d50864.js"><link rel="prefetch" href="/node-guidebook/assets/js/44.2ee11d4d.js"><link rel="prefetch" href="/node-guidebook/assets/js/45.cbfb9e4f.js"><link rel="prefetch" href="/node-guidebook/assets/js/46.8c5dee73.js"><link rel="prefetch" href="/node-guidebook/assets/js/47.ed9a119b.js"><link rel="prefetch" href="/node-guidebook/assets/js/48.ace38419.js"><link rel="prefetch" href="/node-guidebook/assets/js/49.e79545ac.js"><link rel="prefetch" href="/node-guidebook/assets/js/5.11ee68c1.js"><link rel="prefetch" href="/node-guidebook/assets/js/50.9fbe2e33.js"><link rel="prefetch" href="/node-guidebook/assets/js/51.4896a061.js"><link rel="prefetch" href="/node-guidebook/assets/js/52.c4ceb1c2.js"><link rel="prefetch" href="/node-guidebook/assets/js/53.8c0fea71.js"><link rel="prefetch" href="/node-guidebook/assets/js/54.c05dccf1.js"><link rel="prefetch" href="/node-guidebook/assets/js/55.b2d65211.js"><link rel="prefetch" href="/node-guidebook/assets/js/56.a43684ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/57.7ba8a6f3.js"><link rel="prefetch" href="/node-guidebook/assets/js/58.f0c2c1ef.js"><link rel="prefetch" href="/node-guidebook/assets/js/59.944bad13.js"><link rel="prefetch" href="/node-guidebook/assets/js/60.e62081dc.js"><link rel="prefetch" href="/node-guidebook/assets/js/61.5e74305b.js"><link rel="prefetch" href="/node-guidebook/assets/js/62.ca1dac6e.js"><link rel="prefetch" href="/node-guidebook/assets/js/63.c03d966c.js"><link rel="prefetch" href="/node-guidebook/assets/js/64.c7411f74.js"><link rel="prefetch" href="/node-guidebook/assets/js/65.23e9fb75.js"><link rel="prefetch" href="/node-guidebook/assets/js/66.4dbed100.js"><link rel="prefetch" href="/node-guidebook/assets/js/67.80de04b2.js"><link rel="prefetch" href="/node-guidebook/assets/js/68.73588625.js"><link rel="prefetch" href="/node-guidebook/assets/js/69.d28f892e.js"><link rel="prefetch" href="/node-guidebook/assets/js/7.62412490.js"><link rel="prefetch" href="/node-guidebook/assets/js/70.a271a34d.js"><link rel="prefetch" href="/node-guidebook/assets/js/71.407abc57.js"><link rel="prefetch" href="/node-guidebook/assets/js/72.67ca9438.js"><link rel="prefetch" href="/node-guidebook/assets/js/73.c95f2cd6.js"><link rel="prefetch" href="/node-guidebook/assets/js/74.95ef83e7.js"><link rel="prefetch" href="/node-guidebook/assets/js/75.a225a743.js"><link rel="prefetch" href="/node-guidebook/assets/js/76.45437d36.js"><link rel="prefetch" href="/node-guidebook/assets/js/77.919cd113.js"><link rel="prefetch" href="/node-guidebook/assets/js/78.447a327e.js"><link rel="prefetch" href="/node-guidebook/assets/js/79.74917783.js"><link rel="prefetch" href="/node-guidebook/assets/js/8.26079951.js"><link rel="prefetch" href="/node-guidebook/assets/js/80.7517c60e.js"><link rel="prefetch" href="/node-guidebook/assets/js/81.4896eb33.js"><link rel="prefetch" href="/node-guidebook/assets/js/82.52db751e.js"><link rel="prefetch" href="/node-guidebook/assets/js/83.108e2ceb.js"><link rel="prefetch" href="/node-guidebook/assets/js/84.c4018c3e.js"><link rel="prefetch" href="/node-guidebook/assets/js/85.95ab55fa.js"><link rel="prefetch" href="/node-guidebook/assets/js/86.01a6e820.js"><link rel="prefetch" href="/node-guidebook/assets/js/87.7748e683.js"><link rel="prefetch" href="/node-guidebook/assets/js/88.730b440e.js"><link rel="prefetch" href="/node-guidebook/assets/js/89.4eca5ebb.js"><link rel="prefetch" href="/node-guidebook/assets/js/9.841d82b7.js"><link rel="prefetch" href="/node-guidebook/assets/js/90.6dc66fef.js"><link rel="prefetch" href="/node-guidebook/assets/js/91.616655e3.js"><link rel="prefetch" href="/node-guidebook/assets/js/92.0e127a47.js"><link rel="prefetch" href="/node-guidebook/assets/js/93.cc651dc5.js"><link rel="prefetch" href="/node-guidebook/assets/js/94.0c069be2.js"><link rel="prefetch" href="/node-guidebook/assets/js/95.28ec5306.js"><link rel="prefetch" href="/node-guidebook/assets/js/96.4680804b.js"><link rel="prefetch" href="/node-guidebook/assets/js/97.04e2deb8.js">
    <link rel="stylesheet" href="/node-guidebook/assets/css/0.styles.04b4ede2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/node-guidebook/" class="home-link router-link-active"><img src="/node-guidebook/favicon.png" alt="Node-Guidebook" class="logo"> <span class="site-name can-hide">Node-Guidebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/module/commonjs.html" class="sidebar-link">CommonJS</a></li><li><a href="/node-guidebook/module/module.html" class="sidebar-link">模块机制</a></li><li><a href="/node-guidebook/module/global.html" class="sidebar-link">全局对象</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>I/O</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/io/io.html" class="sidebar-link">I/O</a></li><li><a href="/node-guidebook/io/stream/stream.html" class="sidebar-link">流</a></li><li><a href="/node-guidebook/io/stream/readable.html" class="active sidebar-link">可读流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#读取模式" class="sidebar-link">读取模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#流动模式" class="sidebar-link">流动模式</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#暂停模式" class="sidebar-link">暂停模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#实现原理" class="sidebar-link">实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#doread" class="sidebar-link">doRead</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#push" class="sidebar-link">push</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#end" class="sidebar-link">end</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#readable" class="sidebar-link">readable</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#实现过程" class="sidebar-link">实现过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#流动模式原理" class="sidebar-link">流动模式原理</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#暂停模式原理" class="sidebar-link">暂停模式原理</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#readable-2" class="sidebar-link">Readable</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#自定义可读流" class="sidebar-link">自定义可读流</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/readable.html#运行全流程" class="sidebar-link">运行全流程</a></li></ul></li><li><a href="/node-guidebook/io/stream/writable.html" class="sidebar-link">可写流</a></li><li><a href="/node-guidebook/io/buffer.html" class="sidebar-link">缓冲器</a></li><li><a href="/node-guidebook/io/filesystem.html" class="sidebar-link">文件系统</a></li><li><a href="/node-guidebook/io/path.html" class="sidebar-link">路径</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/process/process.html" class="sidebar-link">进程</a></li><li><a href="/node-guidebook/process/child-process.html" class="sidebar-link">子进程</a></li><li><a href="/node-guidebook/process/cluster.html" class="sidebar-link">集群</a></li><li><a href="/node-guidebook/process/ipc.html" class="sidebar-link">进程间通信</a></li><li><a href="/node-guidebook/process/daemon.html" class="sidebar-link">守护进程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/network/socket.html" class="sidebar-link">Socket</a></li><li><a href="/node-guidebook/network/dns.html" class="sidebar-link">DNS</a></li><li><a href="/node-guidebook/network/net.html" class="sidebar-link">Net</a></li><li><a href="/node-guidebook/network/dgram.html" class="sidebar-link">Dgram</a></li><li><a href="/node-guidebook/network/http.html" class="sidebar-link">HTTP</a></li><li><a href="/node-guidebook/network/http-server.html" class="sidebar-link">HTTP Server</a></li><li><a href="/node-guidebook/network/http-client-request.html" class="sidebar-link">HTTP ClientRequest</a></li><li><a href="/node-guidebook/network/http-incoming-message.html" class="sidebar-link">HTTP IncomingMessage</a></li><li><a href="/node-guidebook/network/http-server-response.html" class="sidebar-link">HTTP ServerResponse</a></li><li><a href="/node-guidebook/network/https.html" class="sidebar-link">HTTPS</a></li><li><a href="/node-guidebook/network/http2.html" class="sidebar-link">HTTP2</a></li><li><a href="/node-guidebook/network/url.html" class="sidebar-link">URL</a></li><li><a href="/node-guidebook/network/querystring.html" class="sidebar-link">QueryString</a></li><li><a href="/node-guidebook/network/crypto.html" class="sidebar-link">Crypto</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/3m/npm.html" class="sidebar-link">NPM</a></li><li><a href="/node-guidebook/3m/npx.html" class="sidebar-link">NPX</a></li><li><a href="/node-guidebook/3m/nrm.html" class="sidebar-link">NRM</a></li><li><a href="/node-guidebook/3m/nvm.html" class="sidebar-link">NVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>推荐资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/recommend.html" class="sidebar-link">推荐资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="可读流"><a href="#可读流" class="header-anchor">#</a> 可读流</h1> <p>可读流（Readable Streams）是对提供数据的源头（source）的抽象。</p> <p>在 Node.js 中属于可读流的具体实现形式：</p> <ul><li>客户端的 HTTP 响应</li> <li>服务端的 HTTP 请求</li> <li><code>fs</code> 模块的 read streams 读取流</li> <li><code>zlib</code> 压缩流</li> <li><code>crypto</code> 加密流</li> <li>TCP Sockets</li> <li>子进程 stdout 与 stderr 子进程标准输出和错误输出</li> <li>process.stdin 标准输入</li></ul> <p>所有的 Readable 都实现了 <code>stream.Readable</code> 类定义的接口。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Readable <span class="token operator">=</span> stream<span class="token punctuation">.</span>Readable<span class="token punctuation">;</span>
</code></pre></div><p>实现了 <code>stream.Readable</code> 接口的对象，将对象的数据读取为流数据，当监听 <code>data</code> 事件后，开始发射（emit）数据。</p> <p>🌰 <strong>示例：读取文件流创建</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 打开文件要做的操作，默认 'r'</span>
    flags<span class="token operator">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span>
    encoding<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 开始读取的索引位置</span>
    start<span class="token operator">:</span> <span class="token string">'0'</span><span class="token punctuation">,</span>
    <span class="token comment">// 结束读取的索引位置（包括结束位置）</span>
    end<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token comment">// 读取缓存区默认的大小的阀值 64KB（水位线）</span>
    highWaterMark<span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 监听 data 事件，流自动切换到流动模式</span>
<span class="token comment">// 数据会尽可能快地读出</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 数据读取完毕后触发 end 事件</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    consolel<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取完毕'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可读流打开事件</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    consolel<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取完毕'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 可读流关闭事件</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">er</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>；

<span class="token comment">// 指定编码和上面创建流时的参数 encoding 意思相同</span>
rs<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 可读流暂停读取</span>
    rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 可读流恢复读取</span>
    rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="读取模式"><a href="#读取模式" class="header-anchor">#</a> 读取模式</h2> <p>Readable Streams 存在两种模式<strong>流动模式</strong>（flowing mode）和<strong>暂停模式</strong>（paused mode），这两种模式决定了 chunk 数据流动的方式：<strong>自动流动</strong>和<strong>手工流动</strong>。</p> <p>可读流对象 <code>stream.Readable</code> 中有一个维护状态的对象 <code>readable._readableState</code>，这里简称为 <code>state</code>。其中有一个标记，<code>state.flowing</code>，可用来判别流的模式。它有三种可能值：</p> <ul><li><code>true</code> 表示流动模式</li> <li><code>false</code> 表示暂停模式</li> <li><code>null</code> 初始状态</li></ul> <ol><li><strong>流动模式</strong>（flowing mode）：数据自动从系统底层读取，形成<strong>流动</strong>现象，并通过事件，尽可能快地提供给应用程序。监听流的 <code>data</code> 事件便可进入该模式</li> <li><strong>暂停模式</strong>（paused mode）：需要显式地调用 <code>stream.readable.read</code> 方法，触发 <code>data</code> 事件以消耗流数据。</li></ol> <p>那么如何触发或相互转化这两种模式呢：</p> <ul><li><p><strong>可读流都开始于暂停模式</strong></p></li> <li><p><strong>暂停模式切换到流动模式（flowing）</strong></p> <ul><li>监听 <code>data</code> 事件</li> <li>调用 <code>stream.resume</code> 方法</li> <li>调用 <code>stream.pipe</code> 方法将数据发送到 Writable</li></ul></li> <li><p><strong>流动模式切换到暂停模式（paused）</strong></p> <ul><li>移除 <code>data</code> 事件</li> <li>如果没有管道目标，调用 <code>stream.pause</code> 方法</li> <li>如果有管道目标，调用 <code>stream.unpipe</code> 移除多个管道目标，并取消 <code>data</code> 事件监听</li></ul></li></ul> <p>如果 <code>stream.Readable</code> 切换到 flowing 模式，且没有消费者处理流中的数据，这些数据将会丢失。比如，调用了 <code>readable.resume()</code> 方法切没有监听 <code>data</code> 事件，或是取消 <code>data</code> 事件监听，就有可能出现这种情况。</p> <p>可以想象家用热水器的模型，热水器的水箱（Buffer 缓存区）里面存储着热水（数据），在我们用热水的时候，开启水龙头，自来水会不断地进入水箱，再从水箱由水龙头流出来供我们使用。这就是进入了 flowing 模式。当我们关闭水龙头的时候，水箱则会暂停进水，水龙头也会暂停出水，这就是 paused 模式。</p> <p><img src="" alt="流的读取模式的切换方式"></p> <p>默认情况下我们在创建流对象之后它会处于暂停模式。</p> <p>在暂停模式下，我们必须显式调用 <code>stream.readable.read</code> 方法来从流中读取数据片段，而流动模式下数据就会不断地被读出，当然这里要注意的是流动模式下数据并不是直接流向至应用，背后其实还存在一个缓存池，而池的大小是在我们创建读流对象时定义的，每次读取时最多读取的字节数不会超过池的大小，打个比方，如果有 9 个字节要读取，池的大小为 3 字节，那么就会分三次读入，在流动模式下，可以调用 <code>pause</code> 方法回到暂停模式，<code>resume</code> 方法再次回到流动模式。</p> <p>在暂停模式中，我们可以监听 <code>readable</code> 事件，它将会在流有数据可供读取时触发，但是这不是一个自动读取的过程，它需要我们自己去调用 <code>read</code> 方法来读取数据，在监听这个事件时，默认会将缓存区先填满一次，每当缓存区读完时，这个 <code>readable</code> 事件就会再被触发，并且每次调用 <code>read</code> 方法时都会去检测一次缓存区的长度是否小于水口（HighWaterMark）大小，如果小于的话再读取一段水口大小的数据放入缓存区中。另外要注意一点的事有时候我们调用 <code>read</code> 时读取的大小可能会超过缓存区的大小，这个时候默认就会更改缓存区的大小到一个适合现在读取量的大小，然后再重新出发 <code>readable</code> 事件。</p> <h3 id="流动模式"><a href="#流动模式" class="header-anchor">#</a> 流动模式</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

rs<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="暂停模式"><a href="#暂停模式" class="header-anchor">#</a> 暂停模式</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./index.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> res <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'res'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <p>创建可读流时，需要集成 Readable 对象，并实现 <code>_read</code> 方法。</p> <p><img src="/node-guidebook/assets/img/readable-flow.9e6793fd.jpeg" alt="可读流原理"></p> <p><code>_read</code> 方法是从底层系统读取具体数据的逻辑，即生产数据的逻辑。</p> <p>在 <code>_read</code> 方法中，通过调用 <code>push(data)</code> 将数据放入可读流中供下游消耗。在 <code>_read</code> 方法中，可以同步调用 <code>push(data)</code>，也可以异步调用。当全部数据都生产出来后，必须调用 <code>push(null)</code> 来结束可读流。流一旦结束，便不能再调用 <code>push(data)</code> 添加数据。可以通过监听 <code>data</code> 事件的方式消耗可读流。</p> <p>在首次监听其 <code>data</code> 事件后，readable 便会持续不断地调用 <code>_read()</code>，通过触发 <code>data</code> 事件将数据输出。第一次 <code>data</code> 事件会在下一个 tick 中触发，所以，可以安全地将数据输出前的逻辑放在事件监听后（同一个 tick 中）。当数据全部被消耗时，会触发 <code>end</code> 事件。</p> <p><img src="/node-guidebook/assets/img/readable-flow-detail.a4cc48f7.jpeg" alt="可读流详细原理流程图"></p> <p>通过流读取数据</p> <ul><li>使用 Readable 构造函数创建实例对象 readable 后，便得到了一个可读流</li> <li>如果实现 <code>_read</code> 方法，就将流连接到一个底层数据源</li> <li>流通过调用 <code>_read</code> 向底层请求数据，底层再调用流的 <code>push</code> 方法将需要的数据传递过来</li> <li>当 readable 连接了数据源后，下游便可以调用 <code>readable.read(n)</code> 向流请求数据，同时监听 readable 的 <code>data</code> 事件来接收取到的数据</li></ul> <h3 id="doread"><a href="#doread" class="header-anchor">#</a> doRead</h3> <p>流中维护了一个缓存，当缓存中的数据足够多时，调用 <code>read()</code> 不会引起 <code>_read()</code> 的调用，即不需要向底层请求数据。用 <code>doRead</code> 来表示 <code>read(n)</code> 是否需要向底层取数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> doRead <span class="token operator">=</span> state<span class="token punctuation">.</span>needReadable<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">||</span> state<span class="token punctuation">.</span>length <span class="token operator">-</span> n <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  doRead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>ended <span class="token operator">||</span> statte<span class="token punctuation">.</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  doRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>doRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  satte<span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state<span class="token punctuation">.</span>needReadable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token punctuation">;</span>
  state<span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当缓存区的长度为 0 或者缓存区的数量小于 <code>state.highWaterMark</code> 这个阀值，则会调用 <code>_read()</code> 去底层读取数据。<code>state.reading</code> 标志上次从底层取数据的操作是否完成，一旦 <code>push</code> 被调用，就会就会设置 <code>false</code>，表示此次 <code>_read()</code> 结束。</p> <h3 id="push"><a href="#push" class="header-anchor">#</a> push</h3> <p>消耗方调用 <code>read(n)</code> 促使流输出数据，而流通过 <code>_read()</code> 使底层调用 <code>push()</code> 方法将数据传给流。如果调用 <code>push</code> 方法时缓存为空，则当前数据即为下一个需要的数据。这个数据可能先添加到缓存中，也可能直接输出。执行 <code>read</code> 方法时，在调用 <code>_read</code> 后，如果从缓存中取到了数据，就以 <code>data</code> 事件输出。</p> <p>所以，如果 <code>_read</code> 异步调用 <code>push</code> 时发现缓存为空，则意味着当前数据是下一个需要的数据，且不会被 <code>read</code> 方法输出，应当在 <code>push</code> 方法中立即以 <code>data</code> 事件输出。</p> <div class="language-js extra-class"><pre class="language-js"><code>state<span class="token punctuation">.</span>flowing <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>sync<span class="token punctuation">;</span>
</code></pre></div><h3 id="end"><a href="#end" class="header-anchor">#</a> end</h3> <p>由于流是分次向底层请求数据的，需要底层显示地告诉流数据是否取完。所以，当某次（执行 <code>_read()</code>）取数据时，调用了 <code>push(null)</code>，就意味着底层数据取完。此时，流会设置 <code>state.ended</code>。</p> <p><code>state.length</code> 表示缓存中当前的数据量。只有当 <code>state.length</code> 为 0，且 <code>state.ended</code> 为 <code>true</code>，才意味着所有的是数据都被消耗了。一旦在执行 <code>read(n)</code> 时检测到这个条件，便会触发 <code>end</code> 事件。当然，这个事件只会触发一次。</p> <h3 id="readable"><a href="#readable" class="header-anchor">#</a> readable</h3> <p>在调用完 <code>_read()</code> 后，<code>read(n)</code> 会试着从缓存中取数据。如果 <code>_read()</code> 是异步调用 <code>push()</code> 方法的，则此时缓存中的数据量不会增多，容易出现数据量不够的现象。</p> <p>如果 <code>read(n)</code> 的返回值为 <code>null</code>，说明这次未能从缓存中取出所需量的数据。此时，消耗方需要等待新的数据到达后再次尝试调用 <code>read</code> 方法。</p> <p>在数据到达后，流是通过 readable 事件来通知消耗方。在此种情况下，<code>push</code> 方法如果立即输出数据，接收方直接监听 <code>data</code> 事件即可，否则数据被添加到缓存中，需要触发 readable 事件。消耗方必须监听这个事件，再调用 <code>read</code> 方法取得数据。</p> <h2 id="实现过程"><a href="#实现过程" class="header-anchor">#</a> 实现过程</h2> <h3 id="流动模式原理"><a href="#流动模式原理" class="header-anchor">#</a> 流动模式原理</h3> <p>🌰 <strong>示例：可读流的流动模式原理代码实现过程</strong></p> <p>从 Node.js 官方文档可知，流继承自 EventEmitter 模块，然后我们定义一些默认参数、缓存区、模式等。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ReadableStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'r'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 会随着读取的位置改变</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> options<span class="token punctuation">.</span>end <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认 null 就是 Buffer</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 参数的问题</span>
   	<span class="token comment">// 非流动模式</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建 Buffer 用于存储每次读出的数据</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 打开这个文件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 此方法默认同步调用，每次设置 on 监听事件时都会调用之前所有的 newListener 事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'data'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 相当于用户监听了 data 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fllowing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// 开始读取，客户已经监听的 data 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 用于打开文件的方法</span>
  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fd 表示的就是当前 this.path 的这个文件，从 3 开始（number 类型）</span>
    fs<span class="token punctuation">.</span>open（<span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 有可能 fd 这个文件不存在，需要做处理</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果有自动关闭，则帮他销毁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 销毁（关闭文件，触发关闭文件事件）</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果有错误，就会触发 error 事件</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>）
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 用于在文件操作出错或读完之后关闭文件</span>
  <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先判断有没有 fd 有关闭文件，触发 close 事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果文件被打开过，就关闭文件并且触发 close 事件</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 销毁</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 默认第一次调用 read 方法时 fd 还没获得，所以不能直接读</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时文件还没打开</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当文件真正打开的时候，会触发 open 事件，触发事件后再执行 read，此时 fd 肯定拿到了</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 每次读的时候都要判断一下下次读几个，如果没有 end 就根据 highWaterMark 来（读所有的）</span>
    <span class="token comment">// 如果有且大于 highWaterMark 就根据 highWaterMark 来</span>
    <span class="token comment">// 如果小于 highWaterMark 就根据 end 来</span>
    <span class="token keyword">let</span> howMuchToRead <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> howMuchToRead<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> byteRead</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> byteRead<span class="token punctuation">;</span>
      <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> byteRead<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> byteRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 如果读取到的数量和 highWaterMark 一样，说明还得继续读</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>byteRead <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flowing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>byteRead <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="暂停模式原理"><a href="#暂停模式原理" class="header-anchor">#</a> 暂停模式原理</h3> <p>以上是流动模式的可读流实现原理，暂停模式的可读流原理与流动模式的主要区别在于监听 <code>readable</code> 事件的绑定与 <code>read</code> 方法，先实现监听绑定 <code>readable</code> 事件回调函数时，调用 <code>read</code> 方法读取数据到缓存区，定义一个读取方法 <code>_read</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> options<span class="token punctuation">.</span>end<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'r'</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 缓存区</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  <span class="token comment">// 缓存区大小</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>emittedReadable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 不是正在读取的</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">eventName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventName <span class="token operator">===</span> 'readable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>emittedReadable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bytesRead</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+=</span> bytesRead<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>emittedReadable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>emiitedReadable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由 API 可知，暂停模式下的可读流手动调用 <code>read</code> 方法参数可以大于 highWaterMark，为了处理这种情况，我们先写一个函数 <code>computeNewHighWaterMark</code>，取到大于等于 <code>n</code> 的最小 2 的 n 次方的整数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">computeNewHighWaterMark</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  n<span class="token operator">--</span><span class="token punctuation">;</span>
  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
  n <span class="token operator">|=</span> n <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">;</span>
  n<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后写 <code>read</code> 方法，要考虑全 n 的各种情况：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 更改缓存区大小，读取五个就找 2 的几次放最近的</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> <span class="token function">computeNewHighMark</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>emiitedReadable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 如果 n &gt; 0 就从缓存区中获取</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">// 维护 Buffer 的索引的</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> n <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 读取内容，缓存区中有这么多</span>
    <span class="token comment">// 在缓存区中取 [[2, 3], [4, 5, 6]]</span>
    
    <span class="token comment">// 这是要返回的 Buffer</span>
    buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> buf<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>buf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buf<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 拷贝够了，不需要再拷贝了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-=</span> n<span class="token punctuation">;</span>
          <span class="token comment">// 取出留下的部分</span>
          <span class="token keyword">let</span> bufferArr <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 如果有剩下的内容，再放入缓存中</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferArr<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>bufferArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当前缓存区，小于 highWaterMark 时再去读取</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>emittedReadable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reading<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 异步的</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="readable-2"><a href="#readable-2" class="header-anchor">#</a> Readable</h3> <p><code>readable</code> 这个方法是可读流的一种暂停模式，他的模式可以参考为可读流是往水杯倒水的人， Readable 是喝水的人，他们之间存在着一种联系，只要 Readable 喝掉一点水，可读流就会继续往里倒。</p> <ul><li>Readable 会在刚开始监听 Readable 的时候就触发流，此时流就会读取一次数据，之后流会监听，如果有人读过流（喝过水），并且减少，就会再去读一次（倒点水）</li> <li>Readable 主要用来做行读取器（LineReader）</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> read <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ReadableStream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./readStream.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 每次读 7 个</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">7</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果可读流第一次全部读下来并且小于 highWaterMark，就会再读一次（再触发一次 readable 事件）</span>
<span class="token comment">// 如果 rs.read() 不加参数，一次性读完，会从缓存区再读一次，为 null</span>
<span class="token comment">// 如果 readable 每次都刚好读完（即 rs.read() 的参数刚好和 highWaterMark 相等），就会一直触发 readable 事件，如果最后不足读取的数，就会先触发一次 null，最后吧剩下的读完</span>
<span class="token comment">// 一开始缓存区为 0 的时候</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>实战：行读取器（平常我们的文件可能有回车、换行，此时如果要每次想读一行的数据，就得用到 <code>readable</code>）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果要将内容全部读出就用 on('data')，精确读取就用 on('readable')</span>
<span class="token keyword">class</span> <span class="token class-name">LineReader</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">construtor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 回车符的十六进制</span>
    <span class="token keyword">const</span> <span class="token constant">RETURN</span> <span class="token operator">=</span> <span class="token number">0x0d</span><span class="token punctuation">;</span>
    <span class="token comment">// 换行符的十六进制</span>
    <span class="token keyword">const</span> <span class="token constant">LINE</span> <span class="token operator">=</span> <span class="token number">0x0a</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newListener'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'newLine'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> char<span class="token punctuation">;</span>
          <span class="token comment">// 每次读一次，当读完的时候会返回 null，终止循环</span>
          <span class="token keyword">while</span><span class="token punctuation">(</span>char <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">case</span> <span class="token constant">RETURN</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token comment">// Mac 下只有换行符，windows 下是回车符和换行符，需要根据不同的转换</span>
              <span class="token keyword">case</span> <span class="token constant">LINE</span><span class="token operator">:</span>
                <span class="token comment">// 如果是换行符就把数组转换为字符串</span>
                <span class="token keyword">let</span> r <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 把数组清空</span>
                arr<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// 触发 newLine 事件，把得到的一行数据输出</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'newLine'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">// 如果不是换行符，就放入数组中</span>
                arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>char<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 以上只能取出之前的换行符前的代码，最后一行的后面没有换行符，所以需要特殊处理，当可读流读完需要触发 end 事件时</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 取出最后一行数据，转成字符串</span>
      <span class="token keyword">let</span> r <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      arr<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'newLine'</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> lineReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LineReader</span><span class="token punctuation">(</span><span class="token string">'./index.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineReader<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'newLine'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="自定义可读流"><a href="#自定义可读流" class="header-anchor">#</a> 自定义可读流</h3> <p>由于 <code>createReadStream</code> 内部调用了 ReadStream 类，ReadStream 又实现了 Readable 接口，ReadStream 实现了 <code>_read()</code> 方法，所以我们通过自定义一个累继承 <code>stream</code> 模块的 Readable，并在原型上自定义自己的可读流。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyRead</span> <span class="token keyword">extends</span> <span class="token class-name">Readable</span> <span class="token punctuation">{</span>
  <span class="token comment">// 流需要一个 _read 方法，方法中 push 什么，外面就接收什么</span>
  <span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// push 方法就是上面 _read 方法中的 push 一样，把数据放入缓存区中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'100'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果 push 了 null 就表示没有东西可读了，停止（如果不写，就会一直 push 上面的值，死循环）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="运行全流程"><a href="#运行全流程" class="header-anchor">#</a> 运行全流程</h2> <img src="/node-guidebook/assets/img/stream-flow.c189e9da.jpg" alt="流的流程图" style="zoom:80%;"> <p>如上图，当我们创建一个可读流的时候，<code>readable._readableState.flowing</code> 属性默认为 <code>null</code>，这时我们有两种选择：</p> <ol><li>监听 <code>readable</code> 事件，这是可读流会读取 64 KB（可以在创建可读流时，通过 <code>option</code> 参数重的 highWaterMark 更改）数据到流的缓存区中，等待你用 <code>read</code> 方法取读取并消费数据，当你用 <code>read</code> 方法读了 64KB 数据之后，会再次出发 <code>readable</code> 事件，知道你读完了源文件的所有数据。记住，之所以叫暂停模式是因为如果你不调用 <code>read</code> 方法，代码永远会停在这里，什么事情也不会发生。</li> <li>如果你选择监听 <code>data</code> 事件，可读流会直接读取 64KB 数据并通过 <code>data</code> 事件的回调函数提供给你消费，并且这个过程不会停止，如果源文件中有很多数据，会不停的触发 <code>data</code> 事件，知道全部读取完成。当然，在这个过程中你随时可以通过 <code>stream.pause()</code> 方法暂停它。</li></ol> <p>那么，这两种模式有什么区别呢？在我理解，如果你不需要对数据进行精确控制，首先选择<strong>流动模式</strong>，因为它的效率更高。如果需要对流的过程进行精确控制则可以选择<strong>暂停模式</strong>。也就是说暂停模式是流更高级一些的用法。其实官方建议我们尽量不要手动去操作流，如果可以，尽量使用 <code>pipe</code> 方法。</p> <p>接下来，不论我们以哪种方式读到了文件中的数据，这时我们都可以创建一个可写流并调用可写流的 <code>write</code> 方法来消费读到的数据。调用 <code>write</code> 方法会向文件中写入数据，但是因为写入的速度较慢，如果当前写入还在进行，而你又调用了 <code>write</code> 方法，Node.js 会将你要写入的数据缓存在一个缓存区中，等到文件写入完毕会从缓存区中取出数据，继续写入。</p> <p><code>write</code> 方法拥有一个布尔类型的返回值，用来表示目前是否还可以继续调用 <code>write</code> 方法写入内容。如果返回 <code>false</code>，我们应当停止读取数据以避免消耗过多内存。那么什么时候会返 <code>false</code> 呢？就是当缓存区的大小大于16KB（可以在创建可读流时，通过 <code>option</code> 参数中的 <code>highWaterMark</code> 更改）时。</p> <p>缓存区满后，文件写入一直在进行，不一会儿会把缓存区的内容全部写入，缓存区处于清空状态，这时会触发可写流的 <code>drain</code> 事件，这时我们可以继续向文件写入数据了。注意：如果缓存区从未满过，<code>drain</code> 事件永远也不会触发。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">1/18/2020, 11:48:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node-guidebook/io/stream/stream.html" class="prev">流</a></span> <span class="next"><a href="/node-guidebook/io/stream/writable.html">可写流</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node-guidebook/assets/js/app.b56de1e6.js" defer></script><script src="/node-guidebook/assets/js/2.9a9b2fe1.js" defer></script><script src="/node-guidebook/assets/js/6.21a4b1c5.js" defer></script>
  </body>
</html>
