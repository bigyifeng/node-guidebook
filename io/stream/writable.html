<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>可写流 | Node-Guidebook</title>
    <meta name="description" content="">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/node-guidebook/assets/css/0.styles.04b4ede2.css" as="style"><link rel="preload" href="/node-guidebook/assets/js/app.b56de1e6.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/2.9a9b2fe1.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/38.57cfe6d1.js" as="script"><link rel="prefetch" href="/node-guidebook/assets/js/10.f31a5cd7.js"><link rel="prefetch" href="/node-guidebook/assets/js/11.9a11099b.js"><link rel="prefetch" href="/node-guidebook/assets/js/12.d192428c.js"><link rel="prefetch" href="/node-guidebook/assets/js/13.3b64565c.js"><link rel="prefetch" href="/node-guidebook/assets/js/14.d5a9b897.js"><link rel="prefetch" href="/node-guidebook/assets/js/15.01e27e34.js"><link rel="prefetch" href="/node-guidebook/assets/js/16.606d1944.js"><link rel="prefetch" href="/node-guidebook/assets/js/17.51b30e3b.js"><link rel="prefetch" href="/node-guidebook/assets/js/18.063b4f41.js"><link rel="prefetch" href="/node-guidebook/assets/js/19.7f27a998.js"><link rel="prefetch" href="/node-guidebook/assets/js/20.c97daf38.js"><link rel="prefetch" href="/node-guidebook/assets/js/21.2e1c632f.js"><link rel="prefetch" href="/node-guidebook/assets/js/22.fbd33fb6.js"><link rel="prefetch" href="/node-guidebook/assets/js/23.b087a4cc.js"><link rel="prefetch" href="/node-guidebook/assets/js/24.9bf9975f.js"><link rel="prefetch" href="/node-guidebook/assets/js/25.833c04e5.js"><link rel="prefetch" href="/node-guidebook/assets/js/26.fa5f5e57.js"><link rel="prefetch" href="/node-guidebook/assets/js/27.e048e63c.js"><link rel="prefetch" href="/node-guidebook/assets/js/28.7389fa33.js"><link rel="prefetch" href="/node-guidebook/assets/js/29.5f7ae828.js"><link rel="prefetch" href="/node-guidebook/assets/js/3.028038f2.js"><link rel="prefetch" href="/node-guidebook/assets/js/30.97c6204d.js"><link rel="prefetch" href="/node-guidebook/assets/js/31.0f2c316e.js"><link rel="prefetch" href="/node-guidebook/assets/js/32.a2d860ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/33.ef37b95b.js"><link rel="prefetch" href="/node-guidebook/assets/js/34.55cdaada.js"><link rel="prefetch" href="/node-guidebook/assets/js/35.7f7e104c.js"><link rel="prefetch" href="/node-guidebook/assets/js/36.89d29ca3.js"><link rel="prefetch" href="/node-guidebook/assets/js/37.13112c94.js"><link rel="prefetch" href="/node-guidebook/assets/js/39.db4440a8.js"><link rel="prefetch" href="/node-guidebook/assets/js/4.675c3702.js"><link rel="prefetch" href="/node-guidebook/assets/js/40.95563075.js"><link rel="prefetch" href="/node-guidebook/assets/js/41.c737d452.js"><link rel="prefetch" href="/node-guidebook/assets/js/42.77397b50.js"><link rel="prefetch" href="/node-guidebook/assets/js/43.55d50864.js"><link rel="prefetch" href="/node-guidebook/assets/js/44.2ee11d4d.js"><link rel="prefetch" href="/node-guidebook/assets/js/45.cbfb9e4f.js"><link rel="prefetch" href="/node-guidebook/assets/js/46.8c5dee73.js"><link rel="prefetch" href="/node-guidebook/assets/js/47.ed9a119b.js"><link rel="prefetch" href="/node-guidebook/assets/js/48.ace38419.js"><link rel="prefetch" href="/node-guidebook/assets/js/49.e79545ac.js"><link rel="prefetch" href="/node-guidebook/assets/js/5.11ee68c1.js"><link rel="prefetch" href="/node-guidebook/assets/js/50.9fbe2e33.js"><link rel="prefetch" href="/node-guidebook/assets/js/51.4896a061.js"><link rel="prefetch" href="/node-guidebook/assets/js/52.c4ceb1c2.js"><link rel="prefetch" href="/node-guidebook/assets/js/53.8c0fea71.js"><link rel="prefetch" href="/node-guidebook/assets/js/54.c05dccf1.js"><link rel="prefetch" href="/node-guidebook/assets/js/55.b2d65211.js"><link rel="prefetch" href="/node-guidebook/assets/js/56.a43684ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/57.7ba8a6f3.js"><link rel="prefetch" href="/node-guidebook/assets/js/58.f0c2c1ef.js"><link rel="prefetch" href="/node-guidebook/assets/js/59.944bad13.js"><link rel="prefetch" href="/node-guidebook/assets/js/6.21a4b1c5.js"><link rel="prefetch" href="/node-guidebook/assets/js/60.e62081dc.js"><link rel="prefetch" href="/node-guidebook/assets/js/61.5e74305b.js"><link rel="prefetch" href="/node-guidebook/assets/js/62.ca1dac6e.js"><link rel="prefetch" href="/node-guidebook/assets/js/63.c03d966c.js"><link rel="prefetch" href="/node-guidebook/assets/js/64.c7411f74.js"><link rel="prefetch" href="/node-guidebook/assets/js/65.23e9fb75.js"><link rel="prefetch" href="/node-guidebook/assets/js/66.4dbed100.js"><link rel="prefetch" href="/node-guidebook/assets/js/67.80de04b2.js"><link rel="prefetch" href="/node-guidebook/assets/js/68.73588625.js"><link rel="prefetch" href="/node-guidebook/assets/js/69.d28f892e.js"><link rel="prefetch" href="/node-guidebook/assets/js/7.62412490.js"><link rel="prefetch" href="/node-guidebook/assets/js/70.a271a34d.js"><link rel="prefetch" href="/node-guidebook/assets/js/71.407abc57.js"><link rel="prefetch" href="/node-guidebook/assets/js/72.67ca9438.js"><link rel="prefetch" href="/node-guidebook/assets/js/73.c95f2cd6.js"><link rel="prefetch" href="/node-guidebook/assets/js/74.95ef83e7.js"><link rel="prefetch" href="/node-guidebook/assets/js/75.a225a743.js"><link rel="prefetch" href="/node-guidebook/assets/js/76.45437d36.js"><link rel="prefetch" href="/node-guidebook/assets/js/77.919cd113.js"><link rel="prefetch" href="/node-guidebook/assets/js/78.447a327e.js"><link rel="prefetch" href="/node-guidebook/assets/js/79.74917783.js"><link rel="prefetch" href="/node-guidebook/assets/js/8.26079951.js"><link rel="prefetch" href="/node-guidebook/assets/js/80.7517c60e.js"><link rel="prefetch" href="/node-guidebook/assets/js/81.4896eb33.js"><link rel="prefetch" href="/node-guidebook/assets/js/82.52db751e.js"><link rel="prefetch" href="/node-guidebook/assets/js/83.108e2ceb.js"><link rel="prefetch" href="/node-guidebook/assets/js/84.c4018c3e.js"><link rel="prefetch" href="/node-guidebook/assets/js/85.95ab55fa.js"><link rel="prefetch" href="/node-guidebook/assets/js/86.01a6e820.js"><link rel="prefetch" href="/node-guidebook/assets/js/87.7748e683.js"><link rel="prefetch" href="/node-guidebook/assets/js/88.730b440e.js"><link rel="prefetch" href="/node-guidebook/assets/js/89.4eca5ebb.js"><link rel="prefetch" href="/node-guidebook/assets/js/9.841d82b7.js"><link rel="prefetch" href="/node-guidebook/assets/js/90.6dc66fef.js"><link rel="prefetch" href="/node-guidebook/assets/js/91.616655e3.js"><link rel="prefetch" href="/node-guidebook/assets/js/92.0e127a47.js"><link rel="prefetch" href="/node-guidebook/assets/js/93.cc651dc5.js"><link rel="prefetch" href="/node-guidebook/assets/js/94.0c069be2.js"><link rel="prefetch" href="/node-guidebook/assets/js/95.28ec5306.js"><link rel="prefetch" href="/node-guidebook/assets/js/96.4680804b.js"><link rel="prefetch" href="/node-guidebook/assets/js/97.04e2deb8.js">
    <link rel="stylesheet" href="/node-guidebook/assets/css/0.styles.04b4ede2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/node-guidebook/" class="home-link router-link-active"><img src="/node-guidebook/favicon.png" alt="Node-Guidebook" class="logo"> <span class="site-name can-hide">Node-Guidebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/module/commonjs.html" class="sidebar-link">CommonJS</a></li><li><a href="/node-guidebook/module/module.html" class="sidebar-link">模块机制</a></li><li><a href="/node-guidebook/module/global.html" class="sidebar-link">全局对象</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>I/O</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/io/io.html" class="sidebar-link">I/O</a></li><li><a href="/node-guidebook/io/stream/stream.html" class="sidebar-link">流</a></li><li><a href="/node-guidebook/io/stream/readable.html" class="sidebar-link">可读流</a></li><li><a href="/node-guidebook/io/stream/writable.html" class="active sidebar-link">可写流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/writable.html#实现过程" class="sidebar-link">实现过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/writable.html#自定义可写流" class="sidebar-link">自定义可写流</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/io/stream/writable.html#管道流" class="sidebar-link">管道流</a></li></ul></li><li><a href="/node-guidebook/io/buffer.html" class="sidebar-link">缓冲器</a></li><li><a href="/node-guidebook/io/filesystem.html" class="sidebar-link">文件系统</a></li><li><a href="/node-guidebook/io/path.html" class="sidebar-link">路径</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/process/process.html" class="sidebar-link">进程</a></li><li><a href="/node-guidebook/process/child-process.html" class="sidebar-link">子进程</a></li><li><a href="/node-guidebook/process/cluster.html" class="sidebar-link">集群</a></li><li><a href="/node-guidebook/process/ipc.html" class="sidebar-link">进程间通信</a></li><li><a href="/node-guidebook/process/daemon.html" class="sidebar-link">守护进程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/network/socket.html" class="sidebar-link">Socket</a></li><li><a href="/node-guidebook/network/dns.html" class="sidebar-link">DNS</a></li><li><a href="/node-guidebook/network/net.html" class="sidebar-link">Net</a></li><li><a href="/node-guidebook/network/dgram.html" class="sidebar-link">Dgram</a></li><li><a href="/node-guidebook/network/http.html" class="sidebar-link">HTTP</a></li><li><a href="/node-guidebook/network/http-server.html" class="sidebar-link">HTTP Server</a></li><li><a href="/node-guidebook/network/http-client-request.html" class="sidebar-link">HTTP ClientRequest</a></li><li><a href="/node-guidebook/network/http-incoming-message.html" class="sidebar-link">HTTP IncomingMessage</a></li><li><a href="/node-guidebook/network/http-server-response.html" class="sidebar-link">HTTP ServerResponse</a></li><li><a href="/node-guidebook/network/https.html" class="sidebar-link">HTTPS</a></li><li><a href="/node-guidebook/network/http2.html" class="sidebar-link">HTTP2</a></li><li><a href="/node-guidebook/network/url.html" class="sidebar-link">URL</a></li><li><a href="/node-guidebook/network/querystring.html" class="sidebar-link">QueryString</a></li><li><a href="/node-guidebook/network/crypto.html" class="sidebar-link">Crypto</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/3m/npm.html" class="sidebar-link">NPM</a></li><li><a href="/node-guidebook/3m/npx.html" class="sidebar-link">NPX</a></li><li><a href="/node-guidebook/3m/nrm.html" class="sidebar-link">NRM</a></li><li><a href="/node-guidebook/3m/nvm.html" class="sidebar-link">NVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>推荐资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/recommend.html" class="sidebar-link">推荐资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="可写流"><a href="#可写流" class="header-anchor">#</a> 可写流</h1> <p>可写流（Writable Streams）是对数据写入目的地的一种抽象，用来消费上游流过来的数据，通过可写流程可以把数据写入设备，常见的可写流是本地磁盘文件写入和 TCP、HTTP 等网络响应。</p> <p>可写流的原理其实与可读流类似，当数据过来的时候会写入缓存池，当写入的速度很慢或者写入暂停时候，数据流便会进入到队列池缓存起来，当然即使缓存池满了，剩余的数据也是存在内存。</p> <p>在 Node.js 中属于可读流的接口：</p> <ul><li>HTTP Request on the client 客户端请求</li> <li>HTTP Response on the server 服务器响应</li> <li>fs write streams 文件</li> <li>zlib streams 压缩</li> <li>crypto streams 加密</li> <li>TCP sockets TCP 服务器</li> <li>child process stdin 子进程标准输入</li> <li>process.stdout / process.stderr 标准输出，错误输出</li></ul> <h2 id="实现过程"><a href="#实现过程" class="header-anchor">#</a> 实现过程</h2> <p>通过实现简单版的 WritableStream 更好地了解可写流。</p> <ol><li>通过相关模块接口可以创建 WritableStreams 实例，例如 <code>fs.createWriteStream</code></li> <li><code>highWaterMark</code> 用于设置 WritableStreams 可写缓冲区的大小，默认为 16KB，当 <code>正在写入数据+缓冲区数据长度</code> 超过 <code>highWaterMark</code> 的值时，会触发 <code>drain</code> 事件</li> <li>可写流 <code>write</code> 和 <code>end</code> 方法知恩那个写字符串或 Buffer 类型的数据</li> <li>并行写，顺序不会乱</li> <li>通过一个字节的缓冲区 <code>hightWaterMark = 1</code>，写入一个 10 个数</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 可写流需要考虑并发写的问题，比如并发写时，要确保写的顺序不错乱
 * 为了保证并发写顺序不会乱，WriteStream 创建了一个链表结构缓冲区
 * 用来按顺序缓存待写的内容，等待当前正在写的内容写完，再依次从缓冲区中一个一个读取出来继续写
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element <span class="token operator">=</span> element<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">LinkList</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">append</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 链表头</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 找到最后一个把当前节点放到后面去</span>
      <span class="token keyword">let</span> current <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        current <span class="token operator">=</span> current<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      current<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> head <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>head<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> head<span class="token punctuation">.</span>element<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">WritableStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入文件的路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token comment">// 标识，写入文件要做的操作</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'w'</span><span class="token punctuation">;</span>
    <span class="token comment">// 水位线，一次可写入缓存中的字节</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入完毕是否关闭</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token number">0o666</span><span class="token punctuation">;</span>
    <span class="token comment">// 编码</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 表示当前是否正在写入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true</span>
    <span class="token comment">// 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入的位置的偏移量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
    <span class="token comment">// 打开文件准备写入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 用来统计 缓冲区 + 正在写入的内容的个数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 只能写字符串或 Buffer 类型的数据</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    chunk <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">?</span> chunk <span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>legn <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span>
    
    <span class="token comment">// 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_writing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前正在写，将待写内容保存到缓冲区中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        chunk<span class="token punctuation">,</span>
        encoding<span class="token punctuation">,</span>
        callback
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 真正的写入逻辑</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从缓冲区中取出一个出来写</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// true：没有超过 highWaterMark（可以继续写）</span>
    <span class="token comment">// false：超过 highWaterMark（不能继续写了）</span>
    <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依此从链表中取出一个出来写</span>
    <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      	obj<span class="token punctuation">.</span>callback <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	<span class="token comment">// obj 为 undefined 说明缓冲区已经清空完毕</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>needDrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当 needDrain 为 true 时，需要触发 drain 事件</span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> written</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> written<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> written<span class="token punctuation">;</span>
      <span class="token comment">// 每次写入成功就从缓冲区中依次取出一个出来继续写</span>
      <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// end 相当于 write + close</span>
  <span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>关键点分析：</p> <ol><li><p>WritableStream 需要继承 EventEmitter。比如 <code>drain</code>、<code>close</code>、<code>error</code> 等事件都是基于 EventEmitter 实现的。</p></li> <li><p>构建一个链表结构的缓冲区，这里为什么不采用数组呢，因为在 WritableStream 中，每次都是从缓冲区中取出第一个数据出来写，如果是数组的话，每次 pop 一个数据出来后，需要设计到数组的重排，因此这里采用链表的结构明显性能比较高。</p></li> <li><p>定义一个属性 <code>_writing</code> 来保存当前是否正在写的状态，当 <code>_writing</code> 为 <code>true</code> 时，代表当前正在写入，当 <code>writing</code> 为 <code>false</code> 时，代表当前没有在写入。</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 表示当前是否正在写入</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
</code></pre></div><ol start="4"><li><p>可写流的特点就是第一次 <code>write</code> 是真正的写，之后的 <code>write</code> 会被保存到缓冲区中，等当前的数据写完再从缓冲区中按顺序读出来继续写</p></li> <li><p>定义一个属性 <code>needDrain</code>，代表是否需要触发 <code>drain</code> 事件。当<strong>缓冲区的长度和正在写入的长度</strong>达到了期望的值 <code>highWaterMark</code> 时，设置为 <code>needDrain</code> 为 <code>true</code></p></li> <li><p>WritableStream 默认会先 <code>open</code> 文件</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">WritableStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">'w'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> options<span class="token punctuation">.</span>autoClose <span class="token operator">||</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token number">0o666</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token string">'utf8'</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 表示当前是否正在写入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true</span>
    <span class="token comment">// 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 写入的位置的偏移量</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
    <span class="token comment">// 打开文件准备写入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 用来统计 缓冲区 + 正在写入的内容的个数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>实现 <code>write</code> 方法</li></ol> <p>所有可写流都需要实现 <code>stream.Writable</code> 类定义的接口，<code>write</code> 是 <code>stream.Writable</code> 的一个方法，在 <code>write</code> 方法内部会调用子类（WritableStream）的 <code>_write</code>，本文为了方便理解，把 <code>write</code> 的逻辑包含在了 WriteStream 中</p> <p><code>write</code> 主要实现的功能如下：</p> <p>7-1. 将 chunk 统一转化为 Buffer 类型</p> <p>7-2. 将 <code>_writing</code> 判断当前是否正在写，如果是，将数据存到缓冲区中，否则，调用 <code>_write</code> 进行真正的写数据</p> <p>7-3. <code>write</code> 函数返回一个 <code>flat</code> 状态，代表目前缓冲区内的数据长度是否小于 <code>highWaterMark</code>，是则可以继续写，不是则不能继续写，并且会触发 <code>drain</code> 事件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 只能写 字符串 或 Buffer 类型的数据</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	chunk <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">?</span> chunk <span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>legn <span class="token operator">+=</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span>
    
    <span class="token comment">// 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token operator">!</span>flag<span class="token punctuation">;</span> 
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_writing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前正在写，将待写内容保存到缓冲区中</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        chunk<span class="token punctuation">,</span>
        encoding<span class="token punctuation">,</span>
        callback
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 真正的写入逻辑</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从缓冲区中取出一个出来写</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// true：没有超过 highWaterMark（可以继续写）</span>
    <span class="token comment">// false：超过 highWaterMark（不能继续写了）</span>
    <span class="token keyword">return</span> flag<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="8"><li>实现 <code>_write</code> 函数</li></ol> <p>可写流必须实现 <code>stream.Writable</code> 的 <code>writable._write()</code> 或 <code>writable._writev()</code> 方法。</p> <p>这里实现 <code>writable._write()</code> 方法。</p> <p>关键点：</p> <p>8-1. 要确保 <code>fs.open</code> 打开成功后拿到 fd 才能开始写</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>8-2. 当写完此次 chunk 的数据后，需要从缓冲区取出一个出来继续写，直到清空缓冲区里的数据</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> clearBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> written</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> written<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>len <span class="token operator">-=</span> written
    <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 每次写入成功就从缓冲区中依次取出一个出来继续写</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 依次从链表中取出一个出来写</span>
<span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      obj<span class="token punctuation">.</span>callback <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// obj 为 undefined 说明缓冲区已经清空完毕</span>
    <span class="token comment">// 表示当前没有在写，下次再调用 write 可以直接向文件中写入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_writing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>needDrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当 needDrain 为 true 时，需要触发 drain 事件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>needDrain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="自定义可写流"><a href="#自定义可写流" class="header-anchor">#</a> 自定义可写流</h3> <p>因为 <code>createWriteStream</code> 内部调用了 WriteStream 累，WriteStream 又实现了 Writable 接口，WriteStream 实现了 <code>_write()</code> 方法，所以我们通过自定义一个类继承 <code>stream</code> 模块的 Writable，并在原型上自定义一个 <code>_write()</code> 就可以自定义自己的可写流。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> Writable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyWrite</span> <span class="token keyword">extends</span> <span class="token class-name">Writable</span> <span class="token punctuation">{</span>
  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// write() 第一个参数，写入的数据</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个 callback，就相当于我们上面的 clearBuffer 方法，如果不执行 callback 就不会继续从缓存中取出写</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
write<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="管道流"><a href="#管道流" class="header-anchor">#</a> 管道流</h2> <p>管道流（pipe），是可读流上的方法，至于为什么放到这里，主要是因为需要 2 个流的基础知识，是可读流配合可写流的一种<strong>传输方式</strong>。如果用原来的读写，因为写比较耗时，所以会多读少写，耗内存，但用了 <code>pipe</code> 就不会了，始终用规定的内存。</p> <p><strong>用法</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// pipe 方法叫管道，可以控制速率</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./r.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">4</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./w.txt'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  highWaterMark<span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 会监听 rs 的 on('data') 将读取到的数据，通过 ws.write 的方法写入文件</span>
<span class="token comment">// 调用写的一个方法，返回 boolean 类型</span>
<span class="token comment">// 如果返回 false 就调用 rs 的 pause 方法，暂停读取</span>
<span class="token comment">// 等待可写流，写入完毕再监听 drain resume rs</span>
rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 会控制速率，防止淹没可用内存</span>
</code></pre></div><p><strong>实现</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">requir</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这两个是自定义实现的 ReadStream 和 WriteStream</span>
<span class="token keyword">const</span> ReadStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ReadStream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> WriteStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./WriteStream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果用原来的读写；因为写比较耗时，所以会多读少写，耗内存</span>
<span class="token class-name">ReadStream</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pipe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dest</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> dest<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果写入的时候嘴巴吃满了就不继续读了，暂停</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 如果写的时候嘴巴里的吃完了，就会继续读</span>
  dest<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 清空缓存中的数据</span>
    fs<span class="token punctuation">.</span><span class="token function">fsync</span><span class="token punctuation">(</span>dest<span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      dest<span class="token punctuation">.</span><span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <p><strong>参考资料：</strong></p> <ul><li><a href="https://juejin.im/post/5ab4d31ff265da2391480e4b" target="_blank" rel="noopener noreferrer">Node.js Writable Stream 的实现简析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.cxdsimple.com/blog/20191210/5cab01ec.html" target="_blank" rel="noopener noreferrer">📝 Node WriteStream 可写流的实现原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">1/18/2020, 11:48:24 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node-guidebook/io/stream/readable.html" class="prev">可读流</a></span> <span class="next"><a href="/node-guidebook/io/buffer.html">缓冲器</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node-guidebook/assets/js/app.b56de1e6.js" defer></script><script src="/node-guidebook/assets/js/2.9a9b2fe1.js" defer></script><script src="/node-guidebook/assets/js/38.57cfe6d1.js" defer></script>
  </body>
</html>
