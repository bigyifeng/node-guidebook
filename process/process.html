<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>进程 | Node-Guidebook</title>
    <meta name="description" content="">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/node-guidebook/assets/css/0.styles.04b4ede2.css" as="style"><link rel="preload" href="/node-guidebook/assets/js/app.b56de1e6.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/2.9a9b2fe1.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/4.675c3702.js" as="script"><link rel="prefetch" href="/node-guidebook/assets/js/10.f31a5cd7.js"><link rel="prefetch" href="/node-guidebook/assets/js/11.9a11099b.js"><link rel="prefetch" href="/node-guidebook/assets/js/12.d192428c.js"><link rel="prefetch" href="/node-guidebook/assets/js/13.3b64565c.js"><link rel="prefetch" href="/node-guidebook/assets/js/14.d5a9b897.js"><link rel="prefetch" href="/node-guidebook/assets/js/15.01e27e34.js"><link rel="prefetch" href="/node-guidebook/assets/js/16.606d1944.js"><link rel="prefetch" href="/node-guidebook/assets/js/17.51b30e3b.js"><link rel="prefetch" href="/node-guidebook/assets/js/18.063b4f41.js"><link rel="prefetch" href="/node-guidebook/assets/js/19.7f27a998.js"><link rel="prefetch" href="/node-guidebook/assets/js/20.c97daf38.js"><link rel="prefetch" href="/node-guidebook/assets/js/21.2e1c632f.js"><link rel="prefetch" href="/node-guidebook/assets/js/22.fbd33fb6.js"><link rel="prefetch" href="/node-guidebook/assets/js/23.b087a4cc.js"><link rel="prefetch" href="/node-guidebook/assets/js/24.9bf9975f.js"><link rel="prefetch" href="/node-guidebook/assets/js/25.833c04e5.js"><link rel="prefetch" href="/node-guidebook/assets/js/26.fa5f5e57.js"><link rel="prefetch" href="/node-guidebook/assets/js/27.e048e63c.js"><link rel="prefetch" href="/node-guidebook/assets/js/28.7389fa33.js"><link rel="prefetch" href="/node-guidebook/assets/js/29.5f7ae828.js"><link rel="prefetch" href="/node-guidebook/assets/js/3.028038f2.js"><link rel="prefetch" href="/node-guidebook/assets/js/30.97c6204d.js"><link rel="prefetch" href="/node-guidebook/assets/js/31.0f2c316e.js"><link rel="prefetch" href="/node-guidebook/assets/js/32.a2d860ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/33.ef37b95b.js"><link rel="prefetch" href="/node-guidebook/assets/js/34.55cdaada.js"><link rel="prefetch" href="/node-guidebook/assets/js/35.7f7e104c.js"><link rel="prefetch" href="/node-guidebook/assets/js/36.89d29ca3.js"><link rel="prefetch" href="/node-guidebook/assets/js/37.13112c94.js"><link rel="prefetch" href="/node-guidebook/assets/js/38.57cfe6d1.js"><link rel="prefetch" href="/node-guidebook/assets/js/39.db4440a8.js"><link rel="prefetch" href="/node-guidebook/assets/js/40.95563075.js"><link rel="prefetch" href="/node-guidebook/assets/js/41.c737d452.js"><link rel="prefetch" href="/node-guidebook/assets/js/42.77397b50.js"><link rel="prefetch" href="/node-guidebook/assets/js/43.55d50864.js"><link rel="prefetch" href="/node-guidebook/assets/js/44.2ee11d4d.js"><link rel="prefetch" href="/node-guidebook/assets/js/45.cbfb9e4f.js"><link rel="prefetch" href="/node-guidebook/assets/js/46.8c5dee73.js"><link rel="prefetch" href="/node-guidebook/assets/js/47.ed9a119b.js"><link rel="prefetch" href="/node-guidebook/assets/js/48.ace38419.js"><link rel="prefetch" href="/node-guidebook/assets/js/49.e79545ac.js"><link rel="prefetch" href="/node-guidebook/assets/js/5.11ee68c1.js"><link rel="prefetch" href="/node-guidebook/assets/js/50.9fbe2e33.js"><link rel="prefetch" href="/node-guidebook/assets/js/51.4896a061.js"><link rel="prefetch" href="/node-guidebook/assets/js/52.c4ceb1c2.js"><link rel="prefetch" href="/node-guidebook/assets/js/53.8c0fea71.js"><link rel="prefetch" href="/node-guidebook/assets/js/54.c05dccf1.js"><link rel="prefetch" href="/node-guidebook/assets/js/55.b2d65211.js"><link rel="prefetch" href="/node-guidebook/assets/js/56.a43684ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/57.7ba8a6f3.js"><link rel="prefetch" href="/node-guidebook/assets/js/58.f0c2c1ef.js"><link rel="prefetch" href="/node-guidebook/assets/js/59.944bad13.js"><link rel="prefetch" href="/node-guidebook/assets/js/6.21a4b1c5.js"><link rel="prefetch" href="/node-guidebook/assets/js/60.e62081dc.js"><link rel="prefetch" href="/node-guidebook/assets/js/61.5e74305b.js"><link rel="prefetch" href="/node-guidebook/assets/js/62.ca1dac6e.js"><link rel="prefetch" href="/node-guidebook/assets/js/63.c03d966c.js"><link rel="prefetch" href="/node-guidebook/assets/js/64.c7411f74.js"><link rel="prefetch" href="/node-guidebook/assets/js/65.23e9fb75.js"><link rel="prefetch" href="/node-guidebook/assets/js/66.4dbed100.js"><link rel="prefetch" href="/node-guidebook/assets/js/67.80de04b2.js"><link rel="prefetch" href="/node-guidebook/assets/js/68.73588625.js"><link rel="prefetch" href="/node-guidebook/assets/js/69.d28f892e.js"><link rel="prefetch" href="/node-guidebook/assets/js/7.62412490.js"><link rel="prefetch" href="/node-guidebook/assets/js/70.a271a34d.js"><link rel="prefetch" href="/node-guidebook/assets/js/71.407abc57.js"><link rel="prefetch" href="/node-guidebook/assets/js/72.67ca9438.js"><link rel="prefetch" href="/node-guidebook/assets/js/73.c95f2cd6.js"><link rel="prefetch" href="/node-guidebook/assets/js/74.95ef83e7.js"><link rel="prefetch" href="/node-guidebook/assets/js/75.a225a743.js"><link rel="prefetch" href="/node-guidebook/assets/js/76.45437d36.js"><link rel="prefetch" href="/node-guidebook/assets/js/77.919cd113.js"><link rel="prefetch" href="/node-guidebook/assets/js/78.447a327e.js"><link rel="prefetch" href="/node-guidebook/assets/js/79.74917783.js"><link rel="prefetch" href="/node-guidebook/assets/js/8.26079951.js"><link rel="prefetch" href="/node-guidebook/assets/js/80.7517c60e.js"><link rel="prefetch" href="/node-guidebook/assets/js/81.4896eb33.js"><link rel="prefetch" href="/node-guidebook/assets/js/82.52db751e.js"><link rel="prefetch" href="/node-guidebook/assets/js/83.108e2ceb.js"><link rel="prefetch" href="/node-guidebook/assets/js/84.c4018c3e.js"><link rel="prefetch" href="/node-guidebook/assets/js/85.95ab55fa.js"><link rel="prefetch" href="/node-guidebook/assets/js/86.01a6e820.js"><link rel="prefetch" href="/node-guidebook/assets/js/87.7748e683.js"><link rel="prefetch" href="/node-guidebook/assets/js/88.730b440e.js"><link rel="prefetch" href="/node-guidebook/assets/js/89.4eca5ebb.js"><link rel="prefetch" href="/node-guidebook/assets/js/9.841d82b7.js"><link rel="prefetch" href="/node-guidebook/assets/js/90.6dc66fef.js"><link rel="prefetch" href="/node-guidebook/assets/js/91.616655e3.js"><link rel="prefetch" href="/node-guidebook/assets/js/92.0e127a47.js"><link rel="prefetch" href="/node-guidebook/assets/js/93.cc651dc5.js"><link rel="prefetch" href="/node-guidebook/assets/js/94.0c069be2.js"><link rel="prefetch" href="/node-guidebook/assets/js/95.28ec5306.js"><link rel="prefetch" href="/node-guidebook/assets/js/96.4680804b.js"><link rel="prefetch" href="/node-guidebook/assets/js/97.04e2deb8.js">
    <link rel="stylesheet" href="/node-guidebook/assets/css/0.styles.04b4ede2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/node-guidebook/" class="home-link router-link-active"><img src="/node-guidebook/favicon.png" alt="Node-Guidebook" class="logo"> <span class="site-name can-hide">Node-Guidebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/module/commonjs.html" class="sidebar-link">CommonJS</a></li><li><a href="/node-guidebook/module/module.html" class="sidebar-link">模块机制</a></li><li><a href="/node-guidebook/module/global.html" class="sidebar-link">全局对象</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>I/O</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/io/io.html" class="sidebar-link">I/O</a></li><li><a href="/node-guidebook/io/stream/stream.html" class="sidebar-link">流</a></li><li><a href="/node-guidebook/io/stream/readable.html" class="sidebar-link">可读流</a></li><li><a href="/node-guidebook/io/stream/writable.html" class="sidebar-link">可写流</a></li><li><a href="/node-guidebook/io/buffer.html" class="sidebar-link">缓冲器</a></li><li><a href="/node-guidebook/io/filesystem.html" class="sidebar-link">文件系统</a></li><li><a href="/node-guidebook/io/path.html" class="sidebar-link">路径</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/process/process.html" class="active sidebar-link">进程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#进程与线程" class="sidebar-link">进程与线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#进程概念" class="sidebar-link">进程概念</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#线程概念" class="sidebar-link">线程概念</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#node-js-中的进程与线程" class="sidebar-link">Node.js 中的进程与线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#node-js-中的进程" class="sidebar-link">Node.js 中的进程</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#线程" class="sidebar-link">线程</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/process/process.html#多进程-vs-多线程" class="sidebar-link">多进程 vs 多线程</a></li></ul></li><li><a href="/node-guidebook/process/child-process.html" class="sidebar-link">子进程</a></li><li><a href="/node-guidebook/process/cluster.html" class="sidebar-link">集群</a></li><li><a href="/node-guidebook/process/ipc.html" class="sidebar-link">进程间通信</a></li><li><a href="/node-guidebook/process/daemon.html" class="sidebar-link">守护进程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/network/socket.html" class="sidebar-link">Socket</a></li><li><a href="/node-guidebook/network/dns.html" class="sidebar-link">DNS</a></li><li><a href="/node-guidebook/network/net.html" class="sidebar-link">Net</a></li><li><a href="/node-guidebook/network/dgram.html" class="sidebar-link">Dgram</a></li><li><a href="/node-guidebook/network/http.html" class="sidebar-link">HTTP</a></li><li><a href="/node-guidebook/network/http-server.html" class="sidebar-link">HTTP Server</a></li><li><a href="/node-guidebook/network/http-client-request.html" class="sidebar-link">HTTP ClientRequest</a></li><li><a href="/node-guidebook/network/http-incoming-message.html" class="sidebar-link">HTTP IncomingMessage</a></li><li><a href="/node-guidebook/network/http-server-response.html" class="sidebar-link">HTTP ServerResponse</a></li><li><a href="/node-guidebook/network/https.html" class="sidebar-link">HTTPS</a></li><li><a href="/node-guidebook/network/http2.html" class="sidebar-link">HTTP2</a></li><li><a href="/node-guidebook/network/url.html" class="sidebar-link">URL</a></li><li><a href="/node-guidebook/network/querystring.html" class="sidebar-link">QueryString</a></li><li><a href="/node-guidebook/network/crypto.html" class="sidebar-link">Crypto</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/3m/npm.html" class="sidebar-link">NPM</a></li><li><a href="/node-guidebook/3m/npx.html" class="sidebar-link">NPX</a></li><li><a href="/node-guidebook/3m/nrm.html" class="sidebar-link">NRM</a></li><li><a href="/node-guidebook/3m/nvm.html" class="sidebar-link">NVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>推荐资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/recommend.html" class="sidebar-link">推荐资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="进程"><a href="#进程" class="header-anchor">#</a> 进程</h1> <p>关于 Process，我们需要讨论的是两个概念 ① 操作系统的进程，② Node.js 中的 Process 对象。操作进程对于服务端而言，好比 HTML 之于前端一样基础，想做服务端编程是不可能绕过 Unix/Linux 的。在 Linux/Unix/Mac 系统中运行 <code>ps -ef</code> 命令可以看到当前系统中运行的进程，各个参数如下：</p> <ul><li>UID：执行该进程的用户 ID</li> <li>PID：进程编号</li> <li>PPID：该进程的父进程编号</li> <li>C：该进程所在的 CPU 利用率</li> <li>STIME：进程执行时间</li> <li>TTY：进程相关的终端类型</li> <li>TIME：进程所占用的 CPU 时间</li> <li>CMD：创建该进程的指令</li></ul> <p>关于进程以及操作系统一些更深入细节推荐阅读 APUE 即《Unix 高级编程》等书籍来了解。</p> <h2 id="进程与线程"><a href="#进程与线程" class="header-anchor">#</a> 进程与线程</h2> <h3 id="进程概念"><a href="#进程概念" class="header-anchor">#</a> 进程概念</h3> <p><strong>进程</strong>（Process）是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的<strong>基本单位</strong>，是操作系统结构的基础，进程是<strong>线程的容器</strong>。</p> <p>进程是资源分配的最小单位。</p> <p>我们启动一个服务、运行一个实例，就是开一个服务进程，例如 Java 里的 JVM 本身就是一个进程，Node.js 里通过 <code>node app.js</code> 开启一个服务进程，多进程就是进程的复制（fork），fork 出来的每个进程都拥有自己的独立空间地址、数据栈，一个进程无法访问另外一个进程里定义的变量、数据结构，只有建立了 IPC 通信，进程之间才可数据共享。</p> <h3 id="线程概念"><a href="#线程概念" class="header-anchor">#</a> 线程概念</h3> <p><strong>线程</strong>是操作系统能够进行运算调度的最小单位。</p> <p>首先我们要清楚线程是隶属于进程的，被包含于进程之中。<strong>一个线程只能隶属于一个进程，但是一个进程是可以拥有多个线程的</strong>。</p> <h4 id="单线程"><a href="#单线程" class="header-anchor">#</a> 单线程</h4> <p><strong>单线程就是一个进程只开一个线程</strong></p> <p>JavaScript 就是属于单线程，程序顺序执行（这里暂且不提 JavaScript 异步），可以想象一下队列，前面一个执行完之后，后面才可以执行，当你在使用单线程语言编码时切勿有过多耗时的同步操作，否则线程会造成阻塞，导致后续响应无法处理。你如果采用 JavaScript 进行编码时候，请尽可能的利用 JavaScript 异步操作的特性。</p> <p><strong>单线程的一些说明</strong></p> <ul><li>Node.js 虽然是单线程模型，但是其基于事件驱动、异步非阻塞模式，可以应用于高并发场景，避免了线程创建、线程之间上下文切换所产生的资源开销。</li> <li>当你的项目中需要有大量计算，CPU 耗时的操作时候，要注意考虑开启多进程来完成了。</li> <li>Node.js 开发过程中，错误会引起整个应用退出，应用的健壮性值得考验，尤其是错误的异常抛出，以及进程守护是必须要做的。</li> <li>单线程无法利用多核 CPU，但是后来 Node.js 提供的 API 以及一些第三方工具相应都得到了解决。</li></ul> <h2 id="node-js-中的进程与线程"><a href="#node-js-中的进程与线程" class="header-anchor">#</a> Node.js 中的进程与线程</h2> <p>Node.js 是 JavaScript 在服务端的运行环境，构建在 Chrome 的 V8 引擎之上，基于事件驱动、非阻塞 I/O 模型，充分利用操作系统提供的异步 I/O 进行多任务的执行，适合于 I/O 密集型的应用场景，因为异步，程序无需阻塞等待结果返回，而是基于回调通知的机制，原本同步模式等待的时间，则可以用来处理其它任务，</p> <blockquote><p>科普：在 Web 服务器方面，著名的 Nginx 也是采用此模式（事件驱动），避免了多线程的线程创建、线程上下文切换的开销，Nginx 采用 C 语言进行编写，主要用来做高性能的 Web 服务器，不适合做业务。</p></blockquote> <p>Web 业务开发中，如果你有高并发应用场景那么 Node.js 会是你不错的选择。</p> <p>在单核 CPU 系统之上我们采用 <code>单进程 + 单线程</code> 的模式来开发。在多核 CPU 系统之上，可以通过 <code>child_process.fork</code> 开启多个进程（Node.js 在 v0.8 版本之后新增了 <strong>Cluster</strong> 模块来实现多进程架构） ，即 <code>多进程 + 单线程</code> 模式。</p> <p>⚠️ <strong>注意</strong>：开启多进程不是为了解决高并发，主要是解决了单进程模式下 Node.js CPU 利用率不足的情况，充分利用多核 CPU 的性能。</p> <h3 id="node-js-中的进程"><a href="#node-js-中的进程" class="header-anchor">#</a> Node.js 中的进程</h3> <p>Node.js 中的进程 Process 是一个全局对象，无需 <code>require</code> 则可直接使用，给我们提供了当前进程中的相关信息。官方文档提供了详细的说明，感兴趣的可以亲自实践下 <a href="https://nodejs.org/dist/latest-v12.x/docs/api/process.html" target="_blank" rel="noopener noreferrer">Process<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <p>在 Node.js 程序中直接打印 <code>process</code> 可以直接获取非常多有用的属性以及方法：</p> <ul><li>进程基础信息</li> <li>进程 Usage</li> <li>进程级事件</li> <li>依赖模块/版本信息</li> <li>OS 基础信息</li> <li>账户信息</li> <li>信号收发</li> <li>三个标准流</li></ul> <h4 id="进程创建"><a href="#进程创建" class="header-anchor">#</a> 进程创建</h4> <p>进程创建有多种方式，主要使用 Node.js 的另外两个模块：<a href="/node-guidebook/process/child-process.html">child_process</a> 模块和 <a href="/node-guidebook/process/cluster.html">cluster</a> 模块。</p> <h5 id="child-process-模块"><a href="#child-process-模块" class="header-anchor">#</a> child_process 模块</h5> <p><code>child_process</code> 是 Node.js 的内置模块，用于创建子进程。</p> <p>几个常用函数： 四种方式：</p> <ul><li><code>child_process.spawn()</code>：适用于返回大量数据，例如图像处理，二进制数据处理。</li> <li><code>child_process.exec()</code>：适用于小量数据，maxBuffer 默认值为 200 * 1024 超出这个默认值将会导致程序崩溃，数据量过大可采用 spawn。</li> <li><code>child_process.execFile()</code>：类似 <code>child_process.exec()</code>，区别是不能通过 shell 来执行，不支持像 I/O 重定向和文件查找这样的行为</li> <li><code>child_process.fork()</code>： 衍生新的进程，进程之间是相互独立的，每个进程都有自己的 V8 实例、内存，系统资源是有限的，不建议衍生太多的子进程出来，通常根据系统 <strong>CPU 核心数</strong>设置。</li></ul> <p>CPU 核心数这里特别说明下，fork 确实可以开启多个进程，但是并不建议衍生出来太多的进程，CPU 核心数的获取方式 <code>const cpus = require('os').cpus();</code> 这里 <code>cpus</code> 返回一个对象数组，包含所安装的每个 CPU/内核的信息，二者总和的数组。假设主机装有两个 CPU，每个 CPU 有 4 个核，那么总核数就是 8。</p> <h5 id="cluster-模块"><a href="#cluster-模块" class="header-anchor">#</a> cluster 模块</h5> <p>Cluster 模块调用 fork 方法来创建子进程，该方法与 <code>child_process</code> 中的 fork 是同一个方法。 Cluster 模块采用的是经典的<strong>主从模型</strong>，Cluster 会创建一个 master，然后根据你指定的数量复制出多个子进程，可以使用 <code>cluster.isMaster</code> 属性判断当前进程是 master 还是 worker（工作进程）。由 master 进程来管理所有的子进程，主进程不负责具体的任务处理，主要工作是负责调度和管理。</p> <p>Cluster 模块使用内置的负载均衡来更好地处理线程之间的压力，该负载均衡使用了 <code>Round-robin</code> 算法（也被称之为循环算法）。当使用 Round-robin 调度策略时，master <code>accepts()</code> 所有传入的连接请求，然后将相应的 TCP 请求处理发送给选中的工作进程（该方式仍然通过 IPC 来进行通信）。</p> <p>开启多进程时候端口疑问讲解：如果多个 Node 进程监听同一个端口时会出现 <code>Error:listen EADDRIUNS</code> 的错误，而 cluster 模块为什么可以让多个子进程监听同一个端口呢？原因是 master 进程内部启动了一个 TCP 服务器，而真正监听端口的只有这个服务器，当来自前端的请求触发服务器的 connection 事件后，master 会将对应的 socket 句柄发送给子进程。</p> <h4 id="进程通信原理"><a href="#进程通信原理" class="header-anchor">#</a> 进程通信原理</h4> <p>前面讲解的无论是 child_process 模块，还是 cluster 模块，都需要主进程和工作进程之间的通信。通过 <code>fork()</code> 或者其他 API，创建子进程之后，为了实现父子进程之间的通信，父子进程之间才能通过 <code>message</code> 和 <code>send()</code> 传递信息。</p> <p>IPC 这个词我想大家并不陌生，不管那一种开发语言之遥提到进程通信，都会提到它。IPC 的全称是 Inter-Process Communication，即进程间通信。它的目的是为了让不同的进程能够互相访问资源并进行协调工作。实现进程间通信的技术有很多，如命名管道、匿名管道、Socket、信号量、共享内存、消息队列等。Node 中实现 IPC 通道是依赖于 libuv。Window 下由命名管道（name pipe）实现，*nix 系统则采用 Unix Domain Socket 实现。表现在应用层上的进程间通信只有简单的 message 事件和 <code>send()</code> 方法，接口十分简洁和消息化。</p> <img src="/node-guidebook/assets/img/ipc-creation.48477007.png" style="zoom:80%;"> <p>IPC 通信管道是如何创建的：</p> <img src="/node-guidebook/assets/img/ipc-pipe-creation.ea005cda.jpeg" style="zoom:80%;"> <p>父进程在实际创建子进程之前，会创建 IPC 通道并监听它，然后才真正的创建出子进程，这个进程中也会通过环境变量（NODE_CHANNEL_FD）告诉子进程这个 IPC 通道的文件描述符。子进程在启动的过程中，根据文件描述符去连接这个已存在的 IPC 通道，从而完成父子进程之间的连接。</p> <h4 id="句柄传递"><a href="#句柄传递" class="header-anchor">#</a> 句柄传递</h4> <p>讲句柄之前，先想一个问题，<code>send()</code> 句柄发送的时候，真的是将服务器对象发送给子进程？</p> <p><strong>子进程对象 send 方法可以发送的句柄类型</strong></p> <ul><li><code>net.Socket</code>：TCP 套接字</li> <li><code>net.Server</code>：TCP 服务器，任意建立在 TCP 服务上的应用层服务都可以享受它带来的好处</li> <li><code>net.Native</code>：C++ 层面的 TCP 套接字或 IPC 管道</li> <li><code>dgram.Socket</code>：UDP 套接字</li> <li><code>dgram.Native</code>：C++ 层面的 UDP 套接字</li></ul> <p><strong>send 句柄发送原理分析</strong></p> <p>结合句柄的发送与还原示意图更容易理解。</p> <img src="/node-guidebook/assets/img/send-handle.4180e119.jpeg" style="zoom:80%;"> <p><code>send()</code> 方法在将消息发送到 IPC 管道前，实际将消息组装成了两个对象，一个参数是 hadler，另一个是 message。message 参数如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  cmd<span class="token operator">:</span> <span class="token string">'NODE_HANDLE'</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token string">'net.Server'</span><span class="token punctuation">,</span>
  msg<span class="token operator">:</span> message
<span class="token punctuation">}</span>
</code></pre></div><p>发送到 IPC 管道中的实际上是我们要发送的句柄文件描述符。这个 message 对象在写入到 IPC 管道时，也会通过 <code>JSON.stringfy()</code> 进行序列化。所以最终发送到 IPC 通道中的信息都是字符串，<code>send()</code> 方法能发送消息和句柄并不意味着它能发送任何对象。</p> <p>连接了 IPC 通道的子线程可以读取父进程发来的消息，将字符串通过 <code>JSON.parse()</code> 解析还原为对象后，才触发 message 事件将消息传递给应用层使用。在这个过程中，消息对象还要被进行过滤处理，<code>message.cmd</code> 的值如果以 <code>NODE_</code> 为前缀，它将响应一个内部事件 <code>internalMessage</code>，如果 <code>message.cmd</code> 值为 NODE_HANDLE，它将取出 <code>message.type</code> 值和得到的文件描述符一起还原出一个对应的对象。</p> <p>以发送的 TCP 服务器句柄为例，子进程收到消息后的还原过程代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span>handle<span class="token punctuation">,</span>emit</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">net<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">emit</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这段还原代码，子进程根据 <code>message.type</code> 创建对应的 TCP 服务器对象，然后监听到文件描述符上。由于底层细节不被应用层感知，所以子进程中，开发者会有一种服务器对象就是从父进程中直接传递过来的错觉。</p> <blockquote><p>Node 进程之间只有消息传递，不会真正的传递对象，这种错觉是抽象封装的结果。目前 Node 只支持我前面提到的几种句柄，并非任意类型的句柄都能在进程之间传递，除非它有完整的发送和还原的过程。</p></blockquote> <h4 id="多进程架构模型"><a href="#多进程架构模型" class="header-anchor">#</a> 多进程架构模型</h4> <p>以下通过代码实现多进程架构模型示例：</p> <img src="/node-guidebook/assets/img/mutiprocess-architecture.5f8739c1.png" style="zoom:80%;"> <p><strong>主进程：</strong></p> <p><code>master.js</code> 主要处理以下逻辑：</p> <ul><li>创建一个 Server 并监听 3000 端口</li> <li>根据系统 CPUS 开启多个子进程</li> <li>通过子进程对象的 send 方法发送消息到子进程进行通信</li> <li>在主进程中监听了子进程的变化，如果是自杀信号重新启动一个工作进程</li> <li>主进程在监听到退出消息的时候，先退出子进程再退出主进程</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// master.js</span>
<span class="token keyword">const</span> fork <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fork<span class="token punctuation">;</span>
<span class="token keyword">const</span> cpus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'node-master'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> workers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">createWorker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>massage<span class="token punctuation">.</span>act <span class="token operator">===</span> <span class="token string">'suicide'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> signal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker process exited, code: %s signal: %s'</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> signal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> workers<span class="token punctuation">[</span>worker<span class="token punctuation">.</span>pid<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
  workers<span class="token punctuation">[</span>worker<span class="token punctuation">.</span>pid<span class="token punctuation">]</span> <span class="token operator">=</span> worker<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'worker process created, pid: %s ppid: %s'</span><span class="token punctuation">,</span> worker<span class="token punctuation">.</span>pid<span class="token punctuation">,</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpus<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> <span class="token function">close</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'SIGINT'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// kill(2) Ctrl-C</span>
process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'SIGQUIT'</span><span class="token punctuation">,</span> <span class="token function">close</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'SIGQUIT'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// kill(3) Ctrl-\</span>
process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">,</span> <span class="token function">close</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'SIGTERM'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// kill(15) default</span>
process<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token function">close</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进程退出'</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> pid <span class="token keyword">in</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'master process exited, kill worker pid:'</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      workers<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">.</span>kill<span class="token punctuation">[</span><span class="token string">'SIGINT'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>子进程：</strong></p> <p><code>worker.js</code> 子进程处理逻辑如下：</p> <ul><li>创建一个 Server 对象，注意这里最开始并没有监听 3000 端口</li> <li>通过 message 事件接收主进程 send 方法发送的消息</li> <li>监听 uncaughtException 事件，捕获未处理的异常，发送自杀信息由主进程重建进程，子进程在链接关闭之后退出</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// worker.js</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'I am worker, pid:'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>pid <span class="token operator">+</span> <span class="token string">', ppid:'</span> <span class="token operator">+</span> process<span class="token punctuation">.</span>ppid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 测试异常进程退出、重启</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'worker process exception!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> worker<span class="token punctuation">;</span>
process<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'node-worker'</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'messsage'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> sendHandle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token string">'server'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    worker <span class="token operator">=</span> sendHandle<span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      server<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'uncaguhtException'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> act<span class="token operator">:</span> <span class="token string">'suicide'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  worker<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="进程守护"><a href="#进程守护" class="header-anchor">#</a> 进程守护</h4> <p><strong>什么是进程守护？</strong></p> <p>每次启动 Node.js 程序都需要在命令窗口输入命令 <code>node app.js</code> 才能启动，但如果把命令窗口关闭则 Node.js 程序服务就会立刻断掉。除此之外，当我们这个 Node.js 服务意外奔溃了就不能自动重启进程了。这些现象都不是我们想要看到的，所以需要通过某些方式来守护这个开启的进程，执行 <code>node app.js</code> 开启一个服务进程之后，我们还可以在这个终端上做些别的事情，且不会相互影响，当出现问题可以自动重启。</p> <p><strong>如何实现进程守护</strong></p> <p>这里只说一些第三方的进程守护框架，<a href="https://pm2.keymetrics.io/" target="_blank" rel="noopener noreferrer">pm2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://github.com/foreversd/forever#readme" target="_blank" rel="noopener noreferrer">forever<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它们都可以实现进程守护，底层也都是通过上面讲的 child_process 模块和 cluster 模块实现的，这里就不再提它们的原理。</p> <h4 id="linux-关闭进程"><a href="#linux-关闭进程" class="header-anchor">#</a> Linux 关闭进程</h4> <p>通过 Linux 命令查找进程</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> server
</code></pre></div><p>杀死进程</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 优雅的方式</span>
<span class="token comment"># -l 选项告诉 kill 命令用好像启动进程的用户已注销的方式结束进程</span>
<span class="token comment"># 当使用该选项时，kill 命令也试图杀死所留下的子进程</span>
<span class="token comment"># 但这个命令也不是总能成功，或许仍然需要先手工杀死子进程，然后再杀死父进程</span>
<span class="token function">kill</span> -l <span class="token punctuation">[</span>PID<span class="token punctuation">]</span>

<span class="token comment"># kill 命令用于终止进程</span>
<span class="token comment"># -9 表示强迫进程立即停止</span>
<span class="token function">kill</span> -9 <span class="token punctuation">[</span>PID<span class="token punctuation">]</span>

<span class="token comment"># 杀死同一进程内的所有进程</span>
<span class="token comment"># 其允许指定要终止的进程名称，而非 PID</span>
<span class="token function">killall</span> httpd
</code></pre></div><h3 id="线程"><a href="#线程" class="header-anchor">#</a> 线程</h3> <h4 id="关于单线程的误区"><a href="#关于单线程的误区" class="header-anchor">#</a> 关于单线程的误区</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'测试进程'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进程ID：'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上述代码中创建了 HTTP 服务，开启了一个进程，都说 Node.js 是单线程，所以 Node.js 启动后线程数应该为 1，但是为什么会开启了 7 个线程呢？</p> <p>Node.js 中最核心的是 V8 引擎，会创建 V8 的实例，这个实例是多线程的。</p> <ul><li>主线程：编译、执行代码</li> <li>编译/优化线程：在主线程执行的时候，可以优化代码</li> <li>分析器线程：记录分析代码运行时间，为 Crankshaft 优化代码执行提供依据</li> <li>垃圾回收的几个线程</li></ul> <p>所以大家常说的 Node.js 是单线程的指的是 JavaScript 的执行是单线程的（开发者编写的代码运行在单线程环境中），但 JavaScript 的宿主环境，无论是 Node.js 还是浏览器都是多线程的因为 libuv 中有线程池的概念存在的，libuv 会通过类似线程池的实现来模拟不同操作系统的异步调用，这对开发者来说是不可见的。</p> <h4 id="存在异步-i-o-占用额外线程"><a href="#存在异步-i-o-占用额外线程" class="header-anchor">#</a> 存在异步 I/O 占用额外线程</h4> <p>还是上面的例子，我们在定时器执行的同时，去读一个文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>线程数量变成了 11 个，这是因为在 Node 中有一些 I/O 操作（DNS，FS）和一些 CPU 密集计算（Zlib，Crypto）会启用 Node 的线程池，而线程池默认大小为 <strong>4</strong>，因此线程数变成了 11。</p> <p>我们可以手动更改线程池默认大小：</p> <div class="language-js extra-class"><pre class="language-js"><code>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UV_THREADPOOL_SIZE</span> <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
</code></pre></div><p>码一行代码轻松把线程变成 71。</p> <p><strong>Libuv</strong></p> <p>Libuv 是一个跨平台的异步 I/O 库，它结合了 UNIX 下的 libev 和 Windows 下的 IOCP 的特性，最早由 Node 的作者开发，专门为 Node 提供多平台下的异步 I/O 支持。Libuv 本身是由 C++ 语言实现的，Node 中的非阻塞 I/O 以及事件循环的底层机制都是由 libuv 实现的。</p> <p>在 Window 环境下，libuv 直接使用 Windows 的 IOCP 来实现异步 IO。在非 Windows 环境下，libuv 使用多线程来模拟异步 I/O。</p> <p>⚠️ 注意下面我要说的话，Node 的异步调用是由 libuv 来支持的，以上面的读取文件的例子，读文件实质的系统调用是由 libuv 来完成的，Node 只是负责调用 libuv 的接口，等数据返回后再执行对应的回调方法。</p> <h4 id="线程创建"><a href="#线程创建" class="header-anchor">#</a> 线程创建</h4> <p>直到 Node 10.5.0 的发布，官方才给出了一个实验性质的模块 worker_threads 给 Node 提供真正的多线程能力。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
  isMainThread<span class="token punctuation">,</span>
  parentPort<span class="token punctuation">,</span>
  workerData<span class="token punctuation">,</span>
  threadId<span class="token punctuation">,</span>
  MessageChannel<span class="token punctuation">,</span>
  MessagePort<span class="token punctuation">,</span>
  Worker<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'worker_threads'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">{</span> workerData<span class="token operator">:</span> i <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">main: worker stopped with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    worker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">main: receive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker: workerDate </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workerData<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  parentPort<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker: receive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>workerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">mainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">workerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码在主线程中开启五个子线程，并且主线程向子线程发送简单的消息。</p> <p>由于 worker_thread 目前仍然处于实验阶段，所以启动时需要增加 <code>--experimental-worker flag</code>，运行后观察活动监视器，开启了 5 个子线程。</p> <p><strong>worker_thread 模块</strong></p> <p><a href="https://github.com/nodejs/node/blob/master/lib/worker_threads.js" target="_blank" rel="noopener noreferrer">worker_thread 核心代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>worker_thread 模块中有 4 个对象和 2 个类，可以自己去看上面的源码。</p> <ul><li>isMainThread: 是否是主线程，源码中是通过 threadId === 0 进行判断的。</li> <li>MessagePort: 用于线程之间的通信，继承自 EventEmitter。</li> <li>MessageChannel: 用于创建异步、双向通信的通道实例。</li> <li>threadId: 线程 ID。</li> <li>Worker: 用于在主线程中创建子线程。第一个参数为 filename，表示子线程执行的入口。</li> <li>parentPort: 在 worker 线程里是表示父进程的 MessagePort 类型的对象，在主线程里为 null</li> <li>workerData: 用于在主进程中向子进程传递数据（data 副本）</li></ul> <h2 id="多进程-vs-多线程"><a href="#多进程-vs-多线程" class="header-anchor">#</a> 多进程 vs 多线程</h2> <table><thead><tr><th>属性</th> <th>多进程</th> <th>多线程</th> <th>比较</th></tr></thead> <tbody><tr><td>数据</td> <td>数据共享复杂，需要用 IPC；数据是分开的，同步简单</td> <td>因为共享进程数据，数据共享简单，同步复杂</td> <td>各有千秋</td></tr> <tr><td>CPU、内存</td> <td>占用内存多，切换复杂，CPU 利用率低</td> <td>占用内存少，切换简单，CPU 利用率高</td> <td>多线程更好</td></tr> <tr><td>销毁、切换</td> <td>创建销毁、切换复杂，速度慢</td> <td>创建销毁、切换简单，速度很快</td> <td>多线程更好</td></tr> <tr><td>coding</td> <td>编码简单、调试方便</td> <td>编码、调试复杂</td> <td>编码、调试复杂</td></tr> <tr><td>可靠性</td> <td>进程独立运行，不会互相影响</td> <td>线程同呼吸共命运</td> <td>多进程更好</td></tr> <tr><td>分布式</td> <td>可用于多机多核分布式，易于扩展</td> <td>只能用于多核分布式</td> <td>多进程更好</td></tr></tbody></table> <hr> <p><strong>参考资料：</strong></p> <ul><li><a href="https://github.com/ElemeFE/node-interview/blob/master/sections/zh-cn/process.md#process" target="_blank" rel="noopener noreferrer">📖 饿了么大前端 Node.js 面试指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://taobaofed.org/blog/2015/11/03/nodejs-cluster/" target="_blank" rel="noopener noreferrer">📝 淘宝前端团队 Cluster 讲解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">1/5/2020, 3:13:54 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/node-guidebook/io/path.html" class="prev">路径</a></span> <span class="next"><a href="/node-guidebook/process/child-process.html">子进程</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node-guidebook/assets/js/app.b56de1e6.js" defer></script><script src="/node-guidebook/assets/js/2.9a9b2fe1.js" defer></script><script src="/node-guidebook/assets/js/4.675c3702.js" defer></script>
  </body>
</html>
