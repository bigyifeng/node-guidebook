(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[45],{Z9XG:function(e,n,t){"use strict";t.r(n);var a=t("q1tI"),l=t.n(a),c=(t("B2uJ"),t("+su7"),t("qOys")),r=t.n(c);t("5Yjd");n["default"]=function(){return l.a.createElement(l.a.Fragment,null,l.a.createElement("div",{className:"markdown"},l.a.createElement("h1",{id:"\u4e2d\u95f4\u4ef6-middleware"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u4e2d\u95f4\u4ef6-middleware"},l.a.createElement("span",{className:"icon icon-link"})),"\u4e2d\u95f4\u4ef6 Middleware"),l.a.createElement("p",null,"\u4e2d\u95f4\u4ef6\uff08",l.a.createElement("code",null,"pre")," \u548c ",l.a.createElement("code",null,"post")," \u94a9\u5b50\uff09\u662f\u5728\u5f02\u6b65\u51fd\u6570\u6267\u884c\u65f6\u51fd\u6570\u4f20\u5165\u7684\u63a7\u5236\u51fd\u6570\u3002"),l.a.createElement("p",null,"Mongoose 4.x \u6709\u56db\u79cd\u4e2d\u95f4\u4ef6\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,"document \u4e2d\u95f4\u4ef6"),l.a.createElement("li",null,"model \u4e2d\u95f4\u4ef6"),l.a.createElement("li",null,"aggregate \u4e2d\u95f4\u4ef6"),l.a.createElement("li",null,"query \u4e2d\u95f4\u4ef6")),l.a.createElement("p",null,"\u5bf9\u4e8e document \u4e2d\u95f4\u4ef6\uff0c",l.a.createElement("code",null,"this")," \u6307\u5411\u5f53\u524d document\u3002"),l.a.createElement("p",null,"Document \u4e2d\u95f4\u4ef6\u652f\u6301\u4ee5\u4e0b document \u64cd\u4f5c\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"init")),l.a.createElement("li",null,l.a.createElement("code",null,"validate")),l.a.createElement("li",null,l.a.createElement("code",null,"save")),l.a.createElement("li",null,l.a.createElement("code",null,"remove"))),l.a.createElement("p",null,"\u5bf9\u4e8e ",l.a.createElement("code",null,"query")," \u4e2d\u95f4\u4ef6\uff0c",l.a.createElement("code",null,"this")," \u6307\u5411\u5f53\u524d ",l.a.createElement("code",null,"query"),"\u3002"),l.a.createElement("p",null,"Query \u4e2d\u95f4\u4ef6\u652f\u6301\u4ee5\u4e0b Model \u548c Query \u64cd\u4f5c\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"count")),l.a.createElement("li",null,l.a.createElement("code",null,"find")),l.a.createElement("li",null,l.a.createElement("code",null,"findOne")),l.a.createElement("li",null,l.a.createElement("code",null,"findOneAndRemove")),l.a.createElement("li",null,l.a.createElement("code",null,"findOneAndUpdate")),l.a.createElement("li",null,l.a.createElement("code",null,"update"))),l.a.createElement("p",null,"Aggregate \u4e2d\u95f4\u4ef6\u4f5c\u7528\u4e8e ",l.a.createElement("code",null,"MyModel.aggregate()"),"\uff0c\u5b83\u4f1a\u5728\u4f60\u5bf9 aggregate \u5bf9\u8c61\u8c03\u7528 ",l.a.createElement("code",null,"exec()")," \u6267\u884c\u3002\u5bf9\u4e8e aggregate \u4e2d\u95f4\u4ef6\uff0c",l.a.createElement("code",null,"this")," \u6307\u5411\u5f53\u524d ",l.a.createElement("code",null,"aggregation")," \u5bf9\u8c61\u3002"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"aggregate"))),l.a.createElement("p",null,"\u5bf9\u4e8e Model \u4e2d\u95f4\u4ef6\uff0c",l.a.createElement("code",null,"this")," \u6307\u5411\u5f53\u524d model\u3002"),l.a.createElement("p",null,"Model \u4e2d\u95f4\u4ef6\u652f\u6301\u4ee5\u4e0b Model \u64cd\u4f5c\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,l.a.createElement("code",null,"insertMany"))),l.a.createElement("p",null,"\u6240\u6709\u4e2d\u95f4\u4ef6\u652f\u6301 ",l.a.createElement("code",null,"pre")," \u548c ",l.a.createElement("code",null,"post")," \u94a9\u5b50\u3002"),l.a.createElement("p",null,"\u26a0\ufe0f ",l.a.createElement("strong",null,"\u6ce8\u610f"),"\uff1aQuery \u662f\u6ca1\u6709 ",l.a.createElement("code",null,"remove()")," \u94a9\u5b50\u7684\uff0c\u53ea\u6709 document \u6709\uff0c\u5982\u679c\u4f60\u8bbe\u5b9a\u4e86 ",l.a.createElement("code",null,"remove")," \u94a9\u5b50\uff0c\u4ed6\u5c06\u4f1a\u5728\u4f60\u8c03\u7528 ",l.a.createElement("code",null,"myDoc.remove()"),"\uff08\u800c\u4e0d\u662f ",l.a.createElement("code",null,"MyModel.remove()"),"\uff09\u65f6\u89e6\u53d1\u3002"),l.a.createElement("h2",{id:"pre"},l.a.createElement("a",{"aria-hidden":"true",href:"#pre"},l.a.createElement("span",{className:"icon icon-link"})),"Pre"),l.a.createElement("p",null,l.a.createElement("code",null,"pre")," \u94a9\u5b50\u5206\u4e32\u884c\u548c\u5e76\u884c\u4e24\u79cd\u3002"),l.a.createElement("h3",{id:"\u4e32\u884c"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u4e32\u884c"},l.a.createElement("span",{className:"icon icon-link"})),"\u4e32\u884c"),l.a.createElement("p",null,"\u4e32\u884c\u4e2d\u95f4\u4ef6\u662f\u4e00\u4e2a\u63a5\u4e00\u4e2a\u5730\u6267\u884c\u3002"),l.a.createElement("p",null,"\u5177\u4f53\u6765\u8bf4\uff0c\u4e0a\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u8c03\u7528 ",l.a.createElement("code",null,"next")," \u51fd\u6570\u65f6\uff0c\u4e0b\u4e00\u4e2a\u6267\u884c\u3002"),l.a.createElement(r.a,{code:"const schema = new Schema(..);\n\nschema.pre('save', function(next){\n    // do stuff\n    next();\n})\n",lang:"js"}),l.a.createElement("p",null,l.a.createElement("code",null,"next()")," \u4e0d\u4f1a\u963b\u6b62\u5269\u4f59\u4ee3\u7801\u8fd0\u884c\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u63d0\u65e9 ",l.a.createElement("code",null,"return")," \u6a21\u5f0f\u963b\u6b62 ",l.a.createElement("code",null,"next()")," \u540e\u9762\u7684\u4ee3\u7801\u8fd0\u884c\u3002"),l.a.createElement(r.a,{code:"const schema = new Schema(..);\n\nschema.pre('save', function(next){\n    if (foo()){\n        console.log('calling next!')\n        // `return next()` will make sure the rest of this function does't run\n        /* return */\n        next();\n    }\n    // Unless you comment out the `return` above, 'after next' will print\n    console.log('after next');\n})\n",lang:"js"}),l.a.createElement("h3",{id:"\u5e76\u884c"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u5e76\u884c"},l.a.createElement("span",{className:"icon icon-link"})),"\u5e76\u884c"),l.a.createElement("p",null,"\u5e76\u884c\u4e2d\u95f4\u4ef6\u63d0\u4f9b\u7ec6\u7c92\u5ea6\u6d41\u63a7\u5236\u3002"),l.a.createElement(r.a,{code:"const schema = new Schema(..);\n\n// `true` means this is a parallel middleware. You **must** specify `true`\n// as the second parameter if you want to use parallel middleware.\nschema.pre('save', true, function(next, done){\n    // calling next kicks off the next middleware in parallel\n    next();\n    setTimeout(done, 100);\n})\n",lang:"js"}),l.a.createElement("p",null,"\u5728\u8fd9\u4e2a\u793a\u4f8b\u4e2d\uff0c",l.a.createElement("code",null,"save")," \u65b9\u6cd5\u5c06\u5728\u6240\u6709\u4e2d\u95f4\u4ef6\u90fd\u8c03\u7528\u4e86 ",l.a.createElement("code",null,"done")," \u7684\u65f6\u5019\u624d\u4f1a\u6267\u884c\u3002"),l.a.createElement("h3",{id:"\u4f7f\u7528\u573a\u666f"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u4f7f\u7528\u573a\u666f"},l.a.createElement("span",{className:"icon icon-link"})),"\u4f7f\u7528\u573a\u666f"),l.a.createElement("p",null,"\u4e2d\u95f4\u4ef6\u5bf9\u539f\u5b50\u5316\u6a21\u578b\u903b\u8f91\u5f88\u6709\u5e2e\u52a9\u3002\u8fd9\u91cc\u6709\u4e00\u4e9b\u5176\u5b83\u5efa\u8bae\uff1a"),l.a.createElement("ul",null,l.a.createElement("li",null,"\u590d\u6742\u7684\u6570\u636e\u6821\u9a8c"),l.a.createElement("li",null,"\u5220\u9664\u4f9d\u8d56\u6587\u6863\uff08\u5220\u9664\u7528\u6237\u540e\u5220\u9664\u4ed6\u7684\u6240\u6709\u6587\u7ae0\uff09"),l.a.createElement("li",null,"asynchronous defaults"),l.a.createElement("li",null,"asynchronous tasks that a certain action triggers")),l.a.createElement("h3",{id:"\u9519\u8bef\u5904\u7406"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u9519\u8bef\u5904\u7406"},l.a.createElement("span",{className:"icon icon-link"})),"\u9519\u8bef\u5904\u7406"),l.a.createElement("p",null,"\u5982\u679c ",l.a.createElement("code",null,"pre")," \u94a9\u5b50\u51fa\u9519\uff0cmongoose \u5c06\u4e0d\u4f1a\u6267\u884c\u540e\u9762\u7684\u51fd\u6570\u3002Mongoose \u4f1a\u5411\u56de\u8c03\u51fd\u6570\u4f20\u5165 ",l.a.createElement("code",null,"err")," \u53c2\u6570\uff0c\u6216\u8005 ",l.a.createElement("code",null,"reject")," \u8fd4\u56de\u7684 Promise\u3002"),l.a.createElement("p",null,"\ud83c\udf30 ",l.a.createElement("strong",null,"\u793a\u4f8b\uff1a")),l.a.createElement(r.a,{code:"schema.pre('save', funciton(next){\n    const err = new Error('something went wrong');\n    // If you call `next()` with an argument, that argument is assumed to be\n    next(err);\n})\n\nschema.pre('save', function(){\n    // You can also return a promise that rejects\n    return new Promise((resolve, reject) => {\n        reject(new Error('something went wrong'));\n    })\n})\n\nschema.pre('save', function(){\n    // You can also return a promise that rejects\n    throw new Error('something went wrong')\n})\n\nschema.pre('save', function(){\n    await Promise.resolve();\n    // You can also throw an error in an `async` function\n    throw new Error('something went wrong');\n})\n\n// later...\n\n// Changes will not be persisted to MongoDB becasue a pre hook errored out\nmyDoc.save(function(err){\n    console.log(err.message);\n    // something went wrong\n})\n",lang:"js"}),l.a.createElement("p",null,"\u591a\u6b21\u8c03\u7528 ",l.a.createElement("code",null,"next()")," \u662f\u65e0\u6548\u7684\u3002\u5982\u679c\u4f60\u8c03\u7528 ",l.a.createElement("code",null,"next()")," \u5e26\u6709\u9519\u8bef\u53c2\u6570 ",l.a.createElement("code",null,"err1"),"\uff0c\u7136\u540e\u4f60\u518d\u629b\u4e00\u4e2a ",l.a.createElement("code",null,"err2"),"\uff0cmongoose \u53ea\u4f1a\u4f20\u9012 ",l.a.createElement("code",null,"err1"),"\u3002"),l.a.createElement("h2",{id:"post"},l.a.createElement("a",{"aria-hidden":"true",href:"#post"},l.a.createElement("span",{className:"icon icon-link"})),"Post"),l.a.createElement("p",null,l.a.createElement("code",null,"post")," \u4e2d\u95f4\u4ef6\u5728\u65b9\u6cd5\u6267\u884c\u4e4b\u540e \u8c03\u7528\uff0c\u8fd9\u4e2a\u65f6\u5019\u6bcf\u4e2a pre \u4e2d\u95f4\u4ef6\u90fd\u5df2\u7ecf\u5b8c\u6210\u3002"),l.a.createElement(r.a,{code:"schema.post('init', function(doc) {\n  console.log('%s has been initialized from the db', doc._id);\n});\n\nschema.post('validate', function(doc) {\n  console.log('%s has been validated (but not saved yet)', doc._id);\n});\n\nschema.post('save', function(doc) {\n  console.log('%s has been saved', doc._id);\n});\n\nschema.post('remove', function(doc) {\n  console.log('%s has been removed', doc._id);\n});\n",lang:"js"}),l.a.createElement("h2",{id:"\u5f02\u6b65-post-\u94a9\u5b50"},l.a.createElement("a",{"aria-hidden":"true",href:"#\u5f02\u6b65-post-\u94a9\u5b50"},l.a.createElement("span",{className:"icon icon-link"})),"\u5f02\u6b65 post \u94a9\u5b50"),l.a.createElement("p",null,"\u5982\u679c\u4f60\u7ed9\u56de\u8c03\u51fd\u6570\u4f20\u5165\u4e24\u4e2a\u53c2\u6570\uff0cMongoose \u4f1a\u8ba4\u4e3a\u7b2c\u4e8c\u4e2a\u53c2\u6570\u662f ",l.a.createElement("code",null,"next()")," \u51fd\u6570\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 ",l.a.createElement("code",null,"next")," \u89e6\u53d1\u4e0b\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u3002"),l.a.createElement(r.a,{code:"// Takes 2 parameters: this is an asynchronous post hook\nschema.post('save', function(doc, next) {\n  setTimeout(function() {\n    console.log('post1');\n    // Kick off the second post hook\n    next();\n  }, 10);\n});\n\n// Will not execute until the first middleware calls `next()`\nschema.post('save', function(doc, next) {\n  console.log('post2');\n  next();\n});\n",lang:"js"})))}}}]);