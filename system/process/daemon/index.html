<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>守护进程</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">概览</a><a href="/node-guidebook//engine">引擎</a><a aria-current="page" class="active" href="/node-guidebook//system">系统</a><a href="/node-guidebook//network">网络</a><a href="/node-guidebook//server-application">服务端应用</a><a href="/node-guidebook//util-application">工具应用</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">概览</a></li><li><a href="/node-guidebook//engine">引擎</a></li><li><a aria-current="page" class="active" href="/node-guidebook//system">系统</a></li><li><a href="/node-guidebook//network">网络</a></li><li><a href="/node-guidebook//server-application">服务端应用</a></li><li><a href="/node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a aria-current="page" class="active" href="/node-guidebook//system/process">进程</a><ul><li><a href="/node-guidebook//system/process/process"><span>进程</span></a></li><li><a href="/node-guidebook//system/process/child-process"><span>子进程</span></a></li><li><a href="/node-guidebook//system/process/cluster"><span>集群</span></a></li><li><a href="/node-guidebook//system/process/ipc"><span>进程间通信</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//system/process/daemon"><span>守护进程</span></a></li><li><a href="/node-guidebook//system/process/multiple-process-architecture"><span>多进程架构模型</span></a></li></ul></li><li><a href="/node-guidebook//system/io">异步 I/O</a><ul><li><a href="/node-guidebook//system/io/io"><span>概述</span></a></li><li><a href="/node-guidebook//system/io/buffer"><span>Buffer 缓冲器</span></a></li><li><a href="/node-guidebook//system/io/stream"><span>Stream 流</span></a></li><li><a href="/node-guidebook//system/io/readable-stream"><span>ReadableStream 可读流</span></a></li><li><a href="/node-guidebook//system/io/writable-stream"><span>WritableStream 可写流</span></a></li><li><a href="/node-guidebook//system/io/duplex-stream"><span>DuplexStream 双工流</span></a></li><li><a href="/node-guidebook//system/io/transform-stream"><span>TransformStream 转换流</span></a></li><li><a href="/node-guidebook//system/io/string-decoder"><span>StringDecoder 字符串解码</span></a></li><li><a href="/node-guidebook//system/io/path"><span>Path 路径</span></a></li><li><a href="/node-guidebook//system/io/filesystem"><span>File 文件系统</span></a></li><li><a href="/node-guidebook//system/io/console"><span>Console 控制台</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="原因" data-depth="2" class=""><a href="/node-guidebook//system/process/daemon#原因"><span>原因</span></a></li><li title="实现方式" data-depth="2" class=""><a href="/node-guidebook//system/process/daemon#实现方式"><span>实现方式</span></a></li><li title="实现步骤" data-depth="3" class=""><a href="/node-guidebook//system/process/daemon#实现步骤"><span>实现步骤</span></a></li><li title="setsid 详解" data-depth="3" class=""><a href="/node-guidebook//system/process/daemon#setsid-详解"><span>setsid 详解</span></a></li><li title="实现过程" data-depth="3" class=""><a href="/node-guidebook//system/process/daemon#实现过程"><span>实现过程</span></a></li><li title="守护进程总结" data-depth="2" class=""><a href="/node-guidebook//system/process/daemon#守护进程总结"><span>守护进程总结</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="守护进程"><a aria-hidden="true" href="#守护进程"><span class="icon icon-link"></span></a>守护进程</h1><p>守护进程是后台运行不受终端控制的进程（如输入、输出等），一般的网络服务都是以守护进程的方式运行。</p><h2 id="原因"><a aria-hidden="true" href="#原因"><span class="icon icon-link"></span></a>原因</h2><p>守护进程脱离终端的主要原因两点：</p><ol><li>用户启动守护进程的终端在启动守护进程之后，需要执行其他任务</li><li>如其他用户登录该终端后，以前的守护进程的错误信息不应出现，由终端上的一些键所产生的信号（如中断信号），不应以前从该终端上启动的任何守护进程造成影响</li></ol><h2 id="实现方式"><a aria-hidden="true" href="#实现方式"><span class="icon icon-link"></span></a>实现方式</h2><h3 id="实现步骤"><a aria-hidden="true" href="#实现步骤"><span class="icon icon-link"></span></a>实现步骤</h3><ol><li>父进程通过 <code>fork</code> 等方法创建子进程</li><li>在子进程中创建新回话（调用系统函数 setsid）</li><li>改变子进程工作目录（如：<code>&quot;/&quot;</code> 或 <code>&quot;/usr&quot;</code> 等）</li><li>父进程终止，子进程由 init 进程接管</li></ol><h3 id="setsid-详解"><a aria-hidden="true" href="#setsid-详解"><span class="icon icon-link"></span></a>setsid 详解</h3><p><code>setsid</code> 主要完成三件事：</p><ol><li>该进程完成一个新会话的会话领导</li><li>该进程编程一个进程组的组长</li><li>该进程没有控制终端</li></ol><p>然而，Nodejs 中并没有对 <code>setsid</code> 方法的直接封装，翻阅文档发现有一个地方是可以调用该方法的。</p><h3 id="实现过程"><a aria-hidden="true" href="#实现过程"><span class="icon icon-link"></span></a>实现过程</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const spawn = require(&#x27;child_process&#x27;).spawn;
let server = null;

function startServer() {
  console.log(&#x27;restart server&#x27;);

  server = spawn(&#x27;node&#x27;, [&#x27;app.js&#x27;]);
  console.log(&#x27;node js pid is&#x27; + server.pid);

  server.on(&#x27;close&#x27;, function(code, signal) {
    server.kill(signal);
    server = startServer();
  });

  server.on(&#x27;error&#x27;, function(code, signal) {
    server.kill(signal);
    server = startServer();
  });

  return server;
}

startServer();
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> spawn </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;child_process&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">spawn</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;restart server&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token string">&#x27;node&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;app.js&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;node js pid is&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> server</span><span class="token punctuation">.</span><span class="token property-access">pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token parameter punctuation">,</span><span class="token parameter"> signal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server</span><span class="token punctuation">.</span><span class="token method function property-access">kill</span><span class="token punctuation">(</span><span class="token plain">signal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  server</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token parameter punctuation">,</span><span class="token parameter"> signal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server</span><span class="token punctuation">.</span><span class="token method function property-access">kill</span><span class="token punctuation">(</span><span class="token plain">signal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    server </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> server</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><a href="https://cnodejs.org/topic/57adfadf476898b472247eac" target="_blank" rel="noopener noreferrer">守护进程实现（Node.js 版本）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://github.com/ElemeFE/node-interview/blob/master/sections/zh-cn/process.md#%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B" target="_blank" rel="noopener noreferrer">守护进程实现（C 语言版本）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><h2 id="守护进程总结"><a aria-hidden="true" href="#守护进程总结"><span class="icon icon-link"></span></a>守护进程总结</h2><p>在实际工作中对于守护进程并不陌生，例如 PM2、Egg-Cluster 等，以上只是一个简单的 Demo 对守护进程做了一个说明，在实际工作中对守护进程的健壮性要求还是很高的，例如：进程的异常监听、工作进程管理调度、进程挂掉之后重启等等，这些还需要我们去不断思考。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/system/process/daemon.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__system__process__daemon.md.js"></script>
  </body>
</html>
