<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>WritableStream 可写流</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">概览</a><a href="/node-guidebook//engine">引擎</a><a aria-current="page" class="active" href="/node-guidebook//system">系统</a><a href="/node-guidebook//network">网络</a><a href="/node-guidebook//server-application">服务端应用</a><a href="/node-guidebook//util-application">工具应用</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">概览</a></li><li><a href="/node-guidebook//engine">引擎</a></li><li><a aria-current="page" class="active" href="/node-guidebook//system">系统</a></li><li><a href="/node-guidebook//network">网络</a></li><li><a href="/node-guidebook//server-application">服务端应用</a></li><li><a href="/node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/node-guidebook//system/process">进程</a><ul><li><a href="/node-guidebook//system/process/process"><span>进程</span></a></li><li><a href="/node-guidebook//system/process/child-process"><span>子进程</span></a></li><li><a href="/node-guidebook//system/process/cluster"><span>集群</span></a></li><li><a href="/node-guidebook//system/process/ipc"><span>进程间通信</span></a></li><li><a href="/node-guidebook//system/process/daemon"><span>守护进程</span></a></li><li><a href="/node-guidebook//system/process/multiple-process-architecture"><span>多进程架构模型</span></a></li></ul></li><li><a aria-current="page" class="active" href="/node-guidebook//system/io">异步 I/O</a><ul><li><a href="/node-guidebook//system/io/io"><span>概述</span></a></li><li><a href="/node-guidebook//system/io/buffer"><span>Buffer 缓冲器</span></a></li><li><a href="/node-guidebook//system/io/stream"><span>Stream 流</span></a></li><li><a href="/node-guidebook//system/io/readable-stream"><span>ReadableStream 可读流</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//system/io/writable-stream"><span>WritableStream 可写流</span></a></li><li><a href="/node-guidebook//system/io/duplex-stream"><span>DuplexStream 双工流</span></a></li><li><a href="/node-guidebook//system/io/transform-stream"><span>TransformStream 转换流</span></a></li><li><a href="/node-guidebook//system/io/string-decoder"><span>StringDecoder 字符串解码</span></a></li><li><a href="/node-guidebook//system/io/path"><span>Path 路径</span></a></li><li><a href="/node-guidebook//system/io/filesystem"><span>File 文件系统</span></a></li><li><a href="/node-guidebook//system/io/console"><span>Console 控制台</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="实现过程" data-depth="2" class=""><a href="/node-guidebook//system/io/writable-stream#实现过程"><span>实现过程</span></a></li><li title="自定义可写流" data-depth="3" class=""><a href="/node-guidebook//system/io/writable-stream#自定义可写流"><span>自定义可写流</span></a></li><li title="管道流" data-depth="2" class=""><a href="/node-guidebook//system/io/writable-stream#管道流"><span>管道流</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="可写流"><a aria-hidden="true" href="#可写流"><span class="icon icon-link"></span></a>可写流</h1><p>可写流（Writable Streams）是对数据写入目的地的一种抽象，用来消费上游流过来的数据，通过可写流程可以把数据写入设备，常见的可写流是本地磁盘文件写入和 TCP、HTTP 等网络响应。</p><p>可写流的原理其实与可读流类似，当数据过来的时候会写入缓存池，当写入的速度很慢或者写入暂停时候，数据流便会进入到队列池缓存起来，当然即使缓存池满了，剩余的数据也是存在内存。</p><p>在 Node.js 中属于可读流的接口：</p><ul><li>HTTP Request on the client 客户端请求</li><li>HTTP Response on the server 服务器响应</li><li>fs write streams 文件</li><li>zlib streams 压缩</li><li>crypto streams 加密</li><li>TCP sockets TCP 服务器</li><li>child process stdin 子进程标准输入</li><li>process.stdout / process.stderr 标准输出，错误输出</li></ul><h2 id="实现过程"><a aria-hidden="true" href="#实现过程"><span class="icon icon-link"></span></a>实现过程</h2><p>通过实现简单版的 WritableStream 更好地了解可写流。</p><ol><li>通过相关模块接口可以创建 WritableStreams 实例，例如 <code>fs.createWriteStream</code></li><li><code>highWaterMark</code> 用于设置 WritableStreams 可写缓冲区的大小，默认为 16KB，当 <code>正在写入数据+缓冲区数据长度</code> 超过 <code>highWaterMark</code> 的值时，会触发 <code>drain</code> 事件</li><li>可写流 <code>write</code> 和 <code>end</code> 方法知恩那个写字符串或 Buffer 类型的数据</li><li>并行写，顺序不会乱</li><li>通过一个字节的缓冲区 <code>hightWaterMark = 1</code>，写入一个 10 个数</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const EventEmitter = require(&#x27;events&#x27;);
const fs = require(&#x27;fs&#x27;);

/**
 * 可写流需要考虑并发写的问题，比如并发写时，要确保写的顺序不错乱
 * 为了保证并发写顺序不会乱，WriteStream 创建了一个链表结构缓冲区
 * 用来按顺序缓存待写的内容，等待当前正在写的内容写完，再依次从缓冲区中一个一个读取出来继续写
 */
class Node {
  constructor(element) {
    this.element = element;
    this.next = null;
  }
}

class LinkList {
  constructor() {
    this.head = null;
    this.length = 0;
  }
  append(chunk) {
    let node = new Node(chunk);
    // 链表头
    if (this.head === null) {
        this.head = node;
    } else {
      // 找到最后一个把当前节点放到后面去
      let current = this.head;
      while(current.next) {
        current = current.next;
      }
      current.next = node;
    }
    this.length++;
  }
  get() {
    let head = this.head;
    if (!head) return;
    this.head = head.next;
    this.length--;
    return head.element;
  }
}

module.exports = class WritableStream extends EventEmitter {
  constructor(path, options) {
    super();
    // 写入文件的路径
    this.path = path;
    // 标识，写入文件要做的操作
    this.flags = options.flags || &#x27;w&#x27;;
    // 水位线，一次可写入缓存中的字节
    this.highWaterMark = options.highWaterMark || 16 * 1024;
    // 写入完毕是否关闭
    this.autoClose = options.autoClose || true;
    this.start = options.start || 0;
    this.mode = options.mode || 0o666;
    // 编码
    this.encoding = options.encoding || &#x27;utf8&#x27;;

    // 表示当前是否正在写入
    this._writing = false;
    // 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中
    this.cache = new LinkList();
    // 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true
    // 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时
    this.needDrain = false;
    // 写入的位置的偏移量
    this.pos = this.start;
    // 打开文件准备写入
    this.open();

    // 用来统计 缓冲区 + 正在写入的内容的个数
    this.len = 0;
  }

  // 只能写字符串或 Buffer 类型的数据
  write(chunk, encoding = this.encoding, callback) {
    chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk);
    this.legn += chunk.length;
    let flag = this.len &lt; this.highWaterMark;

    // 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件
    this.needDrain = !flag;

    if(this._writing) {
      // 当前正在写，将待写内容保存到缓冲区中
      this.cache.append({
        chunk,
        encoding,
        callback
      });
    } else {
      // 真正的写入逻辑
      this._writing = true;
      this._write(chunk, encoding, () =&gt; {
        callback &amp;&amp; callback();
        // 从缓冲区中取出一个出来写
        this.clearBuffer();
      })
    }
    // true：没有超过 highWaterMark（可以继续写）
    // false：超过 highWaterMark（不能继续写了）
    return flag;
  }

  clearBuffer() {
    // 依此从链表中取出一个出来写
    let obj = this.cache.get();
    if (obj) {
      this._write(obj.chunk, obj.encoding, () =&gt; {
        obj.callback &amp;&amp; obj.callback();
        this.clearBuffer();
      })
    } else {
        // obj 为 undefined 说明缓冲区已经清空完毕
      this._writing = false;
      if (this.needDrain) {
        // 当 needDrain 为 true 时，需要触发 drain 事件
            this.needDrain = false;
            this.emit(&#x27;drain&#x27;);
      }
    }
  }

  open() {
    fs.open(this.path, this.flags, (err, fd) =&gt; {
      this.fd = fd;
      this.emit(&#x27;open&#x27;, fd);
    })
  }

  _write(chunk, encoding, clearBuffer) {
    if (typeof this.fd !== &#x27;number&#x27;) {
      // 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写
      return this.once(&#x27;open&#x27;, () =&gt; this._write(chunk, encoding, clearBuffer))
    }
    fs.write(this.fd, chunk, 0, chunk.length, this.pos, (err, written) =&gt; {
      this.pos += written;
      this.len -= written;
      // 每次写入成功就从缓冲区中依次取出一个出来继续写
      clearBuffer();
    })
  }

  destroy(err) {
    fs.close(this.fd, () =&gt; {
      this.emit(&#x27;close&#x27;, err);
    }
  }

  // end 相当于 write + close
  end(data) {
    this.write(data, &#x27;utf8&#x27;, () =&gt; {
        this.destroy();
    });
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">EventEmitter</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;events&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token doc-comment comment"></span></div><div class="token-line"><span class="token doc-comment comment">/**</span></div><div class="token-line"><span class="token doc-comment comment"> * 可写流需要考虑并发写的问题，比如并发写时，要确保写的顺序不错乱</span></div><div class="token-line"><span class="token doc-comment comment"> * 为了保证并发写顺序不会乱，WriteStream 创建了一个链表结构缓冲区</span></div><div class="token-line"><span class="token doc-comment comment"> * 用来按顺序缓存待写的内容，等待当前正在写的内容写完，再依次从缓冲区中一个一个读取出来继续写</span></div><div class="token-line"><span class="token doc-comment comment"> */</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> element</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">LinkList</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">append</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 链表头</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 找到最后一个把当前节点放到后面去</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> head </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">head</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> head</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token operator">--</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> head</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">module</span><span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">WritableStream</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 写入文件的路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 标识，写入文件要做的操作</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;w&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 水位线，一次可写入缓存中的字节</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 写入完毕是否关闭</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">0o666</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 编码</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 表示当前是否正在写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">LinkList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 写入的位置的偏移量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 打开文件准备写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 用来统计 缓冲区 + 正在写入的内容的个数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 只能写字符串或 Buffer 类型的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter keyword">this</span><span class="token parameter punctuation">.</span><span class="token parameter">encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    chunk </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">isBuffer</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> chunk </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">legn</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> flag </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">flag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 当前正在写，将待写内容保存到缓冲区中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token punctuation">.</span><span class="token method function property-access">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        chunk</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        encoding</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        callback</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 真正的写入逻辑</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">,</span><span class="token plain"> encoding</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        callback </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 从缓冲区中取出一个出来写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// true：没有超过 highWaterMark（可以继续写）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// false：超过 highWaterMark（不能继续写了）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> flag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 依此从链表中取出一个出来写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> obj </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">.</span><span class="token property-access">chunk</span><span class="token punctuation">,</span><span class="token plain"> obj</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        obj</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> obj</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// obj 为 undefined 说明缓冲区已经清空完毕</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 当 needDrain 为 true 时，需要触发 drain 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;drain&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> fd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fd</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> fd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> clearBuffer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">,</span><span class="token plain"> encoding</span><span class="token punctuation">,</span><span class="token plain"> clearBuffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> chunk</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> written</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> written</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">-=</span><span class="token plain"> written</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 每次写入成功就从缓冲区中依次取出一个出来继续写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token punctuation">,</span><span class="token plain"> err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// end 相当于 write + close</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">end</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>关键点分析：</p><ol><li><p>WritableStream 需要继承 EventEmitter。比如 <code>drain</code>、<code>close</code>、<code>error</code> 等事件都是基于 EventEmitter 实现的。</p></li><li><p>构建一个链表结构的缓冲区，这里为什么不采用数组呢，因为在 WritableStream 中，每次都是从缓冲区中取出第一个数据出来写，如果是数组的话，每次 pop 一个数据出来后，需要设计到数组的重排，因此这里采用链表的结构明显性能比较高。</p></li><li><p>定义一个属性 <code>_writing</code> 来保存当前是否正在写的状态，当 <code>_writing</code> 为 <code>true</code> 时，代表当前正在写入，当 <code>writing</code> 为 <code>false</code> 时，代表当前没有在写入。</p></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 表示当前是否正在写入
this._writing = false;
" data-status="copy"></button><div class="token-line"><span class="token comment">// 表示当前是否正在写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="4"><li><p>可写流的特点就是第一次 <code>write</code> 是真正的写，之后的 <code>write</code> 会被保存到缓冲区中，等当前的数据写完再从缓冲区中按顺序读出来继续写</p></li><li><p>定义一个属性 <code>needDrain</code>，代表是否需要触发 <code>drain</code> 事件。当<strong>缓冲区的长度和正在写入的长度</strong>达到了期望的值 <code>highWaterMark</code> 时，设置为 <code>needDrain</code> 为 <code>true</code></p></li><li><p>WritableStream 默认会先 <code>open</code> 文件</p></li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="class WritableStream extends EventEmitter {
  constructor(path, options) {
    super();
    this.path = path;
    this.flags = options.flags || &#x27;w&#x27;;
    this.highWaterMark = options.highWaterMark || 16 * 1024;
    this.autoClose = options.autoClose || true;
    this.start = options.start || 0;
    this.mode = options.mode || 0o666;
    this.encoding = options.encoding || &#x27;utf8&#x27;;

    // 表示当前是否正在写入
    this._writing = false;
    // 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中
    this.cache = new LinkList();
    // 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true
    // 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时
    this.needDrain = false;
    // 写入的位置的偏移量
    this.pos = this.start;
    // 打开文件准备写入
    this.open();

    // 用来统计 缓冲区 + 正在写入的内容的个数
    this.len = 0;
  }

  open() {
      fs.open(this.path, this.flags, (err, fd) =&gt; {
      this.fd = fd;
      this.emit(&#x27;open&#x27;, fd);
    })
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">WritableStream</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;w&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">16</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">0o666</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 表示当前是否正在写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 缓冲区，如果当前正在写，就把待写入的内容放到缓冲区中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">LinkList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 只有当前消耗掉了和期望值相等或者大于期望值的时候，设置成 true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 当缓存区的内容 + 正在写入的内容超过 highWaterMark 时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 写入的位置的偏移量</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 打开文件准备写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 用来统计 缓冲区 + 正在写入的内容的个数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      fs</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> fd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fd</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> fd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="7"><li>实现 <code>write</code> 方法</li></ol><p>所有可写流都需要实现 <code>stream.Writable</code> 类定义的接口，<code>write</code> 是 <code>stream.Writable</code> 的一个方法，在 <code>write</code> 方法内部会调用子类（WritableStream）的 <code>_write</code>，本文为了方便理解，把 <code>write</code> 的逻辑包含在了 WriteStream 中</p><p><code>write</code> 主要实现的功能如下：</p><p>7-1. 将 chunk 统一转化为 Buffer 类型</p><p>7-2. 将 <code>_writing</code> 判断当前是否正在写，如果是，将数据存到缓冲区中，否则，调用 <code>_write</code> 进行真正的写数据</p><p>7-3. <code>write</code> 函数返回一个 <code>flat</code> 状态，代表目前缓冲区内的数据长度是否小于 <code>highWaterMark</code>，是则可以继续写，不是则不能继续写，并且会触发 <code>drain</code> 事件</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 只能写 字符串 或 Buffer 类型的数据
write(chunk, encoding = this.encoding, callback) {
    chunk = Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk);
    this.legn += chunk.length;
    let flag = this.len &lt; this.highWaterMark;

    // 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件
    this.needDrain = !flag;

    if(this._writing) {
      // 当前正在写，将待写内容保存到缓冲区中
      this.cache.append({
        chunk,
        encoding,
        callback
      });
    } else {
      // 真正的写入逻辑
      this._writing = true;
      this._write(chunk, encoding, () =&gt; {
        callback &amp;&amp; callback();
        // 从缓冲区中取出一个出来写
        this.clearBuffer();
      })
    }
    // true：没有超过 highWaterMark（可以继续写）
    // false：超过 highWaterMark（不能继续写了）
    return flag;
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// 只能写 字符串 或 Buffer 类型的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter keyword">this</span><span class="token parameter punctuation">.</span><span class="token parameter">encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    chunk </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">isBuffer</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> chunk </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">legn</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> flag </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 当 len &gt;= highWaterMark 时，设置 needDrain 为 true，需要触发 drain 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">flag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 当前正在写，将待写内容保存到缓冲区中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token punctuation">.</span><span class="token method function property-access">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        chunk</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        encoding</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        callback</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 真正的写入逻辑</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">,</span><span class="token plain"> encoding</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        callback </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 从缓冲区中取出一个出来写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// true：没有超过 highWaterMark（可以继续写）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// false：超过 highWaterMark（不能继续写了）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> flag</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ol start="8"><li>实现 <code>_write</code> 函数</li></ol><p>可写流必须实现 <code>stream.Writable</code> 的 <code>writable._write()</code> 或 <code>writable._writev()</code> 方法。</p><p>这里实现 <code>writable._write()</code> 方法。</p><p>关键点：</p><p>8-1. 要确保 <code>fs.open</code> 打开成功后拿到 fd 才能开始写</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="_write(chunk, encoding, clearBuffer) {
    if (typeof this.fd !== &#x27;number&#x27;) {
      // 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写
      return this.once(&#x27;open&#x27;, () =&gt; this._write(chunk, encoding, clearBuffer))
    }
}
" data-status="copy"></button><div class="token-line"><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> clearBuffer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">,</span><span class="token plain"> encoding</span><span class="token punctuation">,</span><span class="token plain"> clearBuffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>8-2. 当写完此次 chunk 的数据后，需要从缓冲区取出一个出来继续写，直到清空缓冲区里的数据</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="_write(chunk, encoding, clearBuffer) {
    if (typeof this.fd !== &#x27;number&#x27;) {
    // 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写
    return this.once(&#x27;open&#x27;, () =&gt; this._write(chunk, encoding, clearBuffer))
  }

  fs.write(this.fd, chunk, 0, chunk.length, this.pos, (err, written) =&gt; {
    this.pos += written;
    this.len -= written
    clearBuffer(); // 每次写入成功就从缓冲区中依次取出一个出来继续写
  });
}

// 依次从链表中取出一个出来写
clearBuffer() {
  let obj = this.cache.get();
  if (obj) {
    this._write(obj.chunk, obj.encoding, () =&gt; {
      obj.callback &amp;&amp; obj.callback();
      this.clearBuffer();
    })
  } else {
    // obj 为 undefined 说明缓冲区已经清空完毕
    // 表示当前没有在写，下次再调用 write 可以直接向文件中写入
    this._writing = false;
    if (this.needDrain) {
      // 当 needDrain 为 true 时，需要触发 drain 事件
      this.needDrain = false;
      this.emit(&#x27;drain&#x27;);
    }
  }
}
" data-status="copy"></button><div class="token-line"><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> clearBuffer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 由于 fs.open 操作是异步的，所以这里要保证 fs.open 文件打开完毕，再开始写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">,</span><span class="token plain"> encoding</span><span class="token punctuation">,</span><span class="token plain"> clearBuffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  fs</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> chunk</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> chunk</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> written</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> written</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">len</span><span class="token plain"> </span><span class="token operator">-=</span><span class="token plain"> written</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 每次写入成功就从缓冲区中依次取出一个出来继续写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 依次从链表中取出一个出来写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> obj </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cache</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_write</span><span class="token punctuation">(</span><span class="token plain">obj</span><span class="token punctuation">.</span><span class="token property-access">chunk</span><span class="token punctuation">,</span><span class="token plain"> obj</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      obj</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> obj</span><span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// obj 为 undefined 说明缓冲区已经清空完毕</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 表示当前没有在写，下次再调用 write 可以直接向文件中写入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_writing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 当 needDrain 为 true 时，需要触发 drain 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">needDrain</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;drain&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="自定义可写流"><a aria-hidden="true" href="#自定义可写流"><span class="icon icon-link"></span></a>自定义可写流</h3><p>因为 <code>createWriteStream</code> 内部调用了 WriteStream 累，WriteStream 又实现了 Writable 接口，WriteStream 实现了 <code>_write()</code> 方法，所以我们通过自定义一个类继承 <code>stream</code> 模块的 Writable，并在原型上自定义一个 <code>_write()</code> 就可以自定义自己的可写流。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="let { Writable } = require(&#x27;stream&#x27;);

class MyWrite extends Writable {
  _write(chunk, encoding, callback) {
    // write() 第一个参数，写入的数据
    console.log(chunk);
    // 这个 callback，就相当于我们上面的 clearBuffer 方法，如果不执行 callback 就不会继续从缓存中取出写
    callback();
  }
}

let write = new MyWrite();
write.write(&#x27;1&#x27;, &#x27;utf8&#x27;, () =&gt; {
  console.log(&#x27;ok&#x27;);
})
" data-status="copy"></button><div class="token-line"><span class="token keyword">let</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">Writable</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;stream&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">MyWrite</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">Writable</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token parameter punctuation">,</span><span class="token parameter"> encoding</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// write() 第一个参数，写入的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">chunk</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 这个 callback，就相当于我们上面的 clearBuffer 方法，如果不执行 callback 就不会继续从缓存中取出写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> write </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">MyWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">write</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token string">&#x27;1&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;ok&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="管道流"><a aria-hidden="true" href="#管道流"><span class="icon icon-link"></span></a>管道流</h2><p>管道流（pipe），是可读流上的方法，至于为什么放到这里，主要是因为需要 2 个流的基础知识，是可读流配合可写流的一种<strong>传输方式</strong>。如果用原来的读写，因为写比较耗时，所以会多读少写，耗内存，但用了 <code>pipe</code> 就不会了，始终用规定的内存。</p><p><strong>用法</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = require(&#x27;fs&#x27;);
// pipe 方法叫管道，可以控制速率
let rs = fs.createReadStream(&#x27;./r.txt&#x27;, {
  highWaterMark: 4
});
let ws = fs.createWriteStream(&#x27;./w.txt&#x27;, {
  highWaterMark: 1
});
// 会监听 rs 的 on(&#x27;data&#x27;) 将读取到的数据，通过 ws.write 的方法写入文件
// 调用写的一个方法，返回 boolean 类型
// 如果返回 false 就调用 rs 的 pause 方法，暂停读取
// 等待可写流，写入完毕再监听 drain resume rs
rs.pipe(ws); // 会控制速率，防止淹没可用内存
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// pipe 方法叫管道，可以控制速率</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> rs </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#x27;./r.txt&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  highWaterMark</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> ws </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&#x27;./w.txt&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  highWaterMark</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 会监听 rs 的 on(&#x27;data&#x27;) 将读取到的数据，通过 ws.write 的方法写入文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 调用写的一个方法，返回 boolean 类型</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果返回 false 就调用 rs 的 pause 方法，暂停读取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 等待可写流，写入完毕再监听 drain resume rs</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token plain">ws</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 会控制速率，防止淹没可用内存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><strong>实现</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = requir(&#x27;fs&#x27;);
// 这两个是自定义实现的 ReadStream 和 WriteStream
const ReadStream = require(&#x27;./ReadStream&#x27;);
const WriteStream = require(&#x27;./WriteStream&#x27;);

// 如果用原来的读写；因为写比较耗时，所以会多读少写，耗内存
ReadStream.prototype.pipe = function(dest){
  this.on(&#x27;data&#x27;, (data) =&gt; {
    let flag = dest.write(data);
    // 如果写入的时候嘴巴吃满了就不继续读了，暂停
    if (!flag) {
      this.pause();
    }
  })
  // 如果写的时候嘴巴里的吃完了，就会继续读
  dest.on(&#x27;drain&#x27;, () =&gt; {
    this.resume();
  });
  this.on(&#x27;end&#x27;, () =&gt; {
    this.destroy();
    // 清空缓存中的数据
    fs.fsync(dest.fd, () =&gt; {
      dest.destory();
    })
  })
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requir</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 这两个是自定义实现的 ReadStream 和 WriteStream</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ReadStream</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./ReadStream&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">WriteStream</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./WriteStream&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果用原来的读写；因为写比较耗时，所以会多读少写，耗内存</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token class-name">ReadStream</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">pipe</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dest</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> flag </span><span class="token operator">=</span><span class="token plain"> dest</span><span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果写入的时候嘴巴吃满了就不继续读了，暂停</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">flag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果写的时候嘴巴里的吃完了，就会继续读</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  dest</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;drain&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 清空缓存中的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">fsync</span><span class="token punctuation">(</span><span class="token plain">dest</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      dest</span><span class="token punctuation">.</span><span class="token method function property-access">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/5ab4d31ff265da2391480e4b" target="_blank" rel="noopener noreferrer">Node.js Writable Stream 的实现简析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="http://www.cxdsimple.com/blog/20191210/5cab01ec.html" target="_blank" rel="noopener noreferrer">📝 Node WriteStream 可写流的实现原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/system/io/writable-stream.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__system__io__writable-stream.md.js"></script>
  </body>
</html>
