<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/node-guidebook/umi.css" />
    <script>
      window.routerBase = "/node-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.19
    </script>
    <title>ReadableStream 可读流</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//">Node Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/node-guidebook//overview">概览</a><a href="/node-guidebook//engine">引擎</a><a aria-current="page" class="active" href="/node-guidebook//system">系统</a><a href="/node-guidebook//network">网络</a><a href="/node-guidebook//server-application">服务端应用</a><a href="/node-guidebook//util-application">工具应用</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/node-guidebook-favicon.svg&#x27;)" href="/node-guidebook//"></a><h1>Node Guidebook</h1><p>Node 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/node-guidebook//overview">概览</a></li><li><a href="/node-guidebook//engine">引擎</a></li><li><a aria-current="page" class="active" href="/node-guidebook//system">系统</a></li><li><a href="/node-guidebook//network">网络</a></li><li><a href="/node-guidebook//server-application">服务端应用</a></li><li><a href="/node-guidebook//util-application">工具应用</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/node-guidebook//system/process">进程</a><ul><li><a href="/node-guidebook//system/process/process"><span>进程</span></a></li><li><a href="/node-guidebook//system/process/child-process"><span>子进程</span></a></li><li><a href="/node-guidebook//system/process/cluster"><span>集群</span></a></li><li><a href="/node-guidebook//system/process/ipc"><span>进程间通信</span></a></li><li><a href="/node-guidebook//system/process/daemon"><span>守护进程</span></a></li><li><a href="/node-guidebook//system/process/multiple-process-architecture"><span>多进程架构模型</span></a></li></ul></li><li><a aria-current="page" class="active" href="/node-guidebook//system/io">异步 I/O</a><ul><li><a href="/node-guidebook//system/io/io"><span>概述</span></a></li><li><a href="/node-guidebook//system/io/buffer"><span>Buffer 缓冲器</span></a></li><li><a href="/node-guidebook//system/io/stream"><span>Stream 流</span></a></li><li><a aria-current="page" class="active" href="/node-guidebook//system/io/readable-stream"><span>ReadableStream 可读流</span></a></li><li><a href="/node-guidebook//system/io/writable-stream"><span>WritableStream 可写流</span></a></li><li><a href="/node-guidebook//system/io/duplex-stream"><span>DuplexStream 双工流</span></a></li><li><a href="/node-guidebook//system/io/transform-stream"><span>TransformStream 转换流</span></a></li><li><a href="/node-guidebook//system/io/string-decoder"><span>StringDecoder 字符串解码</span></a></li><li><a href="/node-guidebook//system/io/path"><span>Path 路径</span></a></li><li><a href="/node-guidebook//system/io/filesystem"><span>File 文件系统</span></a></li><li><a href="/node-guidebook//system/io/console"><span>Console 控制台</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="读取模式" data-depth="2" class=""><a href="/node-guidebook//system/io/readable-stream#读取模式"><span>读取模式</span></a></li><li title="流动模式" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#流动模式"><span>流动模式</span></a></li><li title="暂停模式" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#暂停模式"><span>暂停模式</span></a></li><li title="实现原理" data-depth="2" class=""><a href="/node-guidebook//system/io/readable-stream#实现原理"><span>实现原理</span></a></li><li title="doRead" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#doread"><span>doRead</span></a></li><li title="push" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#push"><span>push</span></a></li><li title="end" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#end"><span>end</span></a></li><li title="readable" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#readable"><span>readable</span></a></li><li title="实现过程" data-depth="2" class=""><a href="/node-guidebook//system/io/readable-stream#实现过程"><span>实现过程</span></a></li><li title="流动模式原理" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#流动模式原理"><span>流动模式原理</span></a></li><li title="暂停模式原理" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#暂停模式原理"><span>暂停模式原理</span></a></li><li title="Readable" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#readable-1"><span>Readable</span></a></li><li title="自定义可读流" data-depth="3" class=""><a href="/node-guidebook//system/io/readable-stream#自定义可读流"><span>自定义可读流</span></a></li><li title="运行全流程" data-depth="2" class=""><a href="/node-guidebook//system/io/readable-stream#运行全流程"><span>运行全流程</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="可读流"><a aria-hidden="true" href="#可读流"><span class="icon icon-link"></span></a>可读流</h1><p>可读流（Readable Streams）是对提供数据的源头（source）的抽象。</p><p>在 Node.js 中属于可读流的具体实现形式：</p><ul><li>客户端的 HTTP 响应</li><li>服务端的 HTTP 请求</li><li><code>fs</code> 模块的 read streams 读取流</li><li><code>zlib</code> 压缩流</li><li><code>crypto</code> 加密流</li><li>TCP Sockets</li><li>子进程 stdout 与 stderr 子进程标准输出和错误输出</li><li>process.stdin 标准输入</li></ul><p>所有的 Readable 都实现了 <code>stream.Readable</code> 类定义的接口。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const Readable = stream.Readable;
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Readable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> stream</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Readable</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>实现了 <code>stream.Readable</code> 接口的对象，将对象的数据读取为流数据，当监听 <code>data</code> 事件后，开始发射（emit）数据。</p><p>🌰 <strong>示例：读取文件流创建</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const rs = fs.createReadStream(path, {
    // 打开文件要做的操作，默认 &#x27;r&#x27;
    flags: &#x27;r&#x27;,
    encoding: null,
    // 开始读取的索引位置
    start: &#x27;0&#x27;,
    // 结束读取的索引位置（包括结束位置）
    end: &#x27;&#x27;,
    // 读取缓存区默认的大小的阀值 64KB（水位线）
    highWaterMark: &#x27;&#x27;
})

// 监听 data 事件，流自动切换到流动模式
// 数据会尽可能快地读出
rs.on(&#x27;data&#x27;, function(data){
    console.log(data);
});

// 数据读取完毕后触发 end 事件
rs.on(&#x27;end&#x27;, function(){
    consolel.log(&#x27;读取完毕&#x27;)
});

// 可读流打开事件
rs.on(&#x27;open&#x27;, function(){
    consolel.log(&#x27;读取完毕&#x27;)
});

// 可读流关闭事件
rs.on(&#x27;close&#x27;, function(er){
    console.log(&#x27;&#x27;)
})；

// 指定编码和上面创建流时的参数 encoding 意思相同
rs.setEncoding(&#x27;utf8&#x27;);

rs.on(&#x27;data&#x27;, function(data){
    // 可读流暂停读取
    rs.pause();
    console.log(data);
});

setTimeout(function(){
    // 可读流恢复读取
    rs.resume();
}, 2000);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> rs </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token plain">path</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 打开文件要做的操作，默认 &#x27;r&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    flags</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;r&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    encoding</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 开始读取的索引位置</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    start</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;0&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 结束读取的索引位置（包括结束位置）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    end</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 读取缓存区默认的大小的阀值 64KB（水位线）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    highWaterMark</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 监听 data 事件，流自动切换到流动模式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 数据会尽可能快地读出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 数据读取完毕后触发 end 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    consolel</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;读取完毕&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 可读流打开事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    consolel</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;读取完毕&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 可读流关闭事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">er</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain">；</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 指定编码和上面创建流时的参数 encoding 意思相同</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">setEncoding</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 可读流暂停读取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rs</span><span class="token punctuation">.</span><span class="token method function property-access">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 可读流恢复读取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    rs</span><span class="token punctuation">.</span><span class="token method function property-access">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="读取模式"><a aria-hidden="true" href="#读取模式"><span class="icon icon-link"></span></a>读取模式</h2><p>Readable Streams 存在两种模式<strong>流动模式</strong>（flowing mode）和<strong>暂停模式</strong>（paused mode），这两种模式决定了 chunk 数据流动的方式：<strong>自动流动</strong>和<strong>手工流动</strong>。</p><p>可读流对象 <code>stream.Readable</code> 中有一个维护状态的对象 <code>readable._readableState</code>，这里简称为 <code>state</code>。其中有一个标记，<code>state.flowing</code>，可用来判别流的模式。它有三种可能值：</p><ul><li><code>true</code> 表示流动模式</li><li><code>false</code> 表示暂停模式</li><li><code>null</code> 初始状态</li></ul><ol><li><strong>流动模式</strong>（flowing mode）：数据自动从系统底层读取，形成<strong>流动</strong>现象，并通过事件，尽可能快地提供给应用程序。监听流的 <code>data</code> 事件便可进入该模式</li><li><strong>暂停模式</strong>（paused mode）：需要显式地调用 <code>stream.readable.read</code> 方法，触发 <code>data</code> 事件以消耗流数据。</li></ol><p>那么如何触发或相互转化这两种模式呢：</p><ul><li><p><strong>可读流都开始于暂停模式</strong></p></li><li><p><strong>暂停模式切换到流动模式（flowing）</strong></p><ul><li>监听 <code>data</code> 事件</li><li>调用 <code>stream.resume</code> 方法</li><li>调用 <code>stream.pipe</code> 方法将数据发送到 Writable</li></ul></li><li><p><strong>流动模式切换到暂停模式（paused）</strong></p><ul><li>移除 <code>data</code> 事件</li><li>如果没有管道目标，调用 <code>stream.pause</code> 方法</li><li>如果有管道目标，调用 <code>stream.unpipe</code> 移除多个管道目标，并取消 <code>data</code> 事件监听</li></ul></li></ul><p>如果 <code>stream.Readable</code> 切换到 flowing 模式，且没有消费者处理流中的数据，这些数据将会丢失。比如，调用了 <code>readable.resume()</code> 方法切没有监听 <code>data</code> 事件，或是取消 <code>data</code> 事件监听，就有可能出现这种情况。</p><p>可以想象家用热水器的模型，热水器的水箱（Buffer 缓存区）里面存储着热水（数据），在我们用热水的时候，开启水龙头，自来水会不断地进入水箱，再从水箱由水龙头流出来供我们使用。这就是进入了 flowing 模式。当我们关闭水龙头的时候，水箱则会暂停进水，水龙头也会暂停出水，这就是 paused 模式。</p><p>默认情况下我们在创建流对象之后它会处于暂停模式。</p><p>在暂停模式下，我们必须显式调用 <code>stream.readable.read</code> 方法来从流中读取数据片段，而流动模式下数据就会不断地被读出，当然这里要注意的是流动模式下数据并不是直接流向至应用，背后其实还存在一个缓存池，而池的大小是在我们创建读流对象时定义的，每次读取时最多读取的字节数不会超过池的大小，打个比方，如果有 9 个字节要读取，池的大小为 3 字节，那么就会分三次读入，在流动模式下，可以调用 <code>pause</code> 方法回到暂停模式，<code>resume</code> 方法再次回到流动模式。</p><p>在暂停模式中，我们可以监听 <code>readable</code> 事件，它将会在流有数据可供读取时触发，但是这不是一个自动读取的过程，它需要我们自己去调用 <code>read</code> 方法来读取数据，在监听这个事件时，默认会将缓存区先填满一次，每当缓存区读完时，这个 <code>readable</code> 事件就会再被触发，并且每次调用 <code>read</code> 方法时都会去检测一次缓存区的长度是否小于水口（HighWaterMark）大小，如果小于的话再读取一段水口大小的数据放入缓存区中。另外要注意一点的事有时候我们调用 <code>read</code> 时读取的大小可能会超过缓存区的大小，这个时候默认就会更改缓存区的大小到一个适合现在读取量的大小，然后再重新出发 <code>readable</code> 事件。</p><h3 id="流动模式"><a aria-hidden="true" href="#流动模式"><span class="icon icon-link"></span></a>流动模式</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = require(&#x27;fs&#x27;);
const path = require(&#x27;path&#x27;);
const rs = fs.createReadStream(path.join(__dirname, &#x27;./1.txt&#x27;));

rs.setEncoding(&#x27;utf8&#x27;);

rs.on(&#x27;data&#x27;, data =&gt; {
  console.log(data);
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> rs </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token plain">path</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;./1.txt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">setEncoding</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">data</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="暂停模式"><a aria-hidden="true" href="#暂停模式"><span class="icon icon-link"></span></a>暂停模式</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = require(&#x27;fs&#x27;);
const path = require(&#x27;path&#x27;);
const rs = fs.createReadStream(path.join(__dirname, &#x27;./index.txt&#x27;));

rs.setEncoding(&#x27;utf8&#x27;);

rs.on(&#x27;readable&#x27;, () =&gt; {
  let res = rs.read();
  console.log(&#x27;res&#x27;);
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;path&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> rs </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token plain">path</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token plain">__dirname</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;./index.txt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">setEncoding</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;readable&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> res </span><span class="token operator">=</span><span class="token plain"> rs</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;res&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="实现原理"><a aria-hidden="true" href="#实现原理"><span class="icon icon-link"></span></a>实现原理</h2><p>创建可读流时，需要集成 Readable 对象，并实现 <code>_read</code> 方法。</p><p><img src="/node-guidebook/static/readable-flow.a48afc4e.jpeg"/></p><p><code>_read</code> 方法是从底层系统读取具体数据的逻辑，即生产数据的逻辑。</p><p>在 <code>_read</code> 方法中，通过调用 <code>push(data)</code> 将数据放入可读流中供下游消耗。在 <code>_read</code> 方法中，可以同步调用 <code>push(data)</code>，也可以异步调用。当全部数据都生产出来后，必须调用 <code>push(null)</code> 来结束可读流。流一旦结束，便不能再调用 <code>push(data)</code> 添加数据。可以通过监听 <code>data</code> 事件的方式消耗可读流。</p><p>在首次监听其 <code>data</code> 事件后，readable 便会持续不断地调用 <code>_read()</code>，通过触发 <code>data</code> 事件将数据输出。第一次 <code>data</code> 事件会在下一个 tick 中触发，所以，可以安全地将数据输出前的逻辑放在事件监听后（同一个 tick 中）。当数据全部被消耗时，会触发 <code>end</code> 事件。</p><p><img src="/node-guidebook/static/readable-flow-detail.14a1e152.jpeg"/></p><p>通过流读取数据</p><ul><li>使用 Readable 构造函数创建实例对象 readable 后，便得到了一个可读流</li><li>如果实现 <code>_read</code> 方法，就将流连接到一个底层数据源</li><li>流通过调用 <code>_read</code> 向底层请求数据，底层再调用流的 <code>push</code> 方法将需要的数据传递过来</li><li>当 readable 连接了数据源后，下游便可以调用 <code>readable.read(n)</code> 向流请求数据，同时监听 readable 的 <code>data</code> 事件来接收取到的数据</li></ul><h3 id="doread"><a aria-hidden="true" href="#doread"><span class="icon icon-link"></span></a>doRead</h3><p>流中维护了一个缓存，当缓存中的数据足够多时，调用 <code>read()</code> 不会引起 <code>_read()</code> 的调用，即不需要向底层请求数据。用 <code>doRead</code> 来表示 <code>read(n)</code> 是否需要向底层取数据。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const doRead = state.needReadable;

if (state.length === 0 || state.length - n &lt; state.highWaterMark) {
  doRead = true;
}

if (state.ended || statte.reading) {
  doRead = false;
}

if (doRead) {
  satte.reading = true;
  state.sync = true;
  if (state.length === 0) {
    state.needReadable = true;
  }
  this._read(state.highWaterMark);
  state.sync = false;
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> doRead </span><span class="token operator">=</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">needReadable</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> n </span><span class="token operator">&lt;</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  doRead </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">ended</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> statte</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  doRead </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">doRead</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  satte</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  state</span><span class="token punctuation">.</span><span class="token property-access">sync</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    state</span><span class="token punctuation">.</span><span class="token property-access">needReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_read</span><span class="token punctuation">(</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  state</span><span class="token punctuation">.</span><span class="token property-access">sync</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>当缓存区的长度为 0 或者缓存区的数量小于 <code>state.highWaterMark</code> 这个阀值，则会调用 <code>_read()</code> 去底层读取数据。<code>state.reading</code> 标志上次从底层取数据的操作是否完成，一旦 <code>push</code> 被调用，就会就会设置 <code>false</code>，表示此次 <code>_read()</code> 结束。</p><h3 id="push"><a aria-hidden="true" href="#push"><span class="icon icon-link"></span></a>push</h3><p>消耗方调用 <code>read(n)</code> 促使流输出数据，而流通过 <code>_read()</code> 使底层调用 <code>push()</code> 方法将数据传给流。如果调用 <code>push</code> 方法时缓存为空，则当前数据即为下一个需要的数据。这个数据可能先添加到缓存中，也可能直接输出。执行 <code>read</code> 方法时，在调用 <code>_read</code> 后，如果从缓存中取到了数据，就以 <code>data</code> 事件输出。</p><p>所以，如果 <code>_read</code> 异步调用 <code>push</code> 时发现缓存为空，则意味着当前数据是下一个需要的数据，且不会被 <code>read</code> 方法输出，应当在 <code>push</code> 方法中立即以 <code>data</code> 事件输出。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="state.flowing &amp;&amp; state.length === 0 &amp;&amp; !state.sync;
" data-status="copy"></button><div class="token-line"><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">flowing</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">state</span><span class="token punctuation">.</span><span class="token property-access">sync</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="end"><a aria-hidden="true" href="#end"><span class="icon icon-link"></span></a>end</h3><p>由于流是分次向底层请求数据的，需要底层显示地告诉流数据是否取完。所以，当某次（执行 <code>_read()</code>）取数据时，调用了 <code>push(null)</code>，就意味着底层数据取完。此时，流会设置 <code>state.ended</code>。</p><p><code>state.length</code> 表示缓存中当前的数据量。只有当 <code>state.length</code> 为 0，且 <code>state.ended</code> 为 <code>true</code>，才意味着所有的是数据都被消耗了。一旦在执行 <code>read(n)</code> 时检测到这个条件，便会触发 <code>end</code> 事件。当然，这个事件只会触发一次。</p><h3 id="readable"><a aria-hidden="true" href="#readable"><span class="icon icon-link"></span></a>readable</h3><p>在调用完 <code>_read()</code> 后，<code>read(n)</code> 会试着从缓存中取数据。如果 <code>_read()</code> 是异步调用 <code>push()</code> 方法的，则此时缓存中的数据量不会增多，容易出现数据量不够的现象。</p><p>如果 <code>read(n)</code> 的返回值为 <code>null</code>，说明这次未能从缓存中取出所需量的数据。此时，消耗方需要等待新的数据到达后再次尝试调用 <code>read</code> 方法。</p><p>在数据到达后，流是通过 readable 事件来通知消耗方。在此种情况下，<code>push</code> 方法如果立即输出数据，接收方直接监听 <code>data</code> 事件即可，否则数据被添加到缓存中，需要触发 readable 事件。消耗方必须监听这个事件，再调用 <code>read</code> 方法取得数据。</p><h2 id="实现过程"><a aria-hidden="true" href="#实现过程"><span class="icon icon-link"></span></a>实现过程</h2><h3 id="流动模式原理"><a aria-hidden="true" href="#流动模式原理"><span class="icon icon-link"></span></a>流动模式原理</h3><p>🌰 <strong>示例：可读流的流动模式原理代码实现过程</strong></p><p>从 Node.js 官方文档可知，流继承自 EventEmitter 模块，然后我们定义一些默认参数、缓存区、模式等。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = require(&#x27;fs&#x27;);
const EventEmitter = require(&#x27;events&#x27;);

class ReadableStream extends EventEmitter {
  constructor(path, options = {}) {
    super();
    this.path = path;
    this.highWaterMark = options.highWaterMark || 64 * 1024;
    this.flags = options.flags || &#x27;r&#x27;;
    this.start = options.start || 0;
    // 会随着读取的位置改变
    this.pos = this.start;
    this.autoClose = options.autoClose || true;
    this.end = options.end || null;
    // 默认 null 就是 Buffer
    this.encoding = options.encoding || null;

    // 参数的问题
    // 非流动模式
    this.flowing = null;
    // 创建 Buffer 用于存储每次读出的数据
    this.buffer = Buffer.alloc(this.highWaterMark);

    // 打开这个文件
    this.open();

    // 此方法默认同步调用，每次设置 on 监听事件时都会调用之前所有的 newListener 事件
    this.on(&#x27;newListener&#x27;, (type) =&gt; {
      if (type === &#x27;data&#x27;) {
        // 相当于用户监听了 data 事件
        this.fllowing = true;
        // 开始读取，客户已经监听的 data 事件
        this.read();
      }
    })
  }

  // 用于打开文件的方法
  open() {
    // fd 表示的就是当前 this.path 的这个文件，从 3 开始（number 类型）
    fs.open（this.path, this.flags, (err, fd) =&gt; {
      // 有可能 fd 这个文件不存在，需要做处理
      if (err) {
        // 如果有自动关闭，则帮他销毁
        if (this.autoClose) {
          // 销毁（关闭文件，触发关闭文件事件）
          this.destroy();
        }
        // 如果有错误，就会触发 error 事件
        this.emit(&#x27;error&#x27;, err);
        return;
      }
    }）
  }

  // 用于在文件操作出错或读完之后关闭文件
  destory() {
    // 先判断有没有 fd 有关闭文件，触发 close 事件
    if (typeof this.fd !== &#x27;number&#x27;) {
      return this.emit(&#x27;close&#x27;);
    }
    // 如果文件被打开过，就关闭文件并且触发 close 事件
    fs.close(this.fd, () =&gt; {
      // 销毁
      this.emit(&#x27;close&#x27;);
    })
  }

  // 默认第一次调用 read 方法时 fd 还没获得，所以不能直接读
  read() {
    // 此时文件还没打开
    if (typeof this.fd !== &#x27;number&#x27;) {
      // 当文件真正打开的时候，会触发 open 事件，触发事件后再执行 read，此时 fd 肯定拿到了
      return this.once(&#x27;open&#x27;, () =&gt; this.read())
    }

    // 每次读的时候都要判断一下下次读几个，如果没有 end 就根据 highWaterMark 来（读所有的）
    // 如果有且大于 highWaterMark 就根据 highWaterMark 来
    // 如果小于 highWaterMark 就根据 end 来
    let howMuchToRead = this.end ? Math.min(this.end - this.pos + 1, this.highWaterMark) : this.highWaterMark;
    fs.read(this.fd, this.buffer, 0, howMuchToRead, this.pos, (err, byteRead) =&gt; {
      this.pos += byteRead;
      let b = this.encoding ? this.buffer.slice(0, byteRead).toString(this.encoding) : this.buffer.slice(0, byteRead);
      this.emit(&#x27;data&#x27;, b);
      // 如果读取到的数量和 highWaterMark 一样，说明还得继续读
      if ((byteRead === this.highWaterMark) &amp;&amp; this.flowing) {
        this.read();
      }
      if (byteRead &lt; this.highWaterMark) {
        this.emit(&#x27;end&#x27;);
        this.destroy();
      }
    })
  }

  pause() {
    this.flowing = false;
  }

  resume() {
    this.flowing = true;
    this.read();
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">EventEmitter</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;events&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">ReadableStream</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token parameter punctuation">,</span><span class="token parameter"> options </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter punctuation">{</span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">64</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;r&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 会随着读取的位置改变</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 默认 null 就是 Buffer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 参数的问题</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 非流动模式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flowing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 创建 Buffer 用于存储每次读出的数据</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 打开这个文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 此方法默认同步调用，每次设置 on 监听事件时都会调用之前所有的 newListener 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;newListener&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">type </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 相当于用户监听了 data 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fllowing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 开始读取，客户已经监听的 data 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于打开文件的方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// fd 表示的就是当前 this.path 的这个文件，从 3 开始（number 类型）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token property-access">open（</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> fd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 有可能 fd 这个文件不存在，需要做处理</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 如果有自动关闭，则帮他销毁</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 销毁（关闭文件，触发关闭文件事件）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 如果有错误，就会触发 error 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span><span class="token plain"> err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain">）</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 用于在文件操作出错或读完之后关闭文件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 先判断有没有 fd 有关闭文件，触发 close 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果文件被打开过，就关闭文件并且触发 close 事件</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 销毁</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;close&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 默认第一次调用 read 方法时 fd 还没获得，所以不能直接读</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 此时文件还没打开</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 当文件真正打开的时候，会触发 open 事件，触发事件后再执行 read，此时 fd 肯定拿到了</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 每次读的时候都要判断一下下次读几个，如果没有 end 就根据 highWaterMark 来（读所有的）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果有且大于 highWaterMark 就根据 highWaterMark 来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果小于 highWaterMark 就根据 end 来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> howMuchToRead </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    fs</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> howMuchToRead</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> byteRead</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> byteRead</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> b </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> byteRead</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">encoding</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffer</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> byteRead</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span><span class="token plain"> b</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 如果读取到的数量和 highWaterMark 一样，说明还得继续读</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">byteRead </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flowing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">byteRead </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flowing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flowing</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="暂停模式原理"><a aria-hidden="true" href="#暂停模式原理"><span class="icon icon-link"></span></a>暂停模式原理</h3><p>以上是流动模式的可读流实现原理，暂停模式的可读流原理与流动模式的主要区别在于监听 <code>readable</code> 事件的绑定与 <code>read</code> 方法，先实现监听绑定 <code>readable</code> 事件回调函数时，调用 <code>read</code> 方法读取数据到缓存区，定义一个读取方法 <code>_read</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="constructor(path, options) {
  super();
  this.path = path;
  this.highWaterMark = options.highWaterMark || 64 * 1024;
  this.autoClose = options.autoClose || true;
  this.start = 0;
  this.end = options.end;
  this.flags = options.flags || &#x27;r&#x27;;

  // 缓存区
  this.buffers = [];
  this.pos = this.start;
  // 缓存区大小
  this.length = 0;
  this.emittedReadable = false;
  // 不是正在读取的
  this.reading = false;

  this.open();

  this.on(&#x27;newListener&#x27;, function (eventName) {
    if (eventName === &#x27;readable&#x27;) {
      this.read();
    }
  })
}

read(n) {
  if (this.length === 0) {
    this.emittedReadable = true;
  }
  if (this.length &lt; this.highWaterMark) {
    if (!this.reading) {
      this.reading = true;
      this._read();
    }
  }
}

_read() {
  if (typeof this.fd !== &#x27;number&#x27;) {
    return this.once(&#x27;open&#x27;, () =&gt; this._read());
  }
  let buffer = Buffer.alloc(this.highWaterMark);
  fs.read(this.fd, buffer, 0, buffer.length, this.pos, (err, bytesRead) =&gt; {
    if (bytesRead &gt; 0) {
      this.buffers.push(buffer.slice(0, bytesRead));
      this.pos += bytesRead;
      this.length += bytesRead;
      this.reading = false;
      if (this.emittedReadable) {
        this.emiitedReadable = false;
        this.emit(&#x27;readable&#x27;);
      }
    } else {
      this.emit(&#x27;end&#x27;);
      this.destroy();
    }
  })
}
" data-status="copy"></button><div class="token-line"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token parameter punctuation">,</span><span class="token parameter"> options</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">path</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> path</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token number">64</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1024</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">autoClose</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">end</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> options</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token string">&#x27;r&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 缓存区</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffers</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">start</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 缓存区大小</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emittedReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 不是正在读取的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;newListener&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">eventName</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">eventName </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;readable&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emittedReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&#x27;number&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">once</span><span class="token punctuation">(</span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> buffer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  fs</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">fd</span><span class="token punctuation">,</span><span class="token plain"> buffer</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> buffer</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token parameter punctuation">,</span><span class="token parameter"> bytesRead</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">bytesRead </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffers</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">buffer</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> bytesRead</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pos</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> bytesRead</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">+=</span><span class="token plain"> bytesRead</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emittedReadable</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emiitedReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;readable&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>由 API 可知，暂停模式下的可读流手动调用 <code>read</code> 方法参数可以大于 highWaterMark，为了处理这种情况，我们先写一个函数 <code>computeNewHighWaterMark</code>，取到大于等于 <code>n</code> 的最小 2 的 n 次方的整数。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function computeNewHighWaterMark(n) {
  n--;
  n |= n &gt;&gt;&gt; 1;
  n |= n &gt;&gt;&gt; 2;
  n |= n &gt;&gt;&gt; 4;
  n |= n &gt;&gt;&gt; 8;
  n |= n &gt;&gt;&gt; 16;
  n++;
  return n;
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">computeNewHighWaterMark</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n</span><span class="token operator">--</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n </span><span class="token operator">|=</span><span class="token plain"> n </span><span class="token operator">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n </span><span class="token operator">|=</span><span class="token plain"> n </span><span class="token operator">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n </span><span class="token operator">|=</span><span class="token plain"> n </span><span class="token operator">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n </span><span class="token operator">|=</span><span class="token plain"> n </span><span class="token operator">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number">8</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n </span><span class="token operator">|=</span><span class="token plain"> n </span><span class="token operator">&gt;&gt;&gt;</span><span class="token plain"> </span><span class="token number">16</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  n</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> n</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>然后写 <code>read</code> 方法，要考虑全 n 的各种情况：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="read(n) {
  if (n &gt; this.length) {
    // 更改缓存区大小，读取五个就找 2 的几次放最近的
    this.highWaterMark = computeNewHighMark(n);
    this.emiitedReadable = true;
    this._read();
  }

  // 如果 n &gt; 0 就从缓存区中获取
  let buffer = null;
  // 维护 Buffer 的索引的
  let index = 0;
  let flag = true;
  if (n &gt; 0 &amp;&amp; n &lt;= this.length) { // 读取内容，缓存区中有这么多
    // 在缓存区中取 [[2, 3], [4, 5, 6]]

    // 这是要返回的 Buffer
    buffer = Buffer.alloc(n);
    let buf;
    while(flag &amp;&amp; (buf = this.buffers.shift())) {
      for(let i = 0; i &lt; buf.length; i++){
        buffer[index++] = buf[i];
        // 拷贝够了，不需要再拷贝了
        if (index === n) {
          flag = false;
          this.length -= n;
          // 取出留下的部分
          let bufferArr = buf.slice(i+1);
          // 如果有剩下的内容，再放入缓存中
          if (bufferArr.length &gt; 0) {
            this.buffers.unshift(bufferArr);
          }
          break;
        }
      }
    }
  }
  // 当前缓存区，小于 highWaterMark 时再去读取
  if (this.length === 0){
    this.emittedReadable = true;
  }
  if (this.length &lt; this.highWaterMark) {
    if (!this.reading) {
      this.reading = true;
      // 异步的
      this._read();
    }
  }
  return buffer;
}
" data-status="copy"></button><div class="token-line"><span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">n </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 更改缓存区大小，读取五个就找 2 的几次放最近的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeNewHighMark</span><span class="token punctuation">(</span><span class="token plain">n</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emiitedReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 如果 n &gt; 0 就从缓存区中获取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> buffer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 维护 Buffer 的索引的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> flag </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">n </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> n </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token comment">// 读取内容，缓存区中有这么多</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 在缓存区中取 [[2, 3], [4, 5, 6]]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 这是要返回的 Buffer</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    buffer </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token method function property-access">alloc</span><span class="token punctuation">(</span><span class="token plain">n</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> buf</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token plain">flag </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">buf </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffers</span><span class="token punctuation">.</span><span class="token method function property-access">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> buf</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        buffer</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token operator">++</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> buf</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token comment">// 拷贝够了，不需要再拷贝了</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> n</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          flag </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-=</span><span class="token plain"> n</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 取出留下的部分</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> bufferArr </span><span class="token operator">=</span><span class="token plain"> buf</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token plain">i</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 如果有剩下的内容，再放入缓存中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">bufferArr</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">buffers</span><span class="token punctuation">.</span><span class="token method function property-access">unshift</span><span class="token punctuation">(</span><span class="token plain">bufferArr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 当前缓存区，小于 highWaterMark 时再去读取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">emittedReadable</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">highWaterMark</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reading</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 异步的</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> buffer</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="readable-1"><a aria-hidden="true" href="#readable-1"><span class="icon icon-link"></span></a>Readable</h3><p><code>readable</code> 这个方法是可读流的一种暂停模式，他的模式可以参考为可读流是往水杯倒水的人， Readable 是喝水的人，他们之间存在着一种联系，只要 Readable 喝掉一点水，可读流就会继续往里倒。</p><ul><li>Readable 会在刚开始监听 Readable 的时候就触发流，此时流就会读取一次数据，之后流会监听，如果有人读过流（喝过水），并且减少，就会再去读一次（倒点水）</li><li>Readable 主要用来做行读取器（LineReader）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const fs = require(&#x27;fs&#x27;);
const read = require(&#x27;./ReadableStream&#x27;);
const rs = fs.createReadStream(&#x27;./readStream.txt&#x27;, {
  // 每次读 7 个
  highWaterMark: 7,
});

// 如果可读流第一次全部读下来并且小于 highWaterMark，就会再读一次（再触发一次 readable 事件）
// 如果 rs.read() 不加参数，一次性读完，会从缓存区再读一次，为 null
// 如果 readable 每次都刚好读完（即 rs.read() 的参数刚好和 highWaterMark 相等），就会一直触发 readable 事件，如果最后不足读取的数，就会先触发一次 null，最后吧剩下的读完
// 一开始缓存区为 0 的时候
rs.on(&#x27;readable&#x27;, () =&gt; {
  let result = rs.read(2);
  console.log(result);
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> fs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;fs&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> read </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./ReadableStream&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> rs </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token string">&#x27;./readStream.txt&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 每次读 7 个</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  highWaterMark</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">7</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果可读流第一次全部读下来并且小于 highWaterMark，就会再读一次（再触发一次 readable 事件）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果 rs.read() 不加参数，一次性读完，会从缓存区再读一次，为 null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果 readable 每次都刚好读完（即 rs.read() 的参数刚好和 highWaterMark 相等），就会一直触发 readable 事件，如果最后不足读取的数，就会先触发一次 null，最后吧剩下的读完</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 一开始缓存区为 0 的时候</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;readable&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> rs</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>实战：行读取器（平常我们的文件可能有回车、换行，此时如果要每次想读一行的数据，就得用到 <code>readable</code>）</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const EventEmitter = require(&#x27;events&#x27;);
// 如果要将内容全部读出就用 on(&#x27;data&#x27;)，精确读取就用 on(&#x27;readable&#x27;)
class LineReader extends EventEmitter {
  construtor(path) {
    super();
    this.rs = fs.createReadStream(path);
    // 回车符的十六进制
    const RETURN = 0x0d;
    // 换行符的十六进制
    const LINE = 0x0a;
    let arr = [];
    this.on(&#x27;newListener&#x27;, type =&gt; {
      if (type === &#x27;newLine&#x27;) {
        this.rs.on(&#x27;readable&#x27;, () =&gt; {
          let char;
          // 每次读一次，当读完的时候会返回 null，终止循环
          while ((char = this.rs.read(1))) {
            switch (char[0]) {
              case RETURN:
                break;
              // Mac 下只有换行符，windows 下是回车符和换行符，需要根据不同的转换
              case LINE:
                // 如果是换行符就把数组转换为字符串
                let r = Buffer.from(arr).toString(&#x27;utf8&#x27;);
                // 把数组清空
                arr.length = 0;
                // 触发 newLine 事件，把得到的一行数据输出
                this.emit(&#x27;newLine&#x27;, r);
                break;
              default:
                // 如果不是换行符，就放入数组中
                arr.push(char[0]);
            }
          }
        });
      }
    });
    // 以上只能取出之前的换行符前的代码，最后一行的后面没有换行符，所以需要特殊处理，当可读流读完需要触发 end 事件时
    this.rs.on(&#x27;end&#x27;, () =&gt; {
      // 取出最后一行数据，转成字符串
      let r = Buffer.from(arr).toString(&#x27;utf8&#x27;);
      arr.length = 0;
      this.emit(&#x27;newLine&#x27;, r);
    });
  }
}

let lineReader = new LineReader(&#x27;./index.txt&#x27;);
lineReader.on(&#x27;newLine&#x27;, function(data) {
  console.log(data);
});
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">EventEmitter</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;events&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 如果要将内容全部读出就用 on(&#x27;data&#x27;)，精确读取就用 on(&#x27;readable&#x27;)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">LineReader</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">EventEmitter</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">construtor</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rs</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fs</span><span class="token punctuation">.</span><span class="token method function property-access">createReadStream</span><span class="token punctuation">(</span><span class="token plain">path</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 回车符的十六进制</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">RETURN</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0x0d</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 换行符的十六进制</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">LINE</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0x0a</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> arr </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;newListener&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token parameter">type</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">type </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;newLine&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;readable&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">let</span><span class="token plain"> char</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">// 每次读一次，当读完的时候会返回 null，终止循环</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">char </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rs</span><span class="token punctuation">.</span><span class="token method function property-access">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">char</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">RETURN</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token comment">// Mac 下只有换行符，windows 下是回车符和换行符，需要根据不同的转换</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token constant">LINE</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 如果是换行符就把数组转换为字符串</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">let</span><span class="token plain"> r </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token plain">arr</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 把数组清空</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                arr</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 触发 newLine 事件，把得到的一行数据输出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;newLine&#x27;</span><span class="token punctuation">,</span><span class="token plain"> r</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword module">default</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token comment">// 如果不是换行符，就放入数组中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                arr</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">char</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 以上只能取出之前的换行符前的代码，最后一行的后面没有换行符，所以需要特殊处理，当可读流读完需要触发 end 事件时</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rs</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;end&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 取出最后一行数据，转成字符串</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> r </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token plain">arr</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      arr</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;newLine&#x27;</span><span class="token punctuation">,</span><span class="token plain"> r</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> lineReader </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">LineReader</span><span class="token punctuation">(</span><span class="token string">&#x27;./index.txt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">lineReader</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">&#x27;newLine&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="自定义可读流"><a aria-hidden="true" href="#自定义可读流"><span class="icon icon-link"></span></a>自定义可读流</h3><p>由于 <code>createReadStream</code> 内部调用了 ReadStream 类，ReadStream 又实现了 Readable 接口，ReadStream 实现了 <code>_read()</code> 方法，所以我们通过自定义一个累继承 <code>stream</code> 模块的 Readable，并在原型上自定义自己的可读流。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const { Readable } = require(&#x27;stream&#x27;);

class MyRead extends Readable {
  // 流需要一个 _read 方法，方法中 push 什么，外面就接收什么
  _read() {
    // push 方法就是上面 _read 方法中的 push 一样，把数据放入缓存区中
    this.push(&#x27;100&#x27;);
    // 如果 push 了 null 就表示没有东西可读了，停止（如果不写，就会一直 push 上面的值，死循环）
    this.push(null);
  }
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token maybe-class-name">Readable</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;stream&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">MyRead</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">Readable</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 流需要一个 _read 方法，方法中 push 什么，外面就接收什么</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// push 方法就是上面 _read 方法中的 push 一样，把数据放入缓存区中</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">&#x27;100&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 如果 push 了 null 就表示没有东西可读了，停止（如果不写，就会一直 push 上面的值，死循环）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="运行全流程"><a aria-hidden="true" href="#运行全流程"><span class="icon icon-link"></span></a>运行全流程</h2><p><img src="/node-guidebook/static/stream-flow.89010f51.jpg"/></p><p>如上图，当我们创建一个可读流的时候，<code>readable._readableState.flowing</code> 属性默认为 <code>null</code>，这时我们有两种选择：</p><ol><li>监听 <code>readable</code> 事件，这是可读流会读取 64 KB（可以在创建可读流时，通过 <code>option</code> 参数重的 highWaterMark 更改）数据到流的缓存区中，等待你用 <code>read</code> 方法取读取并消费数据，当你用 <code>read</code> 方法读了 64KB 数据之后，会再次出发 <code>readable</code> 事件，知道你读完了源文件的所有数据。记住，之所以叫暂停模式是因为如果你不调用 <code>read</code> 方法，代码永远会停在这里，什么事情也不会发生。</li><li>如果你选择监听 <code>data</code> 事件，可读流会直接读取 64KB 数据并通过 <code>data</code> 事件的回调函数提供给你消费，并且这个过程不会停止，如果源文件中有很多数据，会不停的触发 <code>data</code> 事件，知道全部读取完成。当然，在这个过程中你随时可以通过 <code>stream.pause()</code> 方法暂停它。</li></ol><p>那么，这两种模式有什么区别呢？在我理解，如果你不需要对数据进行精确控制，首先选择<strong>流动模式</strong>，因为它的效率更高。如果需要对流的过程进行精确控制则可以选择<strong>暂停模式</strong>。也就是说暂停模式是流更高级一些的用法。其实官方建议我们尽量不要手动去操作流，如果可以，尽量使用 <code>pipe</code> 方法。</p><p>接下来，不论我们以哪种方式读到了文件中的数据，这时我们都可以创建一个可写流并调用可写流的 <code>write</code> 方法来消费读到的数据。调用 <code>write</code> 方法会向文件中写入数据，但是因为写入的速度较慢，如果当前写入还在进行，而你又调用了 <code>write</code> 方法，Node.js 会将你要写入的数据缓存在一个缓存区中，等到文件写入完毕会从缓存区中取出数据，继续写入。</p><p><code>write</code> 方法拥有一个布尔类型的返回值，用来表示目前是否还可以继续调用 <code>write</code> 方法写入内容。如果返回 <code>false</code>，我们应当停止读取数据以避免消耗过多内存。那么什么时候会返 <code>false</code> 呢？就是当缓存区的大小大于 16KB（可以在创建可读流时，通过 <code>option</code> 参数中的 <code>highWaterMark</code> 更改）时。</p><p>缓存区满后，文件写入一直在进行，不一会儿会把缓存区的内容全部写入，缓存区处于清空状态，这时会触发可写流的 <code>drain</code> 事件，这时我们可以继续向文件写入数据了。注意：如果缓存区从未满过，<code>drain</code> 事件永远也不会触发。</p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/node-guidebook/edit/master/docs/system/io/readable-stream.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/4/2020, 3:39:37 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/node-guidebook/umi.js"></script>
    <script src="/node-guidebook/docs__system__io__readable-stream.md.js"></script>
  </body>
</html>
