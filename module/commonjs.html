<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CommonJS | Node-Guidebook</title>
    <meta name="description" content="">
    <link rel="icon" href="favicon.ico">
    
    <link rel="preload" href="/node-guidebook/assets/css/0.styles.04b4ede2.css" as="style"><link rel="preload" href="/node-guidebook/assets/js/app.b56de1e6.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/2.9a9b2fe1.js" as="script"><link rel="preload" href="/node-guidebook/assets/js/41.c737d452.js" as="script"><link rel="prefetch" href="/node-guidebook/assets/js/10.f31a5cd7.js"><link rel="prefetch" href="/node-guidebook/assets/js/11.9a11099b.js"><link rel="prefetch" href="/node-guidebook/assets/js/12.d192428c.js"><link rel="prefetch" href="/node-guidebook/assets/js/13.3b64565c.js"><link rel="prefetch" href="/node-guidebook/assets/js/14.d5a9b897.js"><link rel="prefetch" href="/node-guidebook/assets/js/15.01e27e34.js"><link rel="prefetch" href="/node-guidebook/assets/js/16.606d1944.js"><link rel="prefetch" href="/node-guidebook/assets/js/17.51b30e3b.js"><link rel="prefetch" href="/node-guidebook/assets/js/18.063b4f41.js"><link rel="prefetch" href="/node-guidebook/assets/js/19.7f27a998.js"><link rel="prefetch" href="/node-guidebook/assets/js/20.c97daf38.js"><link rel="prefetch" href="/node-guidebook/assets/js/21.2e1c632f.js"><link rel="prefetch" href="/node-guidebook/assets/js/22.fbd33fb6.js"><link rel="prefetch" href="/node-guidebook/assets/js/23.b087a4cc.js"><link rel="prefetch" href="/node-guidebook/assets/js/24.9bf9975f.js"><link rel="prefetch" href="/node-guidebook/assets/js/25.833c04e5.js"><link rel="prefetch" href="/node-guidebook/assets/js/26.fa5f5e57.js"><link rel="prefetch" href="/node-guidebook/assets/js/27.e048e63c.js"><link rel="prefetch" href="/node-guidebook/assets/js/28.7389fa33.js"><link rel="prefetch" href="/node-guidebook/assets/js/29.5f7ae828.js"><link rel="prefetch" href="/node-guidebook/assets/js/3.028038f2.js"><link rel="prefetch" href="/node-guidebook/assets/js/30.97c6204d.js"><link rel="prefetch" href="/node-guidebook/assets/js/31.0f2c316e.js"><link rel="prefetch" href="/node-guidebook/assets/js/32.a2d860ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/33.ef37b95b.js"><link rel="prefetch" href="/node-guidebook/assets/js/34.55cdaada.js"><link rel="prefetch" href="/node-guidebook/assets/js/35.7f7e104c.js"><link rel="prefetch" href="/node-guidebook/assets/js/36.89d29ca3.js"><link rel="prefetch" href="/node-guidebook/assets/js/37.13112c94.js"><link rel="prefetch" href="/node-guidebook/assets/js/38.57cfe6d1.js"><link rel="prefetch" href="/node-guidebook/assets/js/39.db4440a8.js"><link rel="prefetch" href="/node-guidebook/assets/js/4.675c3702.js"><link rel="prefetch" href="/node-guidebook/assets/js/40.95563075.js"><link rel="prefetch" href="/node-guidebook/assets/js/42.77397b50.js"><link rel="prefetch" href="/node-guidebook/assets/js/43.55d50864.js"><link rel="prefetch" href="/node-guidebook/assets/js/44.2ee11d4d.js"><link rel="prefetch" href="/node-guidebook/assets/js/45.cbfb9e4f.js"><link rel="prefetch" href="/node-guidebook/assets/js/46.8c5dee73.js"><link rel="prefetch" href="/node-guidebook/assets/js/47.ed9a119b.js"><link rel="prefetch" href="/node-guidebook/assets/js/48.ace38419.js"><link rel="prefetch" href="/node-guidebook/assets/js/49.e79545ac.js"><link rel="prefetch" href="/node-guidebook/assets/js/5.11ee68c1.js"><link rel="prefetch" href="/node-guidebook/assets/js/50.9fbe2e33.js"><link rel="prefetch" href="/node-guidebook/assets/js/51.4896a061.js"><link rel="prefetch" href="/node-guidebook/assets/js/52.c4ceb1c2.js"><link rel="prefetch" href="/node-guidebook/assets/js/53.8c0fea71.js"><link rel="prefetch" href="/node-guidebook/assets/js/54.c05dccf1.js"><link rel="prefetch" href="/node-guidebook/assets/js/55.b2d65211.js"><link rel="prefetch" href="/node-guidebook/assets/js/56.a43684ff.js"><link rel="prefetch" href="/node-guidebook/assets/js/57.7ba8a6f3.js"><link rel="prefetch" href="/node-guidebook/assets/js/58.f0c2c1ef.js"><link rel="prefetch" href="/node-guidebook/assets/js/59.944bad13.js"><link rel="prefetch" href="/node-guidebook/assets/js/6.21a4b1c5.js"><link rel="prefetch" href="/node-guidebook/assets/js/60.e62081dc.js"><link rel="prefetch" href="/node-guidebook/assets/js/61.5e74305b.js"><link rel="prefetch" href="/node-guidebook/assets/js/62.ca1dac6e.js"><link rel="prefetch" href="/node-guidebook/assets/js/63.c03d966c.js"><link rel="prefetch" href="/node-guidebook/assets/js/64.c7411f74.js"><link rel="prefetch" href="/node-guidebook/assets/js/65.23e9fb75.js"><link rel="prefetch" href="/node-guidebook/assets/js/66.4dbed100.js"><link rel="prefetch" href="/node-guidebook/assets/js/67.80de04b2.js"><link rel="prefetch" href="/node-guidebook/assets/js/68.73588625.js"><link rel="prefetch" href="/node-guidebook/assets/js/69.d28f892e.js"><link rel="prefetch" href="/node-guidebook/assets/js/7.62412490.js"><link rel="prefetch" href="/node-guidebook/assets/js/70.a271a34d.js"><link rel="prefetch" href="/node-guidebook/assets/js/71.407abc57.js"><link rel="prefetch" href="/node-guidebook/assets/js/72.67ca9438.js"><link rel="prefetch" href="/node-guidebook/assets/js/73.c95f2cd6.js"><link rel="prefetch" href="/node-guidebook/assets/js/74.95ef83e7.js"><link rel="prefetch" href="/node-guidebook/assets/js/75.a225a743.js"><link rel="prefetch" href="/node-guidebook/assets/js/76.45437d36.js"><link rel="prefetch" href="/node-guidebook/assets/js/77.919cd113.js"><link rel="prefetch" href="/node-guidebook/assets/js/78.447a327e.js"><link rel="prefetch" href="/node-guidebook/assets/js/79.74917783.js"><link rel="prefetch" href="/node-guidebook/assets/js/8.26079951.js"><link rel="prefetch" href="/node-guidebook/assets/js/80.7517c60e.js"><link rel="prefetch" href="/node-guidebook/assets/js/81.4896eb33.js"><link rel="prefetch" href="/node-guidebook/assets/js/82.52db751e.js"><link rel="prefetch" href="/node-guidebook/assets/js/83.108e2ceb.js"><link rel="prefetch" href="/node-guidebook/assets/js/84.c4018c3e.js"><link rel="prefetch" href="/node-guidebook/assets/js/85.95ab55fa.js"><link rel="prefetch" href="/node-guidebook/assets/js/86.01a6e820.js"><link rel="prefetch" href="/node-guidebook/assets/js/87.7748e683.js"><link rel="prefetch" href="/node-guidebook/assets/js/88.730b440e.js"><link rel="prefetch" href="/node-guidebook/assets/js/89.4eca5ebb.js"><link rel="prefetch" href="/node-guidebook/assets/js/9.841d82b7.js"><link rel="prefetch" href="/node-guidebook/assets/js/90.6dc66fef.js"><link rel="prefetch" href="/node-guidebook/assets/js/91.616655e3.js"><link rel="prefetch" href="/node-guidebook/assets/js/92.0e127a47.js"><link rel="prefetch" href="/node-guidebook/assets/js/93.cc651dc5.js"><link rel="prefetch" href="/node-guidebook/assets/js/94.0c069be2.js"><link rel="prefetch" href="/node-guidebook/assets/js/95.28ec5306.js"><link rel="prefetch" href="/node-guidebook/assets/js/96.4680804b.js"><link rel="prefetch" href="/node-guidebook/assets/js/97.04e2deb8.js">
    <link rel="stylesheet" href="/node-guidebook/assets/css/0.styles.04b4ede2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/node-guidebook/" class="home-link router-link-active"><img src="/node-guidebook/favicon.png" alt="Node-Guidebook" class="logo"> <span class="site-name can-hide">Node-Guidebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/tsejx/Node-Guidebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>模块</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/module/commonjs.html" class="active sidebar-link">CommonJS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#module" class="sidebar-link">module</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#module-exports-属性" class="sidebar-link">module.exports 属性</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#exports-变量" class="sidebar-link">exports 变量</a></li></ul></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#require" class="sidebar-link">require</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#加载规则" class="sidebar-link">加载规则</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#目录的加载规则" class="sidebar-link">目录的加载规则</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#模块的缓存" class="sidebar-link">模块的缓存</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#模块的循环加载" class="sidebar-link">模块的循环加载</a></li><li class="sidebar-sub-header"><a href="/node-guidebook/module/commonjs.html#require-main" class="sidebar-link">require.main</a></li></ul></li></ul></li><li><a href="/node-guidebook/module/module.html" class="sidebar-link">模块机制</a></li><li><a href="/node-guidebook/module/global.html" class="sidebar-link">全局对象</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>I/O</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/io/io.html" class="sidebar-link">I/O</a></li><li><a href="/node-guidebook/io/stream/stream.html" class="sidebar-link">流</a></li><li><a href="/node-guidebook/io/stream/readable.html" class="sidebar-link">可读流</a></li><li><a href="/node-guidebook/io/stream/writable.html" class="sidebar-link">可写流</a></li><li><a href="/node-guidebook/io/buffer.html" class="sidebar-link">缓冲器</a></li><li><a href="/node-guidebook/io/filesystem.html" class="sidebar-link">文件系统</a></li><li><a href="/node-guidebook/io/path.html" class="sidebar-link">路径</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/process/process.html" class="sidebar-link">进程</a></li><li><a href="/node-guidebook/process/child-process.html" class="sidebar-link">子进程</a></li><li><a href="/node-guidebook/process/cluster.html" class="sidebar-link">集群</a></li><li><a href="/node-guidebook/process/ipc.html" class="sidebar-link">进程间通信</a></li><li><a href="/node-guidebook/process/daemon.html" class="sidebar-link">守护进程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/network/socket.html" class="sidebar-link">Socket</a></li><li><a href="/node-guidebook/network/dns.html" class="sidebar-link">DNS</a></li><li><a href="/node-guidebook/network/net.html" class="sidebar-link">Net</a></li><li><a href="/node-guidebook/network/dgram.html" class="sidebar-link">Dgram</a></li><li><a href="/node-guidebook/network/http.html" class="sidebar-link">HTTP</a></li><li><a href="/node-guidebook/network/http-server.html" class="sidebar-link">HTTP Server</a></li><li><a href="/node-guidebook/network/http-client-request.html" class="sidebar-link">HTTP ClientRequest</a></li><li><a href="/node-guidebook/network/http-incoming-message.html" class="sidebar-link">HTTP IncomingMessage</a></li><li><a href="/node-guidebook/network/http-server-response.html" class="sidebar-link">HTTP ServerResponse</a></li><li><a href="/node-guidebook/network/https.html" class="sidebar-link">HTTPS</a></li><li><a href="/node-guidebook/network/http2.html" class="sidebar-link">HTTP2</a></li><li><a href="/node-guidebook/network/url.html" class="sidebar-link">URL</a></li><li><a href="/node-guidebook/network/querystring.html" class="sidebar-link">QueryString</a></li><li><a href="/node-guidebook/network/crypto.html" class="sidebar-link">Crypto</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指令</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/3m/npm.html" class="sidebar-link">NPM</a></li><li><a href="/node-guidebook/3m/npx.html" class="sidebar-link">NPX</a></li><li><a href="/node-guidebook/3m/nrm.html" class="sidebar-link">NRM</a></li><li><a href="/node-guidebook/3m/nvm.html" class="sidebar-link">NVM</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>推荐资料</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/node-guidebook/recommend.html" class="sidebar-link">推荐资料</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h1> <p>Node 应用由模块组成，采用 CommonJS 模块规范。</p> <p>每个文件就是一个模块，有自己的作用域。在一个文件里面定义的变量、函数、类，都是私有的，对其他文件不可见。</p> <p>如果想在多个文件分享变量，必须定义为 <code>global</code> 对象的属性。</p> <p>CommonJS 规范规定，每个模块内部，<code>module</code> 变量代表当前模块。这个变量是一个对象，它的 <code>exports</code> 属性（即 <code>module.exports</code>）是对外的接口。加载某个模块，其实是加载该模块的 <code>module.exports</code> 属性。</p> <p>CommonJS 模块的特点：</p> <ul><li>所有代码都运行在模块作用域，不会污染全局作用域</li> <li>模块可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存</li> <li>模块加载的顺序，按照其在代码中出现的顺序</li></ul> <h2 id="module"><a href="#module" class="header-anchor">#</a> module</h2> <p>Node 内部提供一个 Module 构建函数。所有模块都是 Module 的实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Module</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>每个模块内部，都有一个 <code>module</code> 对象，代表当前模块。它有以下属性。</p> <ul><li><code>module.id</code>：模块的识别符，通常是带有绝对路径的模块文件名</li> <li><code>module.filename</code>：模块的文件名，带有绝对路径</li> <li><code>module.loaded</code>：返回一个布尔值，表示模块是否已经完成加载</li> <li><code>module.parent</code>：返回一个对象，表示调用该模块的模块</li> <li><code>module.children</code>：返回一个数组，表示该模块要用到的其他模块</li> <li><code>module.exports</code>：表示模块对外输出的值</li></ul> <p>🌰 <strong>示例：</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">const</span> jquery <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>$ <span class="token operator">=</span> jquery<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行该文件，命令行会输出如下信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'$'</span><span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  parent<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  filename<span class="token operator">:</span> <span class="token string">'/path/to/example.js'</span><span class="token punctuation">,</span>
  loaded<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token string">'/path/to/node_modules/jquery/dist/jquery.js'</span><span class="token punctuation">,</span>
       exports<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token punctuation">]</span><span class="token punctuation">,</span>
       parent<span class="token operator">:</span> <span class="token punctuation">[</span>Circular<span class="token punctuation">]</span><span class="token punctuation">,</span>
       filename<span class="token operator">:</span> <span class="token string">'/path/to/node_modules/jquery/dist/jquery.js'</span><span class="token punctuation">,</span>
       loaded<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
       children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       paths<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  paths<span class="token operator">:</span> <span class="token punctuation">[</span>
     <span class="token string">'/home/user/deleted/node_modules'</span><span class="token punctuation">,</span>
     <span class="token string">'/home/user/node_modules'</span><span class="token punctuation">,</span>
     <span class="token string">'/home/node_modules'</span><span class="token punctuation">,</span>
     <span class="token string">'/node_modules'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>若在命令行下调用该模块，比如 <code>node index.js</code>，则 <code>module.parent</code> 为 <code>null</code>。</li> <li>若在脚本之中调用，比如 <code>require('./index.js)</code>，则 <code>module.parent</code> 就是调用它的模块。</li></ul> <p>利用这一点，可以判断当前模块是否为入口脚本。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ran with `node index.js`</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'app listening on port 8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// used with `require('./index.js')`</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="module-exports-属性"><a href="#module-exports-属性" class="header-anchor">#</a> module.exports 属性</h3> <p><code>module.exports</code> 属性表示当前模块对外输出的接口，其他文件加载该模块，实际上就是读取 <code>module.exports</code> 变量。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter<span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上述模块会在加载后 1 秒后，发出 ready 事件。其他文件监听该事件，可以写成下面这样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'ready'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'module foo is ready'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="exports-变量"><a href="#exports-变量" class="header-anchor">#</a> exports 变量</h3> <p>为了方便，Node 为每个模块提供了一个 exports 变量，指向 <code>module.exports</code>。这等同在每个模块头部，有这样一行命令。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
</code></pre></div><p>因此，在对外输出模块接口时，可以像 exports 对象添加方法。</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">area</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> r <span class="token operator">*</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">circumference</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>注意，不能将 exports 变量直接指向一个值，因为这样等于断了 <code>exports</code> 和 <code>module.exports</code> 的联系。</p> <p>以下写法是无效的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面的写法也是无效的。</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">'Hello world!'</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码，<code>hello</code> 函数是无法对外输出的，因为 <code>module.exports</code> 被重新赋值了。</p> <p>这意味着，如果一个模块的对外接口，就是一个单一的值，不能使用 <code>exports</code> 输出，只能使用 <code>module.exports</code> 输出。</p> <p>如果觉得 <code>exports</code> 和 <code>module.exports</code> 之间的区别很难分清，一个简单的处理方法，就是放弃使用 <code>exports</code>，只使用 <code>module.exports</code>。</p> <h2 id="require"><a href="#require" class="header-anchor">#</a> require</h2> <p>Node 使用 CommonJS 模块规范，内置的 <code>require</code> 命令用于加载模块文件。</p> <p><code>require</code> 命令的基本功能就是，读入并执行一个 JavaScript 文件，然后返回该模块的 exports 对象。如果没有发现指定模块，会报错。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">var</span> <span class="token function-variable function">invisible</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'invisible'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'hi'</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">say</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>如果模块输出的是一个函数，那就不能定义在 exports 对象上，而要定义在 <code>module.exports</code> 变量上。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面代码中，require 命令调用自身，等于是执行 <code>module.exports</code>，因此会输出 <code>hello world!</code>。</p> <h3 id="加载规则"><a href="#加载规则" class="header-anchor">#</a> 加载规则</h3> <p><code>require</code> 命令用于加载文件，后缀名默认为 <code>.js</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  等同于</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'foo.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>根据参数的不同格式，<code>require</code> 命令去不同路径寻找模块文件。</p> <ol><li><p>如果参数字符串以 <code>/</code> 开头，则表示加载的是一个位于<strong>绝对路径</strong>的模块文件。比如，<code>require('/home/marco/foo.js')</code> 将加载 <code>/home/marco/foo.js</code>。</p></li> <li><p>如果参数字符串以 <code>./</code> 开头，则表示加载的是一个位于<strong>相对路径</strong>（跟当前执行脚本的位置相比）的模块文件。比如，<code>require('./foo')</code> 将加载当前脚本同一目录的 <code>foo.js</code>。</p></li> <li><p>如果参数字符串不以 <code>./</code> 或 <code>/</code> 开头，则表示加载的是一个<strong>默认提供的核心模块</strong>（位于 Node 的系统安装目录中），或者一个位于各级 <code>node_modules</code> 目录的已安装模块（全局安装或局部安装）。</p></li></ol> <p>举例来说，脚本 <code>/home/user/projects/foo.js</code> 执行了 <code>require('bar.js')</code> 命令，Node 会依次搜索以下文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># node 安装全局依赖的目录</span>
/usr/local/lib/node/bar.js
<span class="token comment"># 当前文件夹依赖目录</span>
/home/user/projects/node_modules/bar.js
<span class="token comment"># 父目录依赖目录</span>
/home/user/node_modules/bar.js
<span class="token comment"># 父目录的父目录依赖目录</span>
/home/node_modules/bar.js
<span class="token comment"># 沿路径向上逐级递归，直到根目录下的依赖目录</span>
/node_modules/bar.js
</code></pre></div><p>这种路径的生成方式与 JavaScript 的原型链或作用域的查找方式十分类似。在加载的过程中，Node 会逐个尝试模块路径中的路径，直到找到目标文件为止。可以看出，当前文件的路径越深，模块查找耗时会越多，这是自定义模块的加载速度是最慢的原因。</p> <ol start="4"><li><p>如果参数字符串不以 <code>./</code> 或 <code>/</code> 开头，而且是一个路径，比如 <code>require('example/path/to/file')</code>，则将先找到 <code>example</code> 的位置，然后再以它为参数，找到后续路径。</p></li> <li><p>如果指定的模块文件没有发现，Node 会尝试为文件名添加 <code>.js</code>、<code>.json</code>、<code>.node</code> 后，再去搜索。<code>.js</code> 件会以文本格式的 JavaScript 脚本文件解析，<code>.json</code> 文件会以 JSON 格式的文本文件解析，<code>.node</code> 文件会以编译后的二进制文件解析。</p></li> <li><p>如果想得到 require 命令加载的确切文件名，使用 <code>require.resolve()</code> 方法。</p></li> <li><p>如果参数字符串为目录的路径，则自动查找该文件夹下的 <code>package.json</code> 文件，然后再加载该文件当中 main 字段所指定的入口文件（若没有 <code>package.json</code> 文件或该文件中无 main 字段，则默认查找该文件夹下的 <code>index.js</code> 文件作为模块来载入）</p></li></ol> <p>⚠️ 注意：Node 的系统模块的优先级最高，一旦有第三方模块包与核心模块重名，则以核心模块为准</p> <h3 id="目录的加载规则"><a href="#目录的加载规则" class="header-anchor">#</a> 目录的加载规则</h3> <p>通常，我们会把相关的文件会放在一个目录里面，便于组织。这时，最好为该目录设置一个入口文件，让 <code>require</code> 方法可以通过这个入口文件，加载整个目录。</p> <p>在目录中放置一个 <code>package.json</code> 文件，并且将入口文件写入 <code>main</code> 字段。下面是一个例子。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;some-library&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./lib/some-library.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>require</code> 发现参数字符串指向一个目录以后，会自动查看该目录的 <code>package.json</code> 文件，然后加载 <code>main</code> 字段指定的入口文件。如果 <code>package.json</code> 文件没有 <code>main</code> 字段，或者根本就没有 <code>package.json</code> 文件，则会加载该目录下的 <code>index.js</code> 文件或 <code>index.node</code> 文件。</p> <h3 id="模块的缓存"><a href="#模块的缓存" class="header-anchor">#</a> 模块的缓存</h3> <p>第一次加载某个模块时，Node 会缓存该模块。以后再加载该模块，就直接从缓存取出该模块的 <code>module.exports</code> 属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>message<span class="token punctuation">;</span>
<span class="token comment">// &quot;hello&quot;</span>
</code></pre></div><p>上面代码中，连续三次使用 <code>require</code> 命令，加载同一个模块。第二次加载的时候，为输出的对象添加了一个 <code>message</code> 属性。但是第三次加载的时候，这个 <code>message</code> 属性依然存在，这就证明 <code>require</code> 命令并没有重新加载模块文件，而是输出了缓存。</p> <p>如果想要多次执行某个模块，可以让该模块输出一个<strong>函数</strong>，然后每次 <code>require</code> 这个模块的时候，重新执行一下输出的函数。</p> <p>所有缓存的模块保存在 <code>require.cache</code> 之中，如果想删除模块的缓存，可以像下面这样写。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 删除指定模块的缓存</span>
<span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>moduleName<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 删除所有模块的缓存</span>
Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意，缓存是根据<strong>绝对路径</strong>识别模块的，如果同样的模块名，但是保存在不同的路径，<code>require</code> 命令还是会重新加载该模块。</p> <h3 id="模块的循环加载"><a href="#模块的循环加载" class="header-anchor">#</a> 模块的循环加载</h3> <p>如果发生模块的循环加载，即 <code>foo</code> 加载 <code>bar</code>，<code>bar</code> 又加载 <code>foo</code>，则 <code>bar</code> 将加载 <code>foo</code> 的不完整版本。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// foo.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在 foo 中，bar.done = %j'</span><span class="token punctuation">,</span> bar<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bar.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在 bar 中，foo.done = %j'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'main start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'在 main 中，foo.done=%j，bar.done=%j'</span><span class="token punctuation">,</span> foo<span class="token punctuation">.</span>done<span class="token punctuation">,</span> bar<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当 <code>main.js</code> 加载 <code>foo.js</code> 时，<code>foo.js</code> 又加载 <code>bar.js</code>。 此时，<code>bar.js</code> 会尝试去加载 <code>foo.js</code>。 为了防止无限的循环，会返回一个 <code>foo.js</code> 的 exports 对象的 未完成的副本给 <code>bar.js</code> 模块。 然后 <code>bar.js</code> 完成加载，并将 exports 对象提供给 <code>foo.js</code> 模块。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ node main.js
main start
foo start
bar start
在 bar 中，a.done <span class="token operator">=</span> <span class="token boolean">false</span>
bar 结束
在 foo 中，b.done <span class="token operator">=</span> <span class="token boolean">true</span>
foo 结束
在 main 中，a.done<span class="token operator">=</span>true，b.done<span class="token operator">=</span>true
</code></pre></div><h3 id="require-main"><a href="#require-main" class="header-anchor">#</a> require.main</h3> <p><code>require</code> 方法有一个 <code>main</code> 属性，可以用来判断模块是直接执行，还是被调用执行。</p> <p>直接执行的时候（<code>node module.js</code>），<code>require.main</code> 属性指向模块本身。</p> <div class="language-js extra-class"><pre class="language-js"><code>require<span class="token punctuation">.</span>main <span class="token operator">===</span> module<span class="token punctuation">;</span>
<span class="token comment">// true</span>
</code></pre></div><p>调用执行的时候（通过 <code>require</code> 加载该脚本执行），上面的表达式返回 <code>false</code>。</p> <hr> <p><strong>参考资料：</strong></p> <ul><li><a href="http://wiki.commonjs.org/wiki/CommonJS" target="_blank" rel="noopener noreferrer">📖 Wiki：CommonJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间:</span> <span class="time">8/7/2019, 5:59:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/node-guidebook/module/module.html">模块机制</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/node-guidebook/assets/js/app.b56de1e6.js" defer></script><script src="/node-guidebook/assets/js/2.9a9b2fe1.js" defer></script><script src="/node-guidebook/assets/js/41.c737d452.js" defer></script>
  </body>
</html>
